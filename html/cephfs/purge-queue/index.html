

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Purge Queue &mdash; Ceph Documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="客户端配置" href="../client-config-ref/" />
    <link rel="prev" title="CephFS 快照镜像" href="../cephfs-mirroring/" /> 
</head>

<body class="wy-body-for-nav">

   
  <header class="top-bar">
    <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../">Ceph 文件系统</a> &raquo;</li>
      <li>Purge Queue</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/cephfs/purge-queue.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
  </header>
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #eee" >
          

          
            <a href="../../">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph 文件系统</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#cephfs">CephFS 入门</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#id4">管理</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../createfs/"> 创建 CephFS 文件系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="../administration/"> 管理命令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../multifs/"> 创建多个文件系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="../add-remove-mds/"> 配备、增加、删除 MDS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/">术语</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#mds">MDS 守护进程的引用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#id3">故障切换的管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#standby-replay">热备（ standby-replay ）的配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#mds-join-fs">配置 MDS 与文件系统的亲和性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cache-configuration/"> MDS 缓存配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mds-config-ref/"> MDS 配置选项</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../man/8/ceph-mds/"> ceph-mds 手册页</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nfs/"> 通过 NFS 导出</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app-best-practices/"> 应用最佳实践</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fs-volumes/"> FS 卷和子卷</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quota/"> CephFS 配额管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../health-messages/"> 健康消息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrading/">升级 MDS 集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrading/#firefly-jewel">升级比 Firefly 老的文件系统，需过 Jewel 这个槛</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-top/"> CephFS Top 工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../snap-schedule/"> 定时快照</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-mirroring/"> CephFS 快照镜像</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> 清理队列</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#deletion-process">Deletion process</a></li>
<li class="toctree-l4"><a class="reference internal" href="#examining-purge-queue-perf-counters">Examining purge queue perf counters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#id5">挂载 CephFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id6">CephFS 内幕</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id7">故障排除和灾难恢复</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id9">更多细节</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring/">监控概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware-monitoring/">硬件监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jaegertracing/">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Ceph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div id="dev-warning" class="admonition note">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="padding: 5px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="purge-queue">
<h1>Purge Queue<a class="headerlink" href="#purge-queue" title="Permalink to this heading"></a></h1>
<p>MDS maintains a data structure known as <strong>Purge Queue</strong> which is responsible
for managing and executing the parallel deletion of files.
There is a purge queue for every MDS rank. Purge queues consist of purge items
which contain nominal information from the inodes such as size and the layout
(i.e. all other un-needed metadata information is discarded making it
independent of all metadata structures).</p>
<section id="deletion-process">
<h2>Deletion process<a class="headerlink" href="#deletion-process" title="Permalink to this heading"></a></h2>
<p>When a client requests deletion of a directory (say <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span></code>):</p>
<ul class="simple">
<li><p>MDS queues the files and subdirectories (purge items) from pq (purge queue)
journal in the purge queue.</p></li>
<li><p>Processes the deletion of inodes in background in small and manageable
chunks.</p></li>
<li><p>MDS instructs underlying OSDs to clean up the associated objects in data
pool.</p></li>
<li><p>Updates the journal.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the users delete the files more quickly than the
purge queue can process then the data pool usage might increase
substantially over time. In extreme scenarios, the purge queue
backlog can become so huge that it can slacken the capacity reclaim
and the linux <code class="docutils literal notranslate"><span class="pre">du</span></code> command for CephFS might report inconsistent
data compared to the CephFS Data pool.</p>
</div>
<p>There are a few tunable configs that MDS uses internally to throttle purge
queue processing:</p>
<dl class="std confval">
<dt class="sig sig-object std" id="confval-filer_max_purge_ops">
<span class="sig-name descname"><span class="pre">filer_max_purge_ops</span></span><a class="headerlink" href="#confval-filer_max_purge_ops" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>Max in-flight operations for purging a striped range (e.g., MDS
journal)</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">uint</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">10</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-mds_max_purge_files">
<span class="sig-name descname"><span class="pre">mds_max_purge_files</span></span><a class="headerlink" href="#confval-mds_max_purge_files" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>maximum number of deleted files to purge in parallel</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">uint</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">64</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-mds_max_purge_ops">
<span class="sig-name descname"><span class="pre">mds_max_purge_ops</span></span><a class="headerlink" href="#confval-mds_max_purge_ops" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>maximum number of purge operations performed in parallel</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">uint</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">8Ki</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-mds_max_purge_ops_per_pg">
<span class="sig-name descname"><span class="pre">mds_max_purge_ops_per_pg</span></span><a class="headerlink" href="#confval-mds_max_purge_ops_per_pg" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>number of parallel purge operations performed per PG</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">float</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">0.5</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<p>Generally, the defaults are adequate for most clusters. However, in
case of pretty huge clusters, if the need arises like <code class="docutils literal notranslate"><span class="pre">pq_item_in_journal</span></code>
(counter of things pending deletion) reaching gigantic figure then the configs
can be tuned to 4-5 times of the default value as a starting point and
further increments are subject to more requirements.</p>
<p>Start from the most trivial config <code class="docutils literal notranslate"><span class="pre">filer_max_purge_ops</span></code>, which should help
reclaim the space more quickly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph config set mds filer_max_purge_ops 40
</pre></div>
</div>
<p>Incrementing <code class="docutils literal notranslate"><span class="pre">filer_max_purge_ops</span></code> should just work for most
clusters but if it doesn’t then move ahead with tuning other configs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph config set mds mds_max_purge_files 256
$ ceph config set mds mds_max_purge_ops 32768
$ ceph config set mds mds_max_purge_ops_per_pg 2
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Setting these values won’t immediately break anything except
inasmuch as they control how many delete ops we issue to the
underlying RADOS cluster, but might eat up some cluster performance
if the values set are staggeringly high.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The purge queue is not an auto-tuning system in terms of its work
limits as compared to what is going on. So it is advised to make
a conscious decision while tuning the configs based on the cluster
size and workload.</p>
</div>
</section>
<section id="examining-purge-queue-perf-counters">
<h2>Examining purge queue perf counters<a class="headerlink" href="#examining-purge-queue-perf-counters" title="Permalink to this heading"></a></h2>
<p>When analysing MDS perf dumps, the purge queue statistics look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;purge_queue&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;pq_executing_ops&quot;</span><span class="p">:</span> <span class="mi">56655</span><span class="p">,</span>
    <span class="s2">&quot;pq_executing_ops_high_water&quot;</span><span class="p">:</span> <span class="mi">65350</span><span class="p">,</span>
    <span class="s2">&quot;pq_executing&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;pq_executing_high_water&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;pq_executed&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
    <span class="s2">&quot;pq_item_in_journal&quot;</span><span class="p">:</span> <span class="mi">6567004</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let us understand what each of these means:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>pq_executing_ops</p></td>
<td><p>Purge queue operations in flight</p></td>
</tr>
<tr class="row-odd"><td><p>pq_executing_ops_high_water</p></td>
<td><p>Maximum number of executing purge operations recorded</p></td>
</tr>
<tr class="row-even"><td><p>pq_executing</p></td>
<td><p>Purge queue files being deleted</p></td>
</tr>
<tr class="row-odd"><td><p>pq_executing_high_water</p></td>
<td><p>Maximum number of executing file purges</p></td>
</tr>
<tr class="row-even"><td><p>pq_executed</p></td>
<td><p>Purge queue files deleted</p></td>
</tr>
<tr class="row-odd"><td><p>pq_item_in_journal</p></td>
<td><p>Purge items (files) left in journal</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">pq_executing</span></code> and <code class="docutils literal notranslate"><span class="pre">pq_executing_ops</span></code> might look similar but
there is a small nuance. <code class="docutils literal notranslate"><span class="pre">pq_executing</span></code> tracks number of files
in the purge queue while <code class="docutils literal notranslate"><span class="pre">pq_executing_ops</span></code> is the count of RADOS
objects from all the files in purge queue.</p>
</div>
</section>
</section>



<div id="support-the-ceph-foundation" class="admonition note">
  <p class="first admonition-title">Brought to you by the Ceph Foundation</p>
  <p class="last">The Ceph Documentation is a community resource funded and hosted by the non-profit <a href="https://ceph.io/en/foundation/">Ceph Foundation</a>. If you would like to support this and our other efforts, please consider <a href="https://ceph.io/en/foundation/join/">joining now</a>.</p>
</div>


           </div>
           
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../cephfs-mirroring/" class="btn btn-neutral float-left" title="CephFS 快照镜像" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../client-config-ref/" class="btn btn-neutral float-right" title="客户端配置" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).</p>
  </div>

   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>