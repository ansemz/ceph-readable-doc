
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Configuring multiple active MDS daemons &mdash; Ceph Documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Ceph Documentation" href="../../" />
    <link rel="up" title="Ceph Filesystem" href="../" />
    <link rel="next" title="Capabilities in CephFS" href="../capabilities/" />
    <link rel="prev" title="Configuring Directory fragmentation" href="../dirfrags/" />
    <script type="text/javascript" src="http://ayni.ceph.com/public/js/ceph.js"></script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../capabilities/" title="Capabilities in CephFS"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../dirfrags/" title="Configuring Directory fragmentation"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li>
          <li><a href="../" accesskey="U">Ceph Filesystem</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="configuring-multiple-active-mds-daemons">
<h1>Configuring multiple active MDS daemons<a class="headerlink" href="#configuring-multiple-active-mds-daemons" title="Permalink to this headline">¶</a></h1>
<p><em>Also known as: multi-mds, active-active MDS</em></p>
<p>Each CephFS filesystem is configured for a single active MDS daemon
by default.  To scale metadata performance for large scale systems, you
may enable multiple active MDS daemons, which will share the metadata
workload with one another.</p>
<div class="section" id="when-should-i-use-multiple-active-mds-daemons">
<h2>When should I use multiple active MDS daemons?<a class="headerlink" href="#when-should-i-use-multiple-active-mds-daemons" title="Permalink to this headline">¶</a></h2>
<p>You should configure multiple active MDS daemons when your metadata performance
is bottlenecked on the single MDS that runs by default.</p>
<p>Adding more daemons may not increase performance on all workloads.  Typically,
a single application running on a single client will not benefit from an
increased number of MDS daemons unless the application is doing a lot of
metadata operations in parallel.</p>
<p>Workloads that typically benefit from a larger number of active MDS daemons
are those with many clients, perhaps working on many separate directories.</p>
</div>
<div class="section" id="increasing-the-mds-active-cluster-size">
<h2>Increasing the MDS active cluster size<a class="headerlink" href="#increasing-the-mds-active-cluster-size" title="Permalink to this headline">¶</a></h2>
<p>Each CephFS filesystem has a <em>max_mds</em> setting, which controls
how many ranks will be created.  The actual number of ranks
in the filesystem will only be increased if a spare daemon is
available to take on the new rank. For example, if there is only one MDS daemon running, and max_mds is set to two, no second rank will be created.</p>
<p>Set <tt class="docutils literal"><span class="pre">max_mds</span></tt> to the desired number of ranks.  In the following examples
the &#8220;fsmap&#8221; line of &#8220;ceph status&#8221; is shown to illustrate the expected
result of commands.</p>
<div class="highlight-python"><pre># fsmap e5: 1/1/1 up {0=a=up:active}, 2 up:standby

ceph fs set max_mds 2

# fsmap e8: 2/2/2 up {0=a=up:active,1=c=up:creating}, 1 up:standby
# fsmap e9: 2/2/2 up {0=a=up:active,1=c=up:active}, 1 up:standby</pre>
</div>
<p>The newly created rank (1) will pass through the &#8216;creating&#8217; state
and then enter this &#8216;active state&#8217;.</p>
</div>
<div class="section" id="standby-daemons">
<h2>Standby daemons<a class="headerlink" href="#standby-daemons" title="Permalink to this headline">¶</a></h2>
<p>Even with multiple active MDS daemons, a highly available system <strong>still
requires standby daemons</strong> to take over if any of the servers running
an active daemon fail.</p>
<p>Consequently, the practical maximum of <tt class="docutils literal"><span class="pre">max_mds</span></tt> for highly available systems
is one less than the total number of MDS servers in your system.</p>
<p>To remain available in the event of multiple server failures, increase the
number of standby daemons in the system to match the number of server failures
you wish to withstand.</p>
</div>
<div class="section" id="decreasing-the-number-of-ranks">
<h2>Decreasing the number of ranks<a class="headerlink" href="#decreasing-the-number-of-ranks" title="Permalink to this headline">¶</a></h2>
<p>All ranks, including the rank(s) to be removed must first be active.  This
means that you must have at least max_mds MDS daemons available.</p>
<p>First, set max_mds to a lower number, for example we might go back to
having just a single active MDS:</p>
<div class="highlight-python"><pre># fsmap e9: 2/2/2 up {0=a=up:active,1=c=up:active}, 1 up:standby
ceph fs set max_mds 1
# fsmap e10: 2/2/1 up {0=a=up:active,1=c=up:active}, 1 up:standby</pre>
</div>
<p>Note that we still have two active MDSs: the ranks still exist even though
we have decreased max_mds, because max_mds only restricts creation
of new ranks.</p>
<p>Next, use the <tt class="docutils literal"><span class="pre">ceph</span> <span class="pre">mds</span> <span class="pre">deactivate</span> <span class="pre">&lt;rank&gt;</span></tt> command to remove the
unneeded rank:</p>
<div class="highlight-python"><pre>ceph mds deactivate cephfs_a:1
telling mds.1:1 172.21.9.34:6806/837679928 to deactivate

# fsmap e11: 2/2/1 up {0=a=up:active,1=c=up:stopping}, 1 up:standby
# fsmap e12: 1/1/1 up {0=a=up:active}, 1 up:standby
# fsmap e13: 1/1/1 up {0=a=up:active}, 2 up:standby</pre>
</div>
<p>The deactivated rank will first enter the stopping state for a period
of time while it hands off its share of the metadata to the remaining
active daemons.  This phase can take from seconds to minutes.  If the
MDS appears to be stuck in the stopping state then that should be investigated
as a possible bug.</p>
<p>If an MDS daemon crashes or is killed while in the &#8216;stopping&#8217; state, a
standby will take over and the rank will go back to &#8216;active&#8217;.  You can
try to deactivate it again once it has come back up.</p>
<p>When a daemon finishes stopping, it will respawn itself and go
back to being a standby.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/">Installation (Quick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installation (Manual)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph Filesystem</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../#using-cephfs">Using CephFS</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../rados/deployment/ceph-deploy-mds/">Add/Remove MDS(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/">Terminology</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#referring-to-mds-daemons">Referring to MDS daemons</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#managing-failover">Managing failover</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#configuring-standby-daemons">Configuring standby daemons</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#examples">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mds-config-ref/">MDS Configuration Settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../client-config-ref/">Client Configuration Settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../journaler/">Journaler Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../man/8/ceph-mds/">Manpage ceph-mds</a></li>
<li class="toctree-l3"><a class="reference internal" href="../createfs/">Create CephFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../kernel/">Mount CephFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fuse/">Mount CephFS as FUSE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fstab/">Mount CephFS in fstab</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../man/8/ceph-fuse/">Manpage ceph-fuse</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../man/8/mount.ceph/">Manpage mount.ceph</a></li>
<li class="toctree-l3"><a class="reference internal" href="../best-practices/">Deployment best practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../administration/">Administrative commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../posix/">POSIX compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="../experimental-features/">Experimental Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../experimental-features/#previously-experimental-features">Previously experimental features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quota/">CephFS Quotas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hadoop/">Using Ceph with Hadoop</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-journal-tool/">cephfs-journal-tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../file-layouts/">File layouts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../eviction/">Client eviction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../full/">Handling full filesystems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../health-messages/">Health messages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../disaster-recovery/">Disaster recovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="../client-auth/">Client authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrading/">Upgrading old filesystems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dirfrags/">Configuring directory fragmentation</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Configuring multiple active MDS daemons</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#when-should-i-use-multiple-active-mds-daemons">When should I use multiple active MDS daemons?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#increasing-the-mds-active-cluster-size">Increasing the MDS active cluster size</a></li>
<li class="toctree-l4"><a class="reference internal" href="#standby-daemons">Standby daemons</a></li>
<li class="toctree-l4"><a class="reference internal" href="#decreasing-the-number-of-ranks">Decreasing the number of ranks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#for-developers">For developers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../capabilities/" title="Capabilities in CephFS"
             >next</a> |</li>
        <li class="right" >
          <a href="../dirfrags/" title="Configuring Directory fragmentation"
             >previous</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li>
          <li><a href="../" >Ceph Filesystem</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Red Hat, Inc, and contributors. Licensed under Creative Commons BY-SA.
    </div>
  </body>
</html>