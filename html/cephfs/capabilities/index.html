
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Capabilities in CephFS &mdash; Ceph Documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Ceph Documentation" href="../../" />
    <link rel="up" title="Ceph Filesystem" href="../" />
    <link rel="next" title="Libcephfs (JavaDoc)" href="../../api/libcephfs-java/" />
    <link rel="prev" title="Configuring multiple active MDS daemons" href="../multimds/" />
    <script type="text/javascript" src="http://ayni.ceph.com/public/js/ceph.js"></script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../api/libcephfs-java/" title="Libcephfs (JavaDoc)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../multimds/" title="Configuring multiple active MDS daemons"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li>
          <li><a href="../" accesskey="U">Ceph Filesystem</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="capabilities-in-cephfs">
<h1>Capabilities in CephFS<a class="headerlink" href="#capabilities-in-cephfs" title="Permalink to this headline">¶</a></h1>
<p>When a client wants to operate on an inode, it will query the MDS in various
ways, which will then grant the client a set of <strong>capabilities</strong>. These
grant the client permissions to operate on the inode in various ways. One
of the major differences from other network filesystems (e.g NFS or SMB) is
that the capabilities granted are quite granular, and it&#8217;s possible that
multiple clients can hold different capabilities on the same inodes.</p>
<div class="section" id="types-of-capabilities">
<h2>Types of Capabilities<a class="headerlink" href="#types-of-capabilities" title="Permalink to this headline">¶</a></h2>
<p>There are several &#8220;generic&#8221; capability bits. These denote what sort of ability
the capability grants.</p>
<div class="highlight-python"><pre>/* generic cap bits */
#define CEPH_CAP_GSHARED     1  /* client can reads (s) */
#define CEPH_CAP_GEXCL       2  /* client can read and update (x) */
#define CEPH_CAP_GCACHE      4  /* (file) client can cache reads (c) */
#define CEPH_CAP_GRD         8  /* (file) client can read (r) */
#define CEPH_CAP_GWR        16  /* (file) client can write (w) */
#define CEPH_CAP_GBUFFER    32  /* (file) client can buffer writes (b) */
#define CEPH_CAP_GWREXTEND  64  /* (file) client can extend EOF (a) */
#define CEPH_CAP_GLAZYIO   128  /* (file) client can perform lazy io (l) */</pre>
</div>
<p>These are then shifted by a particular number of bits. These denote a part of
the inode&#8217;s data or metadata on which the capability is being granted:</p>
<div class="highlight-python"><pre>/* per-lock shift */
#define CEPH_CAP_SAUTH      2 /* A */
#define CEPH_CAP_SLINK      4 /* L */
#define CEPH_CAP_SXATTR     6 /* X */
#define CEPH_CAP_SFILE      8 /* F */</pre>
</div>
<p>Only certain generic cap types are ever granted for some of those &#8220;shifts&#8221;,
however. In particular, only the FILE shift ever has more than the first two
bits.</p>
<div class="highlight-python"><pre>| AUTH | LINK | XATTR | FILE
2      4      6       8</pre>
</div>
<p>From the above, we get a number of constants, that are generated by taking
each bit value and shifting to the correct bit in the word:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1">#define CEPH_CAP_AUTH_SHARED  (CEPH_CAP_GSHARED  &lt;&lt; CEPH_CAP_SAUTH)</span>
</pre></div>
</div>
<p>These bits can then be or&#8217;ed together to make a bitmask denoting a set of
capabilities.</p>
<p>There is one exception:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1">#define CEPH_CAP_PIN  1  /* no specific capabilities beyond the pin */</span>
</pre></div>
</div>
<p>The &#8220;pin&#8221; just pins the inode into memory, without granting any other caps.</p>
<p>Graphically:</p>
<div class="highlight-python"><pre>+---+---+---+---+---+---+---+---+
| p | _ |As   x |Ls   x |Xs   x |
+---+---+---+---+---+---+---+---+
|Fs   x   c   r   w   b   a   l |
+---+---+---+---+---+---+---+---+</pre>
</div>
<p>The second bit is currently unused.</p>
</div>
<div class="section" id="abilities-granted-by-each-cap">
<h2>Abilities granted by each cap:<a class="headerlink" href="#abilities-granted-by-each-cap" title="Permalink to this headline">¶</a></h2>
<p>While that is how capabilities are granted (and communicated), the important
bit is what they actually allow the client to do:</p>
<ul class="simple">
<li>PIN: this just pins the inode into memory. This is sufficient to allow the
client to get to the inode number, as well as other immutable things like
major or minor numbers in a device inode, or symlink contents.</li>
<li>AUTH: this grants the ability to get to the authentication-related metadata.
In particular, the owner, group and mode. Note that doing a full permission
check may require getting at ACLs as well, which are stored in xattrs.</li>
<li>LINK: the link count of the inode</li>
<li>XATTR: ability to access or manipulate xattrs. Note that since ACLs are
stored in xattrs, it&#8217;s also sometimes necessary to access them when checking
permissions.</li>
<li>FILE: this is the big one. These allow the client to access and manipulate
file data. It also covers certain metadata relating to file data &#8211; the
size, mtime, atime and ctime, in particular.</li>
</ul>
</div>
<div class="section" id="shorthand">
<h2>Shorthand:<a class="headerlink" href="#shorthand" title="Permalink to this headline">¶</a></h2>
<p>Note that the client logging can also present a compact representation of the
capabilities. For example:</p>
<dl class="docutils">
<dt>::</dt>
<dd>pAsLsXsFs</dd>
</dl>
<p>The &#8216;p&#8217; represents the pin. Each capital letter corresponds to the shift
values, and the lowercase letters after each shift are for the actual
capabilities granted in each shift.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/">Installation (Quick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installation (Manual)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph Filesystem</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#using-cephfs">Using CephFS</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#for-developers">For developers</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="">Client&#8217;s Capabilities</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#types-of-capabilities">Types of Capabilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#abilities-granted-by-each-cap">Abilities granted by each cap:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shorthand">Shorthand:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/libcephfs-java/">libcephfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mantle/">Mantle</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../api/libcephfs-java/" title="Libcephfs (JavaDoc)"
             >next</a> |</li>
        <li class="right" >
          <a href="../multimds/" title="Configuring multiple active MDS daemons"
             >previous</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li>
          <li><a href="../" >Ceph Filesystem</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Red Hat, Inc, and contributors. Licensed under Creative Commons BY-SA.
    </div>
  </body>
</html>