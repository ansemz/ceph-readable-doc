

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>CephFS 快照镜像 &mdash; Ceph Documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="客户端配置" href="../client-config-ref/" />
    <link rel="prev" title="Snapshot Scheduling Module" href="../snap-schedule/" /> 
</head>

<body class="wy-body-for-nav">

   
  <header class="top-bar">
    <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../">Ceph 文件系统</a> &raquo;</li>
      <li>CephFS 快照镜像</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/cephfs/cephfs-mirroring.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
  </header>
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #eee" >
          

          
            <a href="../../">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph 文件系统</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#cephfs">CephFS 入门</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#id4">管理</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../createfs/"> 创建 CephFS 文件系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="../administration/"> 管理命令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../multifs/"> 创建多个文件系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="../add-remove-mds/"> 配备、增加、删除 MDS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/">术语</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#mds">MDS 守护进程的引用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#id3">故障切换的管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#mds-standby-replay">热备的配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#mds-join-fs">配置 MDS 与文件系统的亲和性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cache-configuration/"> MDS 缓存配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mds-config-ref/"> MDS 配置选项</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../man/8/ceph-mds/"> ceph-mds 手册页</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nfs/"> 通过 NFS 导出</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app-best-practices/"> 应用最佳实践</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fs-volumes/"> FS 卷和子卷</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quota/"> CephFS 配额管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../health-messages/"> 健康消息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrading/">升级 MDS 集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrading/#firefly-jewel">升级比 Firefly 老的文件系统，需过 Jewel 这个槛</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-top/"> CephFS Top 工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../snap-schedule/"> 定时快照</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> CephFS 快照镜像</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-users">Creating Users</a></li>
<li class="toctree-l4"><a class="reference internal" href="#starting-mirror-daemon">Starting Mirror Daemon</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interface">Interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mirroring-module">Mirroring Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bootstrap-peers">Bootstrap Peers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#snapshot-mirroring">Snapshot Mirroring</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mirroring-status">Mirroring Status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metrics">Metrics</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-options">Configuration Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#re-adding-peers">Re-adding Peers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#id5">挂载 CephFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id6">CephFS 内幕</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id7">故障排除和灾难恢复</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id9">更多细节</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring/">监控概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware-monitoring/">Hardware monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jaegertracing/">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Ceph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div id="dev-warning" class="admonition note">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="padding: 5px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="cephfs">
<span id="cephfs-mirroring"></span><h1>CephFS 快照镜像<a class="headerlink" href="#cephfs" title="Permalink to this heading"></a></h1>
<p>CephFS supports asynchronous replication of snapshots to a remote CephFS file system via
the <cite>cephfs-mirror</cite> tool. Snapshots are synchronized by mirroring snapshot data followed by
creating a remote snapshot with the same name (for a given directory on the remote file system) as
the source snapshot.</p>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this heading"></a></h2>
<p>The primary (local) and secondary (remote) Ceph clusters version should be Pacific or later.</p>
</section>
<section id="creating-users">
<span id="cephfs-mirroring-creating-users"></span><h2>Creating Users<a class="headerlink" href="#creating-users" title="Permalink to this heading"></a></h2>
<p>Start by creating a Ceph user (on the primary/local cluster) for the <cite>cephfs-mirror</cite> daemon. This user
requires write capability on the metadata pool to create RADOS objects (index objects)
for watch/notify operation and read capability on the data pool(s):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph auth get-or-create client.mirror mon &#39;profile cephfs-mirror&#39; mds &#39;allow r&#39; osd &#39;allow rw tag cephfs metadata=*, allow r tag cephfs data=*&#39; mgr &#39;allow r&#39;
</pre></div>
</div>
<p>Create a Ceph user for each file system peer (on the secondary/remote cluster). This user needs
to have full capabilities on the MDS (to take snapshots) and the OSDs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs authorize &lt;fs_name&gt; client.mirror_remote / rwps
</pre></div>
</div>
<p>This user will be supplied as part of the peer specification when adding a peer.</p>
</section>
<section id="starting-mirror-daemon">
<h2>Starting Mirror Daemon<a class="headerlink" href="#starting-mirror-daemon" title="Permalink to this heading"></a></h2>
<p>The mirror daemon should be spawned using <cite>systemctl(1)</cite> unit files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ systemctl enable cephfs-mirror@mirror
$ systemctl start cephfs-mirror@mirror
</pre></div>
</div>
<p><cite>cephfs-mirror</cite> daemon can be run in foreground using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cephfs-mirror --id mirror --cluster site-a -f
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The user specified here is <cite>mirror</cite>, the creation of which is
described in the <a class="reference internal" href="#cephfs-mirroring-creating-users"><span class="std std-ref">Creating Users</span></a>
section.</p>
</div>
<p>Multiple <code class="docutils literal notranslate"><span class="pre">cephfs-mirror</span></code> daemons may be deployed for concurrent
synchronization and high availability. Mirror daemons share the synchronization
load using a simple <code class="docutils literal notranslate"><span class="pre">M/N</span></code> policy, where <code class="docutils literal notranslate"><span class="pre">M</span></code> is the number of directories
and <code class="docutils literal notranslate"><span class="pre">N</span></code> is the number of <code class="docutils literal notranslate"><span class="pre">cephfs-mirror</span></code> daemons.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">cephadm</span></code> is used to manage a Ceph cluster, <code class="docutils literal notranslate"><span class="pre">cephfs-mirror</span></code> daemons can be
deployed by running the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>cephfs-mirror</span>
</pre></div></div><p>To deploy multiple mirror daemons, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>cephfs-mirror<span class="w"> </span>--placement<span class="o">=</span>&lt;placement-spec&gt;</span>
</pre></div></div><p>For example, to deploy 3 <cite>cephfs-mirror</cite> daemons on different hosts, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">$<span class="w"> </span>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>cephfs-mirror<span class="w"> </span>--placement<span class="o">=</span><span class="s2">&quot;3 host1,host2,host3&quot;</span></span>
</pre></div></div></section>
<section id="interface">
<h2>Interface<a class="headerlink" href="#interface" title="Permalink to this heading"></a></h2>
<p>The <cite>Mirroring</cite> module (manager plugin) provides interfaces for managing
directory snapshot mirroring. These are (mostly) wrappers around monitor
commands for managing file system mirroring and is the recommended control
interface.</p>
</section>
<section id="mirroring-module">
<h2>Mirroring Module<a class="headerlink" href="#mirroring-module" title="Permalink to this heading"></a></h2>
<p>The mirroring module is responsible for assigning directories to mirror daemons
for synchronization. Multiple mirror daemons can be spawned to achieve
concurrency in directory snapshot synchronization. When mirror daemons are
spawned (or terminated), the mirroring module discovers the modified set of
mirror daemons and rebalances directory assignments across the new set, thus
providing high-availability.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Deploying a single mirror daemon is recommended. Running multiple
daemons is untested.</p>
</div>
<p>The following file types are supported by the mirroring:</p>
<ul class="simple">
<li><p>Regular files (-)</p></li>
<li><p>Directory files (d)</p></li>
<li><p>Symbolic link file (l)</p></li>
</ul>
<p>The other file types are ignored by the mirroring. So they won’t be
available on a successfully synchronized peer.</p>
<p>The mirroring module is disabled by default. To enable the mirroring module,
run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>mgr<span class="w"> </span>module<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>mirroring</span>
</pre></div></div><p>The mirroring module provides a family of commands that can be used to control
the mirroring of directory snapshots. To add or remove directories, mirroring
must be enabled for a given file system. To enable mirroring for a given file
system, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>snapshot<span class="w"> </span>mirror<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>&lt;fs_name&gt;</span>
</pre></div></div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>“Mirroring module” commands are prefixed with <code class="docutils literal notranslate"><span class="pre">fs</span> <span class="pre">snapshot</span> <span class="pre">mirror</span></code>.
This distinguishes them from “monitor commands”, which are prefixed with <code class="docutils literal notranslate"><span class="pre">fs</span>
<span class="pre">mirror</span></code>. Enabling mirroring by using monitor commands will result in the mirror daemon
entering the “failed” state due to the absence of the <cite>cephfs_mirror</cite> index object.
So be sure (in this context) to use module commands.</p>
</div>
<p>To disable mirroring for a given file system, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>snapshot<span class="w"> </span>mirror<span class="w"> </span>disable<span class="w"> </span>&lt;fs_name&gt;</span>
</pre></div></div><p>After mirroring is enabled, add a peer to which directory snapshots are to be
mirrored. Peers are specified by the <code class="docutils literal notranslate"><span class="pre">&lt;client&gt;&#64;&lt;cluster&gt;</span></code> format, which is
referred to elsewhere in this document as the <code class="docutils literal notranslate"><span class="pre">remote_cluster_spec</span></code>. Peers
are assigned a unique-id (UUID) when added. See the <a class="reference internal" href="#cephfs-mirroring-creating-users"><span class="std std-ref">Creating
Users</span></a> section for instructions that describe
how to create Ceph users for mirroring.</p>
<p>To add a peer, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>snapshot<span class="w"> </span>mirror<span class="w"> </span>peer_add<span class="w"> </span>&lt;fs_name&gt;<span class="w"> </span>&lt;remote_cluster_spec&gt;<span class="w"> </span><span class="o">[</span>&lt;remote_fs_name&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>&lt;remote_mon_host&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>&lt;cephx_key&gt;<span class="o">]</span></span>
</pre></div></div><p><code class="docutils literal notranslate"><span class="pre">&lt;remote_cluster_spec&gt;</span></code> is of the format <code class="docutils literal notranslate"><span class="pre">client.&lt;id&gt;&#64;&lt;cluster_name&gt;</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">&lt;remote_fs_name&gt;</span></code> is optional, and defaults to <cite>&lt;fs_name&gt;</cite> (on the remote
cluster).</p>
<p>For this command to succeed, the remote cluster’s Ceph configuration and user
keyring must be available in the primary cluster. For example, if a user named
<code class="docutils literal notranslate"><span class="pre">client_mirror</span></code> is created on the remote cluster which has <code class="docutils literal notranslate"><span class="pre">rwps</span></code>
permissions for the remote file system named <code class="docutils literal notranslate"><span class="pre">remote_fs</span></code> (see <cite>Creating
Users</cite>) and the remote cluster is named <code class="docutils literal notranslate"><span class="pre">remote_ceph</span></code> (that is, the remote
cluster configuration file is named <code class="docutils literal notranslate"><span class="pre">remote_ceph.conf</span></code> on the primary
cluster), run the following command to add the remote filesystem as a peer to
the primary filesystem <code class="docutils literal notranslate"><span class="pre">primary_fs</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>snapshot<span class="w"> </span>mirror<span class="w"> </span>peer_add<span class="w"> </span>primary_fs<span class="w"> </span>client.mirror_remote@remote_ceph<span class="w"> </span>remote_fs</span>
</pre></div></div><p>To avoid having to maintain the remote cluster configuration file and remote
ceph user keyring in the primary cluster, users can bootstrap a peer (which
stores the relevant remote cluster details in the monitor config store on the
primary cluster). See the <a class="reference internal" href="#cephfs-mirroring-bootstrap-peers"><span class="std std-ref">Bootstrap
Peers</span></a> section.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">peer_add</span></code> command supports passing the remote cluster monitor address
and the user key. However, bootstrapping a peer is the recommended way to add a
peer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only a single peer is currently supported.</p>
</div>
<p>To remove a peer, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>snapshot<span class="w"> </span>mirror<span class="w"> </span>peer_remove<span class="w"> </span>&lt;fs_name&gt;<span class="w"> </span>&lt;peer_uuid&gt;</span>
</pre></div></div><p>To list file system mirror peers, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>snapshot<span class="w"> </span>mirror<span class="w"> </span>peer_list<span class="w"> </span>&lt;fs_name&gt;</span>
</pre></div></div><p>To configure a directory for mirroring, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>snapshot<span class="w"> </span>mirror<span class="w"> </span>add<span class="w"> </span>&lt;fs_name&gt;<span class="w"> </span>&lt;path&gt;</span>
</pre></div></div><p>To list the configured directories, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>snapshot<span class="w"> </span>mirror<span class="w"> </span>ls<span class="w"> </span>&lt;fs_name&gt;</span>
</pre></div></div><p>To stop mirroring directory snapshots, run a command of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>snapshot<span class="w"> </span>mirror<span class="w"> </span>remove<span class="w"> </span>&lt;fs_name&gt;<span class="w"> </span>&lt;path&gt;</span>
</pre></div></div><p>Only absolute directory paths are allowed.</p>
<p>Paths are normalized by the mirroring module. This means that <code class="docutils literal notranslate"><span class="pre">/a/b/../b</span></code> is
equivalent to <code class="docutils literal notranslate"><span class="pre">/a/b</span></code>. Paths always start from the CephFS file-system root and
not from the host system mount point.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir -p /d0/d1/d2
$ ceph fs snapshot mirror add cephfs /d0/d1/d2
{}
$ ceph fs snapshot mirror add cephfs /d0/d1/../d1/d2
Error EEXIST: directory /d0/d1/d2 is already tracked
</pre></div>
</div>
<p>After a directory is added for mirroring, the additional mirroring of
subdirectories or ancestor directories is disallowed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs snapshot mirror add cephfs /d0/d1
Error EINVAL: /d0/d1 is a ancestor of tracked path /d0/d1/d2
$ ceph fs snapshot mirror add cephfs /d0/d1/d2/d3
Error EINVAL: /d0/d1/d2/d3 is a subtree of tracked path /d0/d1/d2
</pre></div>
</div>
<p>The <a class="reference internal" href="#cephfs-mirroring-mirroring-status"><span class="std std-ref">Mirroring Status</span></a> section contains
information about the commands for checking the directory mapping (to mirror
daemons) and for checking the directory distribution.</p>
</section>
<section id="bootstrap-peers">
<span id="cephfs-mirroring-bootstrap-peers"></span><h2>Bootstrap Peers<a class="headerlink" href="#bootstrap-peers" title="Permalink to this heading"></a></h2>
<p>Adding a peer (via <cite>peer_add</cite>) requires the peer cluster configuration and user keyring
to be available in the primary cluster (manager host and hosts running the mirror daemon).
This can be avoided by bootstrapping and importing a peer token. Peer bootstrap involves
creating a bootstrap token on the peer cluster via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs snapshot mirror peer_bootstrap create &lt;fs_name&gt; &lt;client_entity&gt; &lt;site-name&gt;
</pre></div>
</div>
<p>e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs snapshot mirror peer_bootstrap create backup_fs client.mirror_remote site-remote
{&quot;token&quot;: &quot;eyJmc2lkIjogIjBkZjE3MjE3LWRmY2QtNDAzMC05MDc5LTM2Nzk4NTVkNDJlZiIsICJmaWxlc3lzdGVtIjogImJhY2t1cF9mcyIsICJ1c2VyIjogImNsaWVudC5taXJyb3JfcGVlcl9ib290c3RyYXAiLCAic2l0ZV9uYW1lIjogInNpdGUtcmVtb3RlIiwgImtleSI6ICJBUUFhcDBCZ0xtRmpOeEFBVnNyZXozai9YYUV0T2UrbUJEZlJDZz09IiwgIm1vbl9ob3N0IjogIlt2MjoxOTIuMTY4LjAuNTo0MDkxOCx2MToxOTIuMTY4LjAuNTo0MDkxOV0ifQ==&quot;}
</pre></div>
</div>
<p><cite>site-name</cite> refers to a user-defined string to identify the remote filesystem. In context
of <cite>peer_add</cite> interface, <cite>site-name</cite> is the passed in <cite>cluster</cite> name from <cite>remote_cluster_spec</cite>.</p>
<p>Import the bootstrap token in the primary cluster via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs snapshot mirror peer_bootstrap import &lt;fs_name&gt; &lt;token&gt;
</pre></div>
</div>
<p>e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs snapshot mirror peer_bootstrap import cephfs eyJmc2lkIjogIjBkZjE3MjE3LWRmY2QtNDAzMC05MDc5LTM2Nzk4NTVkNDJlZiIsICJmaWxlc3lzdGVtIjogImJhY2t1cF9mcyIsICJ1c2VyIjogImNsaWVudC5taXJyb3JfcGVlcl9ib290c3RyYXAiLCAic2l0ZV9uYW1lIjogInNpdGUtcmVtb3RlIiwgImtleSI6ICJBUUFhcDBCZ0xtRmpOeEFBVnNyZXozai9YYUV0T2UrbUJEZlJDZz09IiwgIm1vbl9ob3N0IjogIlt2MjoxOTIuMTY4LjAuNTo0MDkxOCx2MToxOTIuMTY4LjAuNTo0MDkxOV0ifQ==
</pre></div>
</div>
</section>
<section id="snapshot-mirroring">
<span id="cephfs-mirroring-mirroring-status"></span><h2>Snapshot Mirroring<a class="headerlink" href="#snapshot-mirroring" title="Permalink to this heading"></a></h2>
<p>To initiate snapshot mirroring, create a snapshot of the configured directory in the primary cluster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir -p /d0/d1/d2/.snap/snap1
</pre></div>
</div>
</section>
<section id="mirroring-status">
<h2>Mirroring Status<a class="headerlink" href="#mirroring-status" title="Permalink to this heading"></a></h2>
<p>CephFS mirroring module provides <cite>mirror daemon status</cite> interface to check mirror daemon status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs snapshot mirror daemon status
[
  {
    &quot;daemon_id&quot;: 284167,
    &quot;filesystems&quot;: [
      {
        &quot;filesystem_id&quot;: 1,
        &quot;name&quot;: &quot;a&quot;,
        &quot;directory_count&quot;: 1,
        &quot;peers&quot;: [
          {
            &quot;uuid&quot;: &quot;02117353-8cd1-44db-976b-eb20609aa160&quot;,
            &quot;remote&quot;: {
              &quot;client_name&quot;: &quot;client.mirror_remote&quot;,
              &quot;cluster_name&quot;: &quot;ceph&quot;,
              &quot;fs_name&quot;: &quot;backup_fs&quot;
            },
            &quot;stats&quot;: {
              &quot;failure_count&quot;: 1,
              &quot;recovery_count&quot;: 0
            }
          }
        ]
      }
    ]
  }
]
</pre></div>
</div>
<p>An entry per mirror daemon instance is displayed along with information such as configured
peers and basic stats. For more detailed stats, use the admin socket interface as detailed
below.</p>
<p>CephFS mirror daemons provide admin socket commands for querying mirror status. To check
available commands for mirror status use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph --admin-daemon /path/to/mirror/daemon/admin/socket help
{
    ....
    ....
    &quot;fs mirror status cephfs@360&quot;: &quot;get filesystem mirror status&quot;,
    ....
    ....
}
</pre></div>
</div>
<p>Commands prefixed with`fs mirror status` provide mirror status for mirror enabled
file systems. Note that <cite>cephfs&#64;360</cite> is of format <cite>filesystem-name&#64;filesystem-id</cite>.
This format is required since mirror daemons get asynchronously notified regarding
file system mirror status (A file system can be deleted and recreated with the same
name).</p>
<p>This command currently provides minimal information regarding mirror status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph --admin-daemon /var/run/ceph/cephfs-mirror.asok fs mirror status cephfs@360
{
  &quot;rados_inst&quot;: &quot;192.168.0.5:0/1476644347&quot;,
  &quot;peers&quot;: {
      &quot;a2dc7784-e7a1-4723-b103-03ee8d8768f8&quot;: {
          &quot;remote&quot;: {
              &quot;client_name&quot;: &quot;client.mirror_remote&quot;,
              &quot;cluster_name&quot;: &quot;site-a&quot;,
              &quot;fs_name&quot;: &quot;backup_fs&quot;
          }
      }
  },
  &quot;snap_dirs&quot;: {
      &quot;dir_count&quot;: 1
  }
}
</pre></div>
</div>
<p>The <cite>Peers</cite> section in the command output above shows the peer information including the unique
peer-id (UUID) and specification. The peer-id is required when removing an existing peer
as mentioned in the <cite>Mirror Module and Interface</cite> section.</p>
<p>Commands prefixed with <cite>fs mirror peer status</cite> provide peer synchronization status. This
command is of format <cite>filesystem-name&#64;filesystem-id peer-uuid</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph --admin-daemon /var/run/ceph/cephfs-mirror.asok fs mirror peer status cephfs@360 a2dc7784-e7a1-4723-b103-03ee8d8768f8
{
  &quot;/d0&quot;: {
      &quot;state&quot;: &quot;idle&quot;,
      &quot;last_synced_snap&quot;: {
          &quot;id&quot;: 120,
          &quot;name&quot;: &quot;snap1&quot;,
          &quot;sync_duration&quot;: 3,
          &quot;sync_time_stamp&quot;: &quot;274900.558797s&quot;,
          &quot;sync_bytes&quot;: 52428800
      },
      &quot;snaps_synced&quot;: 2,
      &quot;snaps_deleted&quot;: 0,
      &quot;snaps_renamed&quot;: 0
  }
}
</pre></div>
</div>
<p>Synchronization stats including <cite>snaps_synced</cite>, <cite>snaps_deleted</cite> and <cite>snaps_renamed</cite> are reset
on daemon restart and/or when a directory is reassigned to another mirror daemon (when
multiple mirror daemons are deployed).</p>
<p>A directory can be in one of the following states:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- `idle`: The directory is currently not being synchronized
- `syncing`: The directory is currently being synchronized
- `failed`: The directory has hit upper limit of consecutive failures
</pre></div>
</div>
<p>When a directory is currently being synchronized, the mirror daemon marks it as <cite>syncing</cite> and
<cite>fs mirror peer status</cite> shows the snapshot being synchronized under the <cite>current_syncing_snap</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph --admin-daemon /var/run/ceph/cephfs-mirror.asok fs mirror peer status cephfs@360 a2dc7784-e7a1-4723-b103-03ee8d8768f8
{
  &quot;/d0&quot;: {
      &quot;state&quot;: &quot;syncing&quot;,
      &quot;current_syncing_snap&quot;: {
          &quot;id&quot;: 121,
          &quot;name&quot;: &quot;snap2&quot;
      },
      &quot;last_synced_snap&quot;: {
          &quot;id&quot;: 120,
          &quot;name&quot;: &quot;snap1&quot;,
          &quot;sync_duration&quot;: 3,
          &quot;sync_time_stamp&quot;: &quot;274900.558797s&quot;,
          &quot;sync_bytes&quot;: 52428800
      },
      &quot;snaps_synced&quot;: 2,
      &quot;snaps_deleted&quot;: 0,
      &quot;snaps_renamed&quot;: 0
  }
}
</pre></div>
</div>
<p>The mirror daemon marks it back to <cite>idle</cite>, when the syncing completes.</p>
<p>When a directory experiences a configured number of consecutive synchronization failures, the
mirror daemon marks it as <cite>failed</cite>. Synchronization for these directories is retried.
By default, the number of consecutive failures before a directory is marked as failed
is controlled by <cite>cephfs_mirror_max_consecutive_failures_per_directory</cite> configuration
option (default: 10) and the retry interval for failed directories is controlled via
<cite>cephfs_mirror_retry_failed_directories_interval</cite> configuration option (default: 60s).</p>
<p>E.g., adding a regular file for synchronization would result in failed status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs snapshot mirror add cephfs /f0
$ ceph --admin-daemon /var/run/ceph/cephfs-mirror.asok fs mirror peer status cephfs@360 a2dc7784-e7a1-4723-b103-03ee8d8768f8
{
  &quot;/d0&quot;: {
      &quot;state&quot;: &quot;idle&quot;,
      &quot;last_synced_snap&quot;: {
          &quot;id&quot;: 121,
          &quot;name&quot;: &quot;snap2&quot;,
          &quot;sync_duration&quot;: 5,
          &quot;sync_time_stamp&quot;: &quot;500900.600797s&quot;,
          &quot;sync_bytes&quot;: 78643200
      },
      &quot;snaps_synced&quot;: 3,
      &quot;snaps_deleted&quot;: 0,
      &quot;snaps_renamed&quot;: 0
  },
  &quot;/f0&quot;: {
      &quot;state&quot;: &quot;failed&quot;,
      &quot;snaps_synced&quot;: 0,
      &quot;snaps_deleted&quot;: 0,
      &quot;snaps_renamed&quot;: 0
  }
}
</pre></div>
</div>
<p>This allows a user to add a non-existent directory for synchronization. The mirror daemon
will mark such a directory as failed and retry (less frequently). When the directory is
created, the mirror daemon will clear the failed state upon successful synchronization.</p>
<p>Adding a new snapshot or a new directory manually in the .snap directory of the
remote filesystem will result in failed status of the corresponding configured directory.
In the remote filesystem:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs subvolume snapshot create cephfs subvol1 snap2 group1
or
$ mkdir /d0/.snap/snap2

$ ceph --admin-daemon /var/run/ceph/cephfs-mirror.asok fs mirror peer status cephfs@360 a2dc7784-e7a1-4723-b103-03ee8d8768f8
{
  &quot;/d0&quot;: {
      &quot;state&quot;: &quot;failed&quot;,
      &quot;failure_reason&quot;: &quot;snapshot &#39;snap2&#39; has invalid metadata&quot;,
      &quot;last_synced_snap&quot;: {
          &quot;id&quot;: 120,
          &quot;name&quot;: &quot;snap1&quot;,
          &quot;sync_duration&quot;: 3,
          &quot;sync_time_stamp&quot;: &quot;274900.558797s&quot;
      },
      &quot;snaps_synced&quot;: 2,
      &quot;snaps_deleted&quot;: 0,
      &quot;snaps_renamed&quot;: 0
  },
  &quot;/f0&quot;: {
      &quot;state&quot;: &quot;failed&quot;,
      &quot;snaps_synced&quot;: 0,
      &quot;snaps_deleted&quot;: 0,
      &quot;snaps_renamed&quot;: 0
  }
}
</pre></div>
</div>
<p>When the snapshot or the directory is removed from the remote filesystem, the mirror daemon will
clear the failed state upon successful synchronization of the pending snapshots, if any.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Treat the remote filesystem as read-only. Nothing is inherently enforced by CephFS.
But with the right mds caps, users would not be able to snapshot directories in the
remote file system.</p>
</div>
<p>When mirroring is disabled, the respective <cite>fs mirror status</cite> command for the file system
will not show up in command help.</p>
</section>
<section id="metrics">
<h2>Metrics<a class="headerlink" href="#metrics" title="Permalink to this heading"></a></h2>
<p>CephFS exports mirroring metrics as <a class="reference internal" href="../../dev/perf_counters/#labeled-perf-counters"><span class="std std-ref">Labeled Perf Counters</span></a> which will be consumed by the OCP/ODF Dashboard to provide monitoring of the Geo Replication. These metrics can be used to measure the progress of cephfs_mirror syncing and thus provide the monitoring capability. CephFS exports the following mirroring metrics, which are displayed using the <code class="docutils literal notranslate"><span class="pre">counter</span> <span class="pre">dump</span></code> command.</p>
<table class="colwidths-given docutils align-default" id="id1">
<caption><span class="caption-text">Mirror Status Metrics</span><a class="headerlink" href="#id1" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>mirroring_peers</p></td>
<td><p>Gauge</p></td>
<td><p>The number of peers involved in mirroring</p></td>
</tr>
<tr class="row-odd"><td><p>directory_count</p></td>
<td><p>Gauge</p></td>
<td><p>The total number of directories being synchronized</p></td>
</tr>
<tr class="row-even"><td><p>mirrored_filesystems</p></td>
<td><p>Gauge</p></td>
<td><p>The total number of filesystems which are mirrored</p></td>
</tr>
<tr class="row-odd"><td><p>mirror_enable_failures</p></td>
<td><p>Counter</p></td>
<td><p>Enable mirroring failures</p></td>
</tr>
</tbody>
</table>
<table class="colwidths-given docutils align-default" id="id2">
<caption><span class="caption-text">Replication Metrics</span><a class="headerlink" href="#id2" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>snaps_synced</p></td>
<td><p>Counter</p></td>
<td><p>The total number of snapshots successfully synchronized</p></td>
</tr>
<tr class="row-odd"><td><p>sync_bytes</p></td>
<td><p>Counter</p></td>
<td><p>The total bytes being synchronized</p></td>
</tr>
<tr class="row-even"><td><p>sync_failures</p></td>
<td><p>Counter</p></td>
<td><p>The total number of failed snapshot synchronizations</p></td>
</tr>
<tr class="row-odd"><td><p>snaps_deleted</p></td>
<td><p>Counter</p></td>
<td><p>The total number of snapshots deleted</p></td>
</tr>
<tr class="row-even"><td><p>snaps_renamed</p></td>
<td><p>Counter</p></td>
<td><p>The total number of snapshots renamed</p></td>
</tr>
<tr class="row-odd"><td><p>avg_sync_time</p></td>
<td><p>Gauge</p></td>
<td><p>The average time taken by all snapshot synchronizations</p></td>
</tr>
<tr class="row-even"><td><p>last_synced_start</p></td>
<td><p>Gauge</p></td>
<td><p>The sync start time of the last synced snapshot</p></td>
</tr>
<tr class="row-odd"><td><p>last_synced_end</p></td>
<td><p>Gauge</p></td>
<td><p>The sync end time of the last synced snapshot</p></td>
</tr>
<tr class="row-even"><td><p>last_synced_duration</p></td>
<td><p>Gauge</p></td>
<td><p>The time duration of the last synchronization</p></td>
</tr>
<tr class="row-odd"><td><p>last_synced_bytes</p></td>
<td><p>counter</p></td>
<td><p>The total bytes being synchronized for the last synced snapshot</p></td>
</tr>
</tbody>
</table>
</section>
<section id="configuration-options">
<h2>Configuration Options<a class="headerlink" href="#configuration-options" title="Permalink to this heading"></a></h2>
<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_max_concurrent_directory_syncs">
<span class="sig-name descname"><span class="pre">cephfs_mirror_max_concurrent_directory_syncs</span></span><a class="headerlink" href="#confval-cephfs_mirror_max_concurrent_directory_syncs" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>maximum number of directory snapshots that can be synchronized
concurrently by cephfs-mirror daemon. Controls the number of
synchronization threads.</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">uint</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">3</span></code></p>
</dd>
<dt class="field-odd">min</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_action_update_interval">
<span class="sig-name descname"><span class="pre">cephfs_mirror_action_update_interval</span></span><a class="headerlink" href="#confval-cephfs_mirror_action_update_interval" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>处理未完成镜像更新操作的时间间隔，单位为秒。</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">secs</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">2</span></code></p>
</dd>
<dt class="field-odd">min</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_restart_mirror_on_blocklist_interval">
<span class="sig-name descname"><span class="pre">cephfs_mirror_restart_mirror_on_blocklist_interval</span></span><a class="headerlink" href="#confval-cephfs_mirror_restart_mirror_on_blocklist_interval" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>Interval in seconds to restart blocklisted mirror instances. Setting
to zero (0) disables restarting blocklisted instances.</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">secs</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">30</span></code></p>
</dd>
<dt class="field-odd">min</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">0</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_max_snapshot_sync_per_cycle">
<span class="sig-name descname"><span class="pre">cephfs_mirror_max_snapshot_sync_per_cycle</span></span><a class="headerlink" href="#confval-cephfs_mirror_max_snapshot_sync_per_cycle" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>maximum number of snapshots to mirror when a directory is picked up
for mirroring by worker threads.</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">uint</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">3</span></code></p>
</dd>
<dt class="field-odd">min</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_directory_scan_interval">
<span class="sig-name descname"><span class="pre">cephfs_mirror_directory_scan_interval</span></span><a class="headerlink" href="#confval-cephfs_mirror_directory_scan_interval" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>interval in seconds to scan configured directories for snapshot
mirroring.</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">uint</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">10</span></code></p>
</dd>
<dt class="field-odd">min</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_max_consecutive_failures_per_directory">
<span class="sig-name descname"><span class="pre">cephfs_mirror_max_consecutive_failures_per_directory</span></span><a class="headerlink" href="#confval-cephfs_mirror_max_consecutive_failures_per_directory" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>number of consecutive snapshot synchronization failures to mark a
directory as “failed”. failed directories are retried for
synchronization less frequently.</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">uint</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">10</span></code></p>
</dd>
<dt class="field-odd">min</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">0</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_retry_failed_directories_interval">
<span class="sig-name descname"><span class="pre">cephfs_mirror_retry_failed_directories_interval</span></span><a class="headerlink" href="#confval-cephfs_mirror_retry_failed_directories_interval" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>interval in seconds to retry synchronization for failed directories.</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">uint</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">60</span></code></p>
</dd>
<dt class="field-odd">min</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_restart_mirror_on_failure_interval">
<span class="sig-name descname"><span class="pre">cephfs_mirror_restart_mirror_on_failure_interval</span></span><a class="headerlink" href="#confval-cephfs_mirror_restart_mirror_on_failure_interval" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>Interval in seconds to restart failed mirror instances. Setting to
zero (0) disables restarting failed mirror instances.</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">secs</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">20</span></code></p>
</dd>
<dt class="field-odd">min</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">0</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_mount_timeout">
<span class="sig-name descname"><span class="pre">cephfs_mirror_mount_timeout</span></span><a class="headerlink" href="#confval-cephfs_mirror_mount_timeout" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>Timeout in seconds for mounting primary or secondary (remote) ceph
file system by the cephfs-mirror daemon. Setting this to a higher
value could result in the mirror daemon getting stalled when mounting
a file system if the cluster is not reachable. This option is used to
override the usual client_mount_timeout.</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">secs</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">10</span></code></p>
</dd>
<dt class="field-odd">min</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">0</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="std confval">
<dt class="sig sig-object std" id="confval-cephfs_mirror_perf_stats_prio">
<span class="sig-name descname"><span class="pre">cephfs_mirror_perf_stats_prio</span></span><a class="headerlink" href="#confval-cephfs_mirror_perf_stats_prio" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>如果优先级不是低于 mgr_stats_threshold ，这个守护进程就会把性能计数器数据发给管理器守护进程。</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p>
</dd>
<dt class="field-even">default</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">5</span></code></p>
</dd>
<dt class="field-odd">allowed range</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">11]</span></code></p>
</dd>
</dl>
</div></blockquote>
</dd></dl>

</section>
<section id="re-adding-peers">
<h2>Re-adding Peers<a class="headerlink" href="#re-adding-peers" title="Permalink to this heading"></a></h2>
<p>When re-adding (reassigning) a peer to a file system in another cluster, ensure that
all mirror daemons have stopped synchronization to the peer. This can be checked
via <cite>fs mirror status</cite> admin socket command (the <cite>Peer UUID</cite> should not show up
in the command output). Also, it is recommended to purge synchronized directories
from the peer  before re-adding it to another file system (especially those directories
which might exist in the new primary file system). This is not required if re-adding
a peer to the same primary file system it was earlier synchronized from.</p>
</section>
</section>



<div id="support-the-ceph-foundation" class="admonition note">
  <p class="first admonition-title">Brought to you by the Ceph Foundation</p>
  <p class="last">The Ceph Documentation is a community resource funded and hosted by the non-profit <a href="https://ceph.io/en/foundation/">Ceph Foundation</a>. If you would like to support this and our other efforts, please consider <a href="https://ceph.io/en/foundation/join/">joining now</a>.</p>
</div>


           </div>
           
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../snap-schedule/" class="btn btn-neutral float-left" title="Snapshot Scheduling Module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../client-config-ref/" class="btn btn-neutral float-right" title="客户端配置" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).</p>
  </div>

   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>