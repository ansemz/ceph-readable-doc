
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Troubleshooting &mdash; Ceph Documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Ceph Documentation" href="../../" />
    <link rel="up" title="Ceph Filesystem" href="../" />
    <link rel="next" title="Disaster recovery" href="../disaster-recovery/" />
    <link rel="prev" title="CephFS health messages" href="../health-messages/" />
    <script type="text/javascript" src="http://ayni.ceph.com/public/js/ceph.js"></script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../disaster-recovery/" title="Disaster recovery"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../health-messages/" title="CephFS health messages"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li>
          <li><a href="../" accesskey="U">Ceph Filesystem</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="troubleshooting">
<h1>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h1>
<div class="section" id="slow-stuck-operations">
<h2>Slow/stuck operations<a class="headerlink" href="#slow-stuck-operations" title="Permalink to this headline">¶</a></h2>
<p>If you are experiencing apparent hung operations, the first task is to identify
where the problem is occurring: in the client, the MDS, or the network connecting
them. Start by looking to see if either side has stuck operations
(<a class="reference internal" href="#slow-requests"><em>Slow requests (MDS)</em></a>, below), and narrow it down from there.</p>
</div>
<div class="section" id="rados-health">
<h2>RADOS Health<a class="headerlink" href="#rados-health" title="Permalink to this headline">¶</a></h2>
<p>If part of the CephFS metadata or data pools is unavaible and CephFS isn&#8217;t
responding, it is probably because RADOS itself is unhealthy. Resolve those
problems first (<a class="reference internal" href="../../rados/troubleshooting/"><em>Troubleshooting</em></a>).</p>
</div>
<div class="section" id="the-mds">
<h2>The MDS<a class="headerlink" href="#the-mds" title="Permalink to this headline">¶</a></h2>
<p>If an operation is hung inside the MDS, it will eventually show up in <tt class="docutils literal"><span class="pre">ceph</span> <span class="pre">health</span></tt>,
identifying &#8220;slow requests are blocked&#8221;. It may also identify clients as
&#8220;failing to respond&#8221; or misbehaving in other ways. If the MDS identifies
specific clients as misbehaving, you should investigate why they are doing so.
Generally it will be the result of
1) overloading the system (if you have extra RAM, increase the
&#8220;mds cache size&#8221; config from its default 100000; having a larger active file set
than your MDS cache is the #1 cause of this!)
2) running an older (misbehaving) client, or
3) underlying RADOS issues.</p>
<p>Otherwise, you have probably discovered a new bug and should report it to
the developers!</p>
<div class="section" id="slow-requests-mds">
<span id="slow-requests"></span><h3>Slow requests (MDS)<a class="headerlink" href="#slow-requests-mds" title="Permalink to this headline">¶</a></h3>
<p>You can list current operations via the admin socket by running:</p>
<div class="highlight-python"><pre>ceph daemon mds.&lt;name&gt; dump_ops_in_flight</pre>
</div>
<p>from the MDS host. Identify the stuck commands and examine why they are stuck.
Usually the last &#8220;event&#8221; will have been an attempt to gather locks, or sending
the operation off to the MDS log. If it is waiting on the OSDs, fix them. If
operations are stuck on a specific inode, you probably have a client holding
caps which prevent others from using it, either because the client is trying
to flush out dirty data or because you&#8217;ve encountered a bug in CephFS&#8217;
distributed file lock code (the file &#8220;capabilities&#8221; [&#8220;caps&#8221;] system).</p>
<p>If it&#8217;s a result of a bug in the capabilities code, restarting the MDS
is likely to resolve the problem.</p>
<p>If there are no slow requests reported on the MDS, and it isn&#8217;t reporting
that clients are misbehaving, either the client has a problem or its
requests aren&#8217;t reaching the MDS.</p>
</div>
</div>
<div class="section" id="ceph-fuse-debugging">
<h2>ceph-fuse debugging<a class="headerlink" href="#ceph-fuse-debugging" title="Permalink to this headline">¶</a></h2>
<p>ceph-fuse also supports dump_ops_in_flight. See if it has any and where they are
stuck.</p>
<div class="section" id="debug-output">
<h3>Debug output<a class="headerlink" href="#debug-output" title="Permalink to this headline">¶</a></h3>
<p>To get more debugging information from ceph-fuse, try running in the foreground
with logging to the console (<tt class="docutils literal"><span class="pre">-d</span></tt>) and enabling client debug
(<tt class="docutils literal"><span class="pre">--debug-client=20</span></tt>), enabling prints for each message sent
(<tt class="docutils literal"><span class="pre">--debug-ms=1</span></tt>).</p>
<p>If you suspect a potential monitor issue, enable monitor debugging as well
(<tt class="docutils literal"><span class="pre">--debug-monc=20</span></tt>).</p>
</div>
</div>
<div class="section" id="kernel-mount-debugging">
<h2>Kernel mount debugging<a class="headerlink" href="#kernel-mount-debugging" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Slow requests<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Unfortunately the kernel client does not support the admin socket, but it has
similar (if limited) interfaces if your kernel has debugfs enabled. There
will be a folder in <tt class="docutils literal"><span class="pre">sys/kernel/debug/ceph/</span></tt>, and that folder (whose name will
look something like <tt class="docutils literal"><span class="pre">28f7427e-5558-4ffd-ae1a-51ec3042759a.client25386880</span></tt>)
will contain a variety of files that output interesting output when you <tt class="docutils literal"><span class="pre">cat</span></tt>
them. These files are described below; the most interesting when debugging
slow requests are probably the <tt class="docutils literal"><span class="pre">mdsc</span></tt> and <tt class="docutils literal"><span class="pre">osdc</span></tt> files.</p>
<ul class="simple">
<li>bdi: BDI info about the Ceph system (blocks dirtied, written, etc)</li>
<li>caps: counts of file &#8220;caps&#8221; structures in-memory and used</li>
<li>client_options: dumps the options provided to the CephFS mount</li>
<li>dentry_lru: Dumps the CephFS dentries currently in-memory</li>
<li>mdsc: Dumps current requests to the MDS</li>
<li>mdsmap: Dumps the current MDSMap epoch and MDSes</li>
<li>mds_sessions: Dumps the current sessions to MDSes</li>
<li>monc: Dumps the current maps from the monitor, and any &#8220;subscriptions&#8221; held</li>
<li>monmap: Dumps the current monitor map epoch and monitors</li>
<li>osdc: Dumps the current ops in-flight to OSDs (ie, file data IO)</li>
<li>osdmap: Dumps the current OSDMap epoch, pools, and OSDs</li>
</ul>
<p>If there are no stuck requests but you have file IO which isn&#8217;t progressing,
you might have a...</p>
</div>
</div>
<div class="section" id="disconnected-remounted-fs">
<h2>Disconnected+Remounted FS<a class="headerlink" href="#disconnected-remounted-fs" title="Permalink to this headline">¶</a></h2>
<p>Because CephFS has a &#8220;consistent cache&#8221;, if your network connection is
disrupted for a long enough time, the client will be forcibly
disconnected from the system. At this point, the kernel client is in
a bind: it can&#8217;t safely write back dirty data, and many applications
do not handle IO errors correctly on close().
At the moment, the kernel client will remount the FS, but outstanding filesystem
IO may or may not be satisfied. In these cases, you may need to reboot your
client system.</p>
<p>You can identify you are in this situation if dmesg/kern.log report something like:</p>
<div class="highlight-python"><pre>Jul 20 08:14:38 teuthology kernel: [3677601.123718] ceph: mds0 closed our session
Jul 20 08:14:38 teuthology kernel: [3677601.128019] ceph: mds0 reconnect start
Jul 20 08:14:39 teuthology kernel: [3677602.093378] ceph: mds0 reconnect denied
Jul 20 08:14:39 teuthology kernel: [3677602.098525] ceph:  dropping dirty+flushing Fw state for ffff8802dc150518 1099935956631
Jul 20 08:14:39 teuthology kernel: [3677602.107145] ceph:  dropping dirty+flushing Fw state for ffff8801008e8518 1099935946707
Jul 20 08:14:39 teuthology kernel: [3677602.196747] libceph: mds0 172.21.5.114:6812 socket closed (con state OPEN)
Jul 20 08:14:40 teuthology kernel: [3677603.126214] libceph: mds0 172.21.5.114:6812 connection reset
Jul 20 08:14:40 teuthology kernel: [3677603.132176] libceph: reset on mds0</pre>
</div>
<p>This is an area of ongoing work to improve the behavior. Kernels will soon
be reliably issuing error codes to in-progress IO, although your application(s)
may not deal with them well. In the longer-term, we hope to allow reconnect
and reclaim of data in cases where it won&#8217;t violate POSIX semantics (generally,
data which hasn&#8217;t been accessed or modified by other clients).</p>
</div>
<div class="section" id="mounting">
<h2>Mounting<a class="headerlink" href="#mounting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mount-5-error">
<h3>Mount 5 Error<a class="headerlink" href="#mount-5-error" title="Permalink to this headline">¶</a></h3>
<p>A mount 5 error typically occurs if a MDS server is laggy or if it crashed.
Ensure at least one MDS is up and running, and the cluster is <tt class="docutils literal"><span class="pre">active</span> <span class="pre">+</span>
<span class="pre">healthy</span></tt>.</p>
</div>
<div class="section" id="mount-12-error">
<h3>Mount 12 Error<a class="headerlink" href="#mount-12-error" title="Permalink to this headline">¶</a></h3>
<p>A mount 12 error with <tt class="docutils literal"><span class="pre">cannot</span> <span class="pre">allocate</span> <span class="pre">memory</span></tt> usually occurs if you  have a
version mismatch between the <a class="reference internal" href="../../glossary/#term-ceph-client"><em class="xref std std-term">Ceph Client</em></a> version and the <a class="reference internal" href="../../glossary/#term-ceph-storage-cluster"><em class="xref std std-term">Ceph
Storage Cluster</em></a> version. Check the versions using:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="o">-</span><span class="n">v</span>
</pre></div>
</div>
<p>If the Ceph Client is behind the Ceph cluster, try to upgrade it:</p>
<div class="highlight-python"><pre>sudo apt-get update &amp;&amp; sudo apt-get install ceph-common</pre>
</div>
<p>You may need to uninstall, autoclean and autoremove <tt class="docutils literal"><span class="pre">ceph-common</span></tt>
and then reinstall it so that you have the latest version.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/">Installation (Quick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installation (Manual)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph Filesystem</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../#using-cephfs">Using CephFS</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../rados/deployment/ceph-deploy-mds/">Add/Remove MDS(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/">Terminology</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#referring-to-mds-daemons">Referring to MDS daemons</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#managing-failover">Managing failover</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#configuring-standby-daemons">Configuring standby daemons</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standby/#examples">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mds-config-ref/">MDS Configuration Settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../client-config-ref/">Client Configuration Settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../journaler/">Journaler Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../man/8/ceph-mds/">Manpage ceph-mds</a></li>
<li class="toctree-l3"><a class="reference internal" href="../createfs/">Create CephFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../kernel/">Mount CephFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fuse/">Mount CephFS as FUSE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fstab/">Mount CephFS in fstab</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../man/8/ceph-fuse/">Manpage ceph-fuse</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../man/8/mount.ceph/">Manpage mount.ceph</a></li>
<li class="toctree-l3"><a class="reference internal" href="../best-practices/">Deployment best practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../administration/">Administrative commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../posix/">POSIX compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="../experimental-features/">Experimental Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../experimental-features/#previously-experimental-features">Previously experimental features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quota/">CephFS Quotas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hadoop/">Using Ceph with Hadoop</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-journal-tool/">cephfs-journal-tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../file-layouts/">File layouts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../eviction/">Client eviction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../full/">Handling full filesystems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../health-messages/">Health messages</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Troubleshooting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#slow-stuck-operations">Slow/stuck operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rados-health">RADOS Health</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-mds">The MDS</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#slow-requests-mds">Slow requests (MDS)</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#ceph-fuse-debugging">ceph-fuse debugging</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#debug-output">Debug output</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#kernel-mount-debugging">Kernel mount debugging</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id1">Slow requests</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#disconnected-remounted-fs">Disconnected+Remounted FS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mounting">Mounting</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#mount-5-error">Mount 5 Error</a></li>
<li class="toctree-l5"><a class="reference internal" href="#mount-12-error">Mount 12 Error</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disaster-recovery/">Disaster recovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="../client-auth/">Client authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrading/">Upgrading old filesystems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dirfrags/">Configuring directory fragmentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../multimds/">Configuring multiple active MDS daemons</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#for-developers">For developers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../disaster-recovery/" title="Disaster recovery"
             >next</a> |</li>
        <li class="right" >
          <a href="../health-messages/" title="CephFS health messages"
             >previous</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li>
          <li><a href="../" >Ceph Filesystem</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Red Hat, Inc, and contributors. Licensed under Creative Commons BY-SA.
    </div>
  </body>
</html>