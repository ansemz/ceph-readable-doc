
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>基于 Apache/FastCGI 的 Ceph 对象网关配置 &#8212; Ceph Documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="多站" href="../multisite/" />
    <link rel="prev" title="Pool Placement and Storage Classes" href="../placement/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../multisite/" title="多站"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../placement/" title="Pool Placement and Storage Classes"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Ceph 对象网关</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            

<div id="dev-warning" class="admonition note" style="display:none;">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>

<div id="eol-warning" class="admonition warning" style="display:none;">
  <p class="first admonition-title">Warning</p>
  <p class="last">This document is for an unsupported version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="display:none; padding: 15px; font-weight: bold;">
    <a id="edit-on-github" href="https://github.com/ceph/ceph/edit/master/doc/radosgw/config-fcgi.rst" rel="nofollow">Edit on GitHub</a> | <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <div class="section" id="apache-fastcgi-ceph">
<h1>基于 Apache/FastCGI 的 Ceph 对象网关配置<a class="headerlink" href="#apache-fastcgi-ceph" title="Permalink to this headline">¶</a></h1>
<p>要配置 Ceph 对象网关需要一个运行着的 Ceph 存储集群。因为它内嵌了一个网页服务器（ civetweb ），所以 Ceph 对象网关不需要外部网页服务器也能运行；但是仍然可以通过配置了 FastCGI
模块的 Apache 网页服务器运行。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CGI 有潜在的安全风险。</p>
</div>
<p>Ceph 对象网关是 Ceph 存储集群的一个客户端，作为 Ceph 存储集群的客户端，它需要：</p>
<ul class="simple">
<li><p>A name for the gateway instance. We use <code class="docutils literal notranslate"><span class="pre">gateway</span></code> in this guide.</p></li>
<li><p>A storage cluster user name with appropriate permissions in a keyring.</p></li>
<li><p>Pools to store its data.</p></li>
<li><p>A data directory for the gateway instance.</p></li>
<li><p>An instance entry in the Ceph Configuration file.</p></li>
<li><p>A configuration file for the web server to interact with FastCGI.</p></li>
</ul>
<div class="section" id="create-a-user-and-keyring">
<h2>Create a User and Keyring<a class="headerlink" href="#create-a-user-and-keyring" title="Permalink to this headline">¶</a></h2>
<p>Each instance must have a user name and key to communicate with a Ceph Storage
Cluster. In the following steps, we use an admin node to create a keyring.
Then, we create a client user name and key. Next, we add the
key to the Ceph Storage Cluster. Finally, we distribute the key ring to
the node containing the gateway instance.</p>
<div class="topic">
<p class="topic-title">Monitor Key CAPS</p>
<p>When you provide CAPS to the key, you MUST provide read capability.
However, you have the option of providing write capability for the monitor.
This is an important choice. If you provide write capability to the key,
the Ceph Object Gateway will have the ability to create pools automatically;
however, it will create pools with either the default number of placement
groups (not ideal) or the number of placement groups you specified in your
Ceph configuration file. If you allow the Ceph Object Gateway to create
pools automatically, ensure that you have reasonable defaults for the number
of placement groups first. See <a class="reference external" href="../../rados/configuration/pool-pg-config-ref/">Pool Configuration</a> for details.</p>
</div>
<p>关于 Ceph 认证请参考<a class="reference external" href="../../rados/operations/user-management">用户管理</a>。</p>
<ol class="arabic">
<li><p>Generate a Ceph Object Gateway user name and key for each instance. For
exemplary purposes, we will use the name <code class="docutils literal notranslate"><span class="pre">gateway</span></code> after <code class="docutils literal notranslate"><span class="pre">client.radosgw</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span><span class="o">-</span><span class="ow">or</span><span class="o">-</span><span class="n">create</span> <span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span> <span class="n">osd</span> <span class="s1">&#39;allow rwx&#39;</span> <span class="n">mon</span> <span class="s1">&#39;allow rwx&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">keyring</span>
</pre></div>
</div>
</li>
<li><p>Distribute the keyring to the node with the gateway instance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">scp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="o">@</span><span class="p">{</span><span class="n">hostname</span><span class="p">}:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ceph</span>
<span class="n">ssh</span> <span class="p">{</span><span class="n">hostname</span><span class="p">}</span>
<span class="n">sudo</span> <span class="n">mv</span> <span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">keyring</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">keyring</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果 <code class="docutils literal notranslate"><span class="pre">admin</span> <span class="pre">node</span></code> 就是 <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code> ，那第
2 步就没必要。</p>
</div>
</li>
</ol>
</div>
<div class="section" id="id1">
<h2>创建存储池<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Ceph Object Gateways require Ceph Storage Cluster pools to store specific
gateway data.  If the user you created has permissions, the gateway
will create the pools automatically. However, you should ensure that you have
set an appropriate default number of placement groups per pool into your Ceph
configuration file.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ceph 对象网关有多个存储池，考虑到所有存储池会共用相同的 CRUSH 分级结构，所以 PG 数不要设置得过大，否则会影响性能。</p>
</div>
<p>When configuring a gateway with the default region and zone, the naming
convention for pools typically omits region and zone naming, but you can use any
naming convention you prefer. For example:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.rgw</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.rgw.root</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.rgw.control</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.rgw.gc</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.rgw.buckets</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.rgw.buckets.index</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.rgw.buckets.extra</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.intent-log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.usage</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.users</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.users.email</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.users.swift</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.users.uid</span></code></p></li>
</ul>
<p>See <a class="reference external" href="../config-ref#pools">配置参考——存储池</a> for details on the default pools for
gateways. See <a class="reference external" href="../../rados/operations/pools">Pools</a> for details on creating pools. As already said, if
write permission is given, Ceph Object Gateway will create pools automatically.
To create a pool manually, execute the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="p">{</span><span class="n">poolname</span><span class="p">}</span> <span class="p">{</span><span class="n">pg</span><span class="o">-</span><span class="n">num</span><span class="p">}</span> <span class="p">{</span><span class="n">pgp</span><span class="o">-</span><span class="n">num</span><span class="p">}</span> <span class="p">{</span><span class="n">replicated</span> <span class="o">|</span> <span class="n">erasure</span><span class="p">}</span> <span class="p">[{</span><span class="n">erasure</span><span class="o">-</span><span class="n">code</span><span class="o">-</span><span class="n">profile</span><span class="p">}]</span>  <span class="p">{</span><span class="n">ruleset</span><span class="o">-</span><span class="n">name</span><span class="p">}</span> <span class="p">{</span><span class="n">ruleset</span><span class="o">-</span><span class="n">number</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Ceph 允许多级 CRUSH 和多种 CRUSH 规则集，这样在配置你自己的网关时就有很大的灵活性。像 <code class="docutils literal notranslate"><span class="pre">rgw.buckets.index</span></code> 这样的存储池就可以利用副本数适当的 SSD 存储池取得高性能；后端存储也可以从更经济的纠删编码的存储中获益，还可能利用缓存层提升性能。</p>
</div>
<p>完成此步骤之后，执行下列命令确认前述存储池是否都创建了：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rados</span> <span class="n">lspools</span>
</pre></div>
</div>
</div>
<div class="section" id="ceph">
<h2>为 Ceph 新增网关配置<a class="headerlink" href="#ceph" title="Permalink to this headline">¶</a></h2>
<p>Add the Ceph Object Gateway configuration to your Ceph Configuration file in
<code class="docutils literal notranslate"><span class="pre">admin</span> <span class="pre">node</span></code>. The Ceph Object Gateway configuration requires you to
identify the Ceph Object Gateway instance. Then, you must specify the host name
where you installed the Ceph Object Gateway daemon, a keyring (for use with
cephx), the socket path for FastCGI and a log file.</p>
<p>For distros with Apache 2.2 and early versions of Apache 2.4 (RHEL 6, Ubuntu
12.04, 14.04 etc), append the following configuration to <code class="docutils literal notranslate"><span class="pre">/etc/ceph/ceph.conf</span></code>
in your <code class="docutils literal notranslate"><span class="pre">admin</span> <span class="pre">node</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span><span class="p">]</span>
<span class="n">host</span> <span class="o">=</span> <span class="p">{</span><span class="n">hostname</span><span class="p">}</span>
<span class="n">keyring</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">keyring</span>
<span class="n">rgw</span> <span class="n">socket</span> <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">log</span> <span class="n">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">radosgw</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">log</span>
<span class="n">rgw</span> <span class="n">frontends</span> <span class="o">=</span> <span class="n">fastcgi</span> <span class="n">socket_port</span><span class="o">=</span><span class="mi">9000</span> <span class="n">socket_host</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">rgw</span> <span class="nb">print</span> <span class="k">continue</span> <span class="o">=</span> <span class="n">false</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Apache 2.2 and early versions of Apache 2.4 do not use Unix Domain
Sockets but use localhost TCP.</p>
</div>
<p>For distros with Apache 2.4.9 or later (RHEL 7, CentOS 7 etc), append the
following configuration to <code class="docutils literal notranslate"><span class="pre">/etc/ceph/ceph.conf</span></code> in your <code class="docutils literal notranslate"><span class="pre">admin</span> <span class="pre">node</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span><span class="p">]</span>
<span class="n">host</span> <span class="o">=</span> <span class="p">{</span><span class="n">hostname</span><span class="p">}</span>
<span class="n">keyring</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">keyring</span>
<span class="n">rgw</span> <span class="n">socket</span> <span class="n">path</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">fastcgi</span><span class="o">.</span><span class="n">sock</span>
<span class="n">log</span> <span class="n">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">radosgw</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">log</span>
<span class="n">rgw</span> <span class="nb">print</span> <span class="k">continue</span> <span class="o">=</span> <span class="n">false</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">Apache</span> <span class="pre">2.4.9</span></code> supports Unix Domain Socket (UDS) but as
<code class="docutils literal notranslate"><span class="pre">Ubuntu</span> <span class="pre">14.04</span></code> ships with <code class="docutils literal notranslate"><span class="pre">Apache</span> <span class="pre">2.4.7</span></code> it doesn’t have UDS support and
has to be configured for use with localhost TCP. A bug has been filed for
backporting UDS support in <code class="docutils literal notranslate"><span class="pre">Apache</span> <span class="pre">2.4.7</span></code> for <code class="docutils literal notranslate"><span class="pre">Ubuntu</span> <span class="pre">14.04</span></code>.
See: <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/apache2/+bug/1411030">Backport support for UDS in Ubuntu Trusty</a></p>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">{hostname}</span></code> is the short hostname (output of command <code class="docutils literal notranslate"><span class="pre">hostname</span> <span class="pre">-s</span></code>)
of the node that is going to provide the gateway service i.e, the
<code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">[client.radosgw.gateway]</span></code> portion of the gateway instance identifies this
portion of the Ceph configuration file as configuring a Ceph Storage Cluster
client where the client type is a Ceph Object Gateway (i.e., <code class="docutils literal notranslate"><span class="pre">radosgw</span></code>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The last line in the configuration i.e, <code class="docutils literal notranslate"><span class="pre">rgw</span> <span class="pre">print</span> <span class="pre">continue</span> <span class="pre">=</span> <span class="pre">false</span></code>
is added to avoid issues with <code class="docutils literal notranslate"><span class="pre">PUT</span></code> operations.</p>
</div>
<p>Once you finish the setup procedure, if you encounter issues with your
configuration, you can add debugging to the <code class="docutils literal notranslate"><span class="pre">[global]</span></code> section of your Ceph
configuration file and restart the gateway to help troubleshoot any
configuration issues. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="k">global</span><span class="p">]</span>
<span class="c1">#append the following in the global section.</span>
<span class="n">debug</span> <span class="n">ms</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">debug</span> <span class="n">rgw</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
<div class="section" id="distribute-updated-ceph-configuration-file">
<h2>Distribute updated Ceph configuration file<a class="headerlink" href="#distribute-updated-ceph-configuration-file" title="Permalink to this headline">¶</a></h2>
<p>The updated Ceph configuration file needs to be distributed to all Ceph cluster
nodes from the <code class="docutils literal notranslate"><span class="pre">admin</span> <span class="pre">node</span></code>.</p>
<p>It involves the following steps:</p>
<ol class="arabic">
<li><p>Pull the updated <code class="docutils literal notranslate"><span class="pre">ceph.conf</span></code> from <code class="docutils literal notranslate"><span class="pre">/etc/ceph/</span></code> to the root directory of
the cluster in admin node (e.g. <code class="docutils literal notranslate"><span class="pre">my-cluster</span></code> directory). The contents of
<code class="docutils literal notranslate"><span class="pre">ceph.conf</span></code> in <code class="docutils literal notranslate"><span class="pre">my-cluster</span></code> will get overwritten. To do so, execute the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">deploy</span> <span class="o">--</span><span class="n">overwrite</span><span class="o">-</span><span class="n">conf</span> <span class="n">config</span> <span class="n">pull</span> <span class="p">{</span><span class="n">hostname</span><span class="p">}</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">{hostname}</span></code> is the short hostname of the Ceph admin node.</p>
</li>
<li><p>Push the updated <code class="docutils literal notranslate"><span class="pre">ceph.conf</span></code> file from the admin node to all other nodes in
the cluster including the <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">deploy</span> <span class="o">--</span><span class="n">overwrite</span><span class="o">-</span><span class="n">conf</span> <span class="n">config</span> <span class="n">push</span> <span class="p">[</span><span class="n">HOST</span><span class="p">]</span> <span class="p">[</span><span class="n">HOST</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>Give the hostnames of the other Ceph nodes in place of <code class="docutils literal notranslate"><span class="pre">[HOST]</span> <span class="pre">[HOST...]</span></code>.</p>
</li>
</ol>
</div>
<div class="section" id="copy-ceph-client-admin-keyring-from-admin-node-to-gateway-host">
<h2>Copy ceph.client.admin.keyring from admin node to gateway host<a class="headerlink" href="#copy-ceph-client-admin-keyring-from-admin-node-to-gateway-host" title="Permalink to this headline">¶</a></h2>
<p>As the <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code> can be a different node that is not part of the cluster,
the <code class="docutils literal notranslate"><span class="pre">ceph.client.admin.keyring</span></code> needs to be copied from the <code class="docutils literal notranslate"><span class="pre">admin</span> <span class="pre">node</span></code> to
the <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>. To do so, execute the following on <code class="docutils literal notranslate"><span class="pre">admin</span> <span class="pre">node</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">scp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="o">@</span><span class="p">{</span><span class="n">hostname</span><span class="p">}:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ceph</span>
<span class="n">ssh</span> <span class="p">{</span><span class="n">hostname</span><span class="p">}</span>
<span class="n">sudo</span> <span class="n">mv</span> <span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">keyring</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">keyring</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The above step need not be executed if <code class="docutils literal notranslate"><span class="pre">admin</span> <span class="pre">node</span></code> is the
<code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>.</p>
</div>
</div>
<div class="section" id="create-data-directory">
<h2>Create Data Directory<a class="headerlink" href="#create-data-directory" title="Permalink to this headline">¶</a></h2>
<p>Deployment scripts may not create the default Ceph Object Gateway data
directory. Create data directories for each instance of a <code class="docutils literal notranslate"><span class="pre">radosgw</span></code>
daemon (if you haven’t done so already). The <code class="docutils literal notranslate"><span class="pre">host</span></code> variables in the
Ceph configuration file determine which host runs each instance of a
<code class="docutils literal notranslate"><span class="pre">radosgw</span></code> daemon. The typical form specifies the <code class="docutils literal notranslate"><span class="pre">radosgw</span></code> daemon,
the cluster name and the daemon ID.</p>
<p>To create the directory on the <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>, execute the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">radosgw</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span>
</pre></div>
</div>
</div>
<div class="section" id="adjust-socket-directory-permissions">
<h2>Adjust Socket Directory Permissions<a class="headerlink" href="#adjust-socket-directory-permissions" title="Permalink to this headline">¶</a></h2>
<p>On some distros, the <code class="docutils literal notranslate"><span class="pre">radosgw</span></code> daemon runs as the unprivileged <code class="docutils literal notranslate"><span class="pre">apache</span></code>
UID, and this UID must have write access to the location where it will write
its socket file.</p>
<p>To grant permissions to the default socket location, execute the following on
the <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">chown</span> <span class="n">apache</span><span class="p">:</span><span class="n">apache</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ceph</span>
</pre></div>
</div>
</div>
<div class="section" id="change-log-file-owner">
<h2>Change Log File Owner<a class="headerlink" href="#change-log-file-owner" title="Permalink to this headline">¶</a></h2>
<p>On some distros, the <code class="docutils literal notranslate"><span class="pre">radosgw</span></code> daemon runs as the unprivileged <code class="docutils literal notranslate"><span class="pre">apache</span></code> UID,
but the <code class="docutils literal notranslate"><span class="pre">root</span></code> user owns the log file by default. You must change it to the
<code class="docutils literal notranslate"><span class="pre">apache</span></code> user so that Apache can populate the log file. To do so, execute
the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">chown</span> <span class="n">apache</span><span class="p">:</span><span class="n">apache</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">radosgw</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
</div>
<div class="section" id="start-radosgw-service">
<h2>Start radosgw service<a class="headerlink" href="#start-radosgw-service" title="Permalink to this headline">¶</a></h2>
<p>The Ceph Object gateway daemon needs to be started. To do so, execute the
following on the <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>:</p>
<p>On Debian-based distros:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">radosgw</span> <span class="n">start</span>
</pre></div>
</div>
<p>On RPM-based distros:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="n">radosgw</span> <span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-gateway-configuration-file">
<h2>Create a Gateway Configuration file<a class="headerlink" href="#create-a-gateway-configuration-file" title="Permalink to this headline">¶</a></h2>
<p>On the host where you installed the Ceph Object Gateway i.e, <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>,
create an <code class="docutils literal notranslate"><span class="pre">rgw.conf</span></code> file. Place the file in <code class="docutils literal notranslate"><span class="pre">/etc/apache2/conf-available</span></code>
directory for <code class="docutils literal notranslate"><span class="pre">Debian-based</span></code> distros and in <code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d</span></code> directory
for <code class="docutils literal notranslate"><span class="pre">RPM-based</span></code> distros. It is a Apache configuration file which is needed
for the <code class="docutils literal notranslate"><span class="pre">radosgw</span></code> service. This file must be readable by the web server.</p>
<p>Execute the following steps:</p>
<ol class="arabic">
<li><p>Create the file:</p>
<p>For Debian-based distros, execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">conf</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">rgw</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>For RPM-based distros, execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rgw</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</li>
<li><p>For distros with Apache 2.2 and early versions of Apache 2.4 that use
localhost TCP and do not support Unix Domain Socket, add the following
contents to the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">VirtualHost</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span><span class="o">&gt;</span>
<span class="n">ServerName</span> <span class="n">localhost</span>
<span class="n">DocumentRoot</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span>

<span class="n">ErrorLog</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">rgw_error</span><span class="o">.</span><span class="n">log</span>
<span class="n">CustomLog</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">rgw_access</span><span class="o">.</span><span class="n">log</span> <span class="n">combined</span>

<span class="c1"># LogLevel debug</span>

<span class="n">RewriteEngine</span> <span class="n">On</span>

<span class="n">RewriteRule</span> <span class="o">.*</span> <span class="o">-</span> <span class="p">[</span><span class="n">E</span><span class="o">=</span><span class="n">HTTP_AUTHORIZATION</span><span class="p">:</span><span class="o">%</span><span class="p">{</span><span class="n">HTTP</span><span class="p">:</span><span class="n">Authorization</span><span class="p">},</span><span class="n">L</span><span class="p">]</span>

<span class="n">SetEnv</span> <span class="n">proxy</span><span class="o">-</span><span class="n">nokeepalive</span> <span class="mi">1</span>

<span class="n">ProxyPass</span> <span class="o">/</span> <span class="n">fcgi</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">9000</span><span class="o">/</span>

<span class="o">&lt;/</span><span class="n">VirtualHost</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For Debian-based distros replace <code class="docutils literal notranslate"><span class="pre">/var/log/httpd/</span></code>
with <code class="docutils literal notranslate"><span class="pre">/var/log/apache2</span></code>.</p>
</div>
</li>
<li><p>For distros with Apache 2.4.9 or later that support Unix Domain Socket,
add the following contents to the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">VirtualHost</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span><span class="o">&gt;</span>
<span class="n">ServerName</span> <span class="n">localhost</span>
<span class="n">DocumentRoot</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span>

<span class="n">ErrorLog</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">rgw_error</span><span class="o">.</span><span class="n">log</span>
<span class="n">CustomLog</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">rgw_access</span><span class="o">.</span><span class="n">log</span> <span class="n">combined</span>

<span class="c1"># LogLevel debug</span>

<span class="n">RewriteEngine</span> <span class="n">On</span>

<span class="n">RewriteRule</span> <span class="o">.*</span> <span class="o">-</span> <span class="p">[</span><span class="n">E</span><span class="o">=</span><span class="n">HTTP_AUTHORIZATION</span><span class="p">:</span><span class="o">%</span><span class="p">{</span><span class="n">HTTP</span><span class="p">:</span><span class="n">Authorization</span><span class="p">},</span><span class="n">L</span><span class="p">]</span>

<span class="n">SetEnv</span> <span class="n">proxy</span><span class="o">-</span><span class="n">nokeepalive</span> <span class="mi">1</span>

<span class="n">ProxyPass</span> <span class="o">/</span> <span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">fastcgi</span><span class="o">.</span><span class="n">sock</span><span class="o">|</span><span class="n">fcgi</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">9000</span><span class="o">/</span>

<span class="o">&lt;/</span><span class="n">VirtualHost</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="restart-apache">
<h2>Restart Apache<a class="headerlink" href="#restart-apache" title="Permalink to this headline">¶</a></h2>
<p>The Apache service needs to be restarted to accept the new configuration.</p>
<p>For Debian-based distros, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">apache2</span> <span class="n">restart</span>
</pre></div>
</div>
<p>For RPM-based distros, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">httpd</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">httpd</span>
</pre></div>
</div>
</div>
<div class="section" id="using-the-gateway">
<h2>Using The Gateway<a class="headerlink" href="#using-the-gateway" title="Permalink to this headline">¶</a></h2>
<p>To use the REST interfaces, first create an initial Ceph Object Gateway
user for the S3 interface. Then, create a subuser for the Swift interface.
See the <a class="reference external" href="../admin">Admin Guide</a> for more details on user management.</p>
<div class="section" id="create-a-radosgw-user-for-s3-access">
<h3>Create a radosgw user for S3 access<a class="headerlink" href="#create-a-radosgw-user-for-s3-access" title="Permalink to this headline">¶</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">radosgw</span></code> user needs to be created and granted access. The command
<code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">radosgw-admin</span></code> will provide information on additional command options.</p>
<p>To create the user, execute the following on the <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">radosgw</span><span class="o">-</span><span class="n">admin</span> <span class="n">user</span> <span class="n">create</span> <span class="o">--</span><span class="n">uid</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span> <span class="o">--</span><span class="n">display</span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;First User&quot;</span>
</pre></div>
</div>
<p>The output of the command will be something like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
<span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;First User&quot;</span><span class="p">,</span>
<span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="s2">&quot;suspended&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="s2">&quot;max_buckets&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
<span class="s2">&quot;auid&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="s2">&quot;subusers&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="p">{</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
<span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;I0PJDPCIYZ665MW88W9R&quot;</span><span class="p">,</span>
<span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;dxaXZ8U90SXydYzyS5ivamEP20hkLSUViiaR+ZDA&quot;</span><span class="p">}],</span>
<span class="s2">&quot;swift_keys&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="s2">&quot;caps&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="s2">&quot;op_mask&quot;</span><span class="p">:</span> <span class="s2">&quot;read, write, delete&quot;</span><span class="p">,</span>
<span class="s2">&quot;default_placement&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="s2">&quot;placement_tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="s2">&quot;bucket_quota&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
<span class="s2">&quot;max_size_kb&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="s2">&quot;max_objects&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
<span class="s2">&quot;user_quota&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
<span class="s2">&quot;max_size_kb&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="s2">&quot;max_objects&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
<span class="s2">&quot;temp_url_keys&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>验证访问时， <code class="docutils literal notranslate"><span class="pre">keys-&gt;access_key</span></code> 和 <code class="docutils literal notranslate"><span class="pre">keys-&gt;secret_key</span></code> 的值是必需的。</p>
</div>
</div>
<div class="section" id="swift">
<h3>创建一个 Swift 用户<a class="headerlink" href="#swift" title="Permalink to this headline">¶</a></h3>
<p>如果要通过 Swift 访问，必须创建一个 Swift 子用户。需要分两步完成，第一步是创建用户，第二步创建密钥。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code> 主机上进行如下操作：</p>
<p>创建 Swift 用户：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">radosgw</span><span class="o">-</span><span class="n">admin</span> <span class="n">subuser</span> <span class="n">create</span> <span class="o">--</span><span class="n">uid</span><span class="o">=</span><span class="n">testuser</span> <span class="o">--</span><span class="n">subuser</span><span class="o">=</span><span class="n">testuser</span><span class="p">:</span><span class="n">swift</span> <span class="o">--</span><span class="n">access</span><span class="o">=</span><span class="n">full</span>
</pre></div>
</div>
<p>此命令的输出类似如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
<span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;First User&quot;</span><span class="p">,</span>
<span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="s2">&quot;suspended&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="s2">&quot;max_buckets&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
<span class="s2">&quot;auid&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="s2">&quot;subusers&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser:swift&quot;</span><span class="p">,</span>
<span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;full-control&quot;</span><span class="p">}],</span>
<span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="p">{</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser:swift&quot;</span><span class="p">,</span>
<span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;3Y1LNW4Q6X0Y53A52DET&quot;</span><span class="p">,</span>
<span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
<span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;I0PJDPCIYZ665MW88W9R&quot;</span><span class="p">,</span>
<span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;dxaXZ8U90SXydYzyS5ivamEP20hkLSUViiaR+ZDA&quot;</span><span class="p">}],</span>
<span class="s2">&quot;swift_keys&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="s2">&quot;caps&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="s2">&quot;op_mask&quot;</span><span class="p">:</span> <span class="s2">&quot;read, write, delete&quot;</span><span class="p">,</span>
<span class="s2">&quot;default_placement&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="s2">&quot;placement_tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="s2">&quot;bucket_quota&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
<span class="s2">&quot;max_size_kb&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="s2">&quot;max_objects&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
<span class="s2">&quot;user_quota&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
<span class="s2">&quot;max_size_kb&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="s2">&quot;max_objects&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
<span class="s2">&quot;temp_url_keys&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</pre></div>
</div>
<p>创建用户的密钥：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">radosgw</span><span class="o">-</span><span class="n">admin</span> <span class="n">key</span> <span class="n">create</span> <span class="o">--</span><span class="n">subuser</span><span class="o">=</span><span class="n">testuser</span><span class="p">:</span><span class="n">swift</span> <span class="o">--</span><span class="n">key</span><span class="o">-</span><span class="nb">type</span><span class="o">=</span><span class="n">swift</span> <span class="o">--</span><span class="n">gen</span><span class="o">-</span><span class="n">secret</span>
</pre></div>
</div>
<p>此命令的输出类似如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
<span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;First User&quot;</span><span class="p">,</span>
<span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="s2">&quot;suspended&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="s2">&quot;max_buckets&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
<span class="s2">&quot;auid&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="s2">&quot;subusers&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser:swift&quot;</span><span class="p">,</span>
<span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;full-control&quot;</span><span class="p">}],</span>
<span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="p">{</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser:swift&quot;</span><span class="p">,</span>
<span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;3Y1LNW4Q6X0Y53A52DET&quot;</span><span class="p">,</span>
<span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
<span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;I0PJDPCIYZ665MW88W9R&quot;</span><span class="p">,</span>
<span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;dxaXZ8U90SXydYzyS5ivamEP20hkLSUViiaR+ZDA&quot;</span><span class="p">}],</span>
<span class="s2">&quot;swift_keys&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="p">{</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser:swift&quot;</span><span class="p">,</span>
<span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;244+fz2gSqoHwR3lYtSbIyomyPHf3i7rgSJrF\/IA&quot;</span><span class="p">}],</span>
<span class="s2">&quot;caps&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="s2">&quot;op_mask&quot;</span><span class="p">:</span> <span class="s2">&quot;read, write, delete&quot;</span><span class="p">,</span>
<span class="s2">&quot;default_placement&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="s2">&quot;placement_tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="s2">&quot;bucket_quota&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
<span class="s2">&quot;max_size_kb&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="s2">&quot;max_objects&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
<span class="s2">&quot;user_quota&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
<span class="s2">&quot;max_size_kb&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="s2">&quot;max_objects&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
<span class="s2">&quot;temp_url_keys&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>访问验证<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>然后你得验证一下刚创建的用户是否能访问网关。</p>
<div class="section" id="s3">
<h3>测试 S3 访问<a class="headerlink" href="#s3" title="Permalink to this headline">¶</a></h3>
<p>You need to write and run a Python test script for verifying S3 access. The S3
access test script will connect to the <code class="docutils literal notranslate"><span class="pre">radosgw</span></code>, create a new bucket and list
all buckets. The values for <code class="docutils literal notranslate"><span class="pre">aws_access_key_id</span></code> and <code class="docutils literal notranslate"><span class="pre">aws_secret_access_key</span></code>
are taken from the values of <code class="docutils literal notranslate"><span class="pre">access_key</span></code> and <code class="docutils literal notranslate"><span class="pre">secret_key</span></code> returned by the
<code class="docutils literal notranslate"><span class="pre">radosgw_admin</span></code> command.</p>
<p>Execute the following steps:</p>
<ol class="arabic">
<li><p>You will need to install the <code class="docutils literal notranslate"><span class="pre">python-boto</span></code> package.</p>
<p>For Debian-based distros, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">boto</span>
</pre></div>
</div>
<p>For RPM-based distros, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">boto</span>
</pre></div>
</div>
</li>
<li><p>Create the Python script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="n">s3test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</li>
<li><p>Add the following contents to the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">boto</span>
<span class="kn">import</span> <span class="nn">boto.s3.connection</span>
<span class="n">access_key</span> <span class="o">=</span> <span class="s1">&#39;I0PJDPCIYZ665MW88W9R&#39;</span>
<span class="n">secret_key</span> <span class="o">=</span> <span class="s1">&#39;dxaXZ8U90SXydYzyS5ivamEP20hkLSUViiaR+ZDA&#39;</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">(</span>
<span class="n">aws_access_key_id</span> <span class="o">=</span> <span class="n">access_key</span><span class="p">,</span>
<span class="n">aws_secret_access_key</span> <span class="o">=</span> <span class="n">secret_key</span><span class="p">,</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{hostname}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="n">is_secure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="n">calling_format</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">OrdinaryCallingFormat</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="s1">&#39;my-new-bucket&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_all_buckets</span><span class="p">():</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="se">\t</span><span class="si">{created}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">created</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">creation_date</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Replace <code class="docutils literal notranslate"><span class="pre">{hostname}</span></code> with the hostname of the host where you have
configured the gateway service i.e, the <code class="docutils literal notranslate"><span class="pre">gateway</span> <span class="pre">host</span></code>.</p>
</li>
<li><p>Run the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">s3test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>The output will be something like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my</span><span class="o">-</span><span class="n">new</span><span class="o">-</span><span class="n">bucket</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span><span class="n">T17</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mf">10.000</span><span class="n">Z</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="test-swift-access">
<h3>Test swift access<a class="headerlink" href="#test-swift-access" title="Permalink to this headline">¶</a></h3>
<p>Swift access can be verified via the <code class="docutils literal notranslate"><span class="pre">swift</span></code> command line client. The command
<code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">swift</span></code> will provide more information on available command line options.</p>
<p>To install <code class="docutils literal notranslate"><span class="pre">swift</span></code> client, execute the following:</p>
<blockquote>
<div><p>For Debian-based distros:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">setuptools</span>
<span class="n">sudo</span> <span class="n">easy_install</span> <span class="n">pip</span>
<span class="n">sudo</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">setuptools</span>
<span class="n">sudo</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">python</span><span class="o">-</span><span class="n">swiftclient</span>
</pre></div>
</div>
<p>For RPM-based distros:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">setuptools</span>
<span class="n">sudo</span> <span class="n">easy_install</span> <span class="n">pip</span>
<span class="n">sudo</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">setuptools</span>
<span class="n">sudo</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">python</span><span class="o">-</span><span class="n">swiftclient</span>
</pre></div>
</div>
</div></blockquote>
<p>To test swift access, execute the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>swift -A http://{IP ADDRESS}/auth/1.0 -U testuser:swift -K ‘{swift_secret_key}’ list
</pre></div>
</div>
<p>Replace <code class="docutils literal notranslate"><span class="pre">{IP</span> <span class="pre">ADDRESS}</span></code> with the public IP address of the gateway server and
<code class="docutils literal notranslate"><span class="pre">{swift_secret_key}</span></code> with its value from the output of
<code class="docutils literal notranslate"><span class="pre">radosgw-admin</span> <span class="pre">key</span> <span class="pre">create</span></code> command executed for the <code class="docutils literal notranslate"><span class="pre">swift</span></code> user.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>swift -A http://10.19.143.116/auth/1.0 -U testuser:swift -K ‘244+fz2gSqoHwR3lYtSbIyomyPHf3i7rgSJrF/IA’ list
</pre></div>
</div>
<p>The output should be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my</span><span class="o">-</span><span class="n">new</span><span class="o">-</span><span class="n">bucket</span>
</pre></div>
</div>
</div>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph 对象网关</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../install/install-ceph-gateway/">基于 Civetweb 手动安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frontends/">HTTP 前端</a></li>
<li class="toctree-l2"><a class="reference internal" href="../placement/">Pool Placement and Storage Classes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">基于 Apache/FastCGI 的简单配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-a-user-and-keyring">Create a User and Keyring</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">创建存储池</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ceph">为 Ceph 新增网关配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="#distribute-updated-ceph-configuration-file">Distribute updated Ceph configuration file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#copy-ceph-client-admin-keyring-from-admin-node-to-gateway-host">Copy ceph.client.admin.keyring from admin node to gateway host</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-data-directory">Create Data Directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adjust-socket-directory-permissions">Adjust Socket Directory Permissions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#change-log-file-owner">Change Log File Owner</a></li>
<li class="toctree-l3"><a class="reference internal" href="#start-radosgw-service">Start radosgw service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-gateway-configuration-file">Create a Gateway Configuration file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restart-apache">Restart Apache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-gateway">Using The Gateway</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-a-radosgw-user-for-s3-access">Create a radosgw user for S3 access</a></li>
<li class="toctree-l4"><a class="reference internal" href="#swift">创建一个 Swift 用户</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id2">访问验证</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#s3">测试 S3 访问</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-swift-access">Test swift access</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../multisite/">多站配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pools/">存储池的配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config-ref/">配置参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin/">管理指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s3/">S3 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../swift/">Swift API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../adminops/">管理操作 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/">Python 接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfs/">通过 NFS 导出</a></li>
<li class="toctree-l2"><a class="reference internal" href="../keystone/">与 OpenStack Keystone 对接</a></li>
<li class="toctree-l2"><a class="reference internal" href="../barbican/">与 OpenStack Barbican 对接</a></li>
<li class="toctree-l2"><a class="reference internal" href="../opa/">与 Open Policy Agent 对接</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multitenancy/">多租户</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compression/">压缩</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ldap-auth/">LDAP 认证</a></li>
<li class="toctree-l2"><a class="reference internal" href="../encryption/">服务器端加密</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bucketpolicy/">桶策略</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dynamicresharding/">动态的桶索引重分片</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mfa/">多因子认证</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sync-modules/">同步模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/">RADOS 中的数据布局</a></li>
<li class="toctree-l2"><a class="reference internal" href="../STSLite/">STS Lite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../role/">Role</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/">故障排除</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/radosgw/">radosgw 手册页</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/radosgw-admin/">radosgw-admin 手册页</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../multisite/" title="多站"
             >next</a> |</li>
        <li class="right" >
          <a href="../placement/" title="Pool Placement and Storage Classes"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph 对象网关</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>