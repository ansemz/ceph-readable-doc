
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Snapshots &mdash; Ceph Documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Ceph Documentation" href="../../" />
    <link rel="up" title="Ceph Block Device" href="../rbd/" />
    <link rel="next" title="RBD Mirroring" href="../rbd-mirroring/" />
    <link rel="prev" title="Kernel Module Operations" href="../rbd-ko/" />
    <script type="text/javascript" src="http://ayni.ceph.com/public/js/ceph.js"></script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../rbd-mirroring/" title="RBD Mirroring"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../rbd-ko/" title="Kernel Module Operations"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li>
          <li><a href="../rbd/" accesskey="U">Ceph Block Device</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="snapshots">
<h1>Snapshots<a class="headerlink" href="#snapshots" title="Permalink to this headline">¶</a></h1>
<p id="index-0">A snapshot is a read-only copy of the state of an image at a particular point in
time. One of the advanced features of Ceph block devices is that you can create
snapshots of the images to retain a history of an image&#8217;s state. Ceph also
supports snapshot layering, which allows you to clone images (e.g., a VM image)
quickly and easily. Ceph supports block device snapshots using the <tt class="docutils literal"><span class="pre">rbd</span></tt>
command and many higher level interfaces, including <a class="reference external" href="../qemu-rbd/">QEMU</a>, <a class="reference external" href="../libvirt/">libvirt</a>,
<a class="reference external" href="../rbd-openstack/">OpenStack</a> and <a class="reference external" href="../rbd-cloudstack/">CloudStack</a>.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">To use use RBD snapshots, you must have a running Ceph cluster.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If a snapshot is taken while <cite>I/O</cite> is still in progress in a image, the
snapshot might not get the exact or latest data of the image and the snapshot
may have to be cloned to a new image to be mountable. So, we recommend to stop
<cite>I/O</cite> before taking a snapshot of an image. If the image contains a filesystem,
the filesystem must be in a consistent state before taking a snapshot. To stop
<cite>I/O</cite> you can use <cite>fsfreeze</cite> command. See <cite>fsfreeze(8)</cite> man page for more details.
For virtual machines, <cite>qemu-guest-agent</cite> can be used to automatically freeze
filesystems when creating a snapshot.</p>
</div>
<p class="ditaa">
<img src="../../_images/ditaa-75fdb48a3db2bad6ef749fdae1282f4ae2dd1f7c.png"/>
</p>
<div class="section" id="cephx-notes">
<h2>Cephx Notes<a class="headerlink" href="#cephx-notes" title="Permalink to this headline">¶</a></h2>
<p>When <a class="reference external" href="../../rados/configuration/auth-config-ref/">cephx</a> is enabled (it is by default), you must specify a user name or ID
and a path to the keyring containing the corresponding key for the user. See
<a class="reference external" href="../../operations/user-management">User Management</a> for details. You may also add the <tt class="docutils literal"><span class="pre">CEPH_ARGS</span></tt> environment
variable to avoid re-entry of the following parameters.</p>
<div class="highlight-python"><pre>rbd --id {user-ID} --keyring=/path/to/secret [commands]
rbd --name {username} --keyring=/path/to/secret [commands]</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd --id admin --keyring=/etc/ceph/ceph.keyring [commands]
rbd --name client.admin --keyring=/etc/ceph/ceph.keyring [commands]</pre>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Add the user and secret to the <tt class="docutils literal"><span class="pre">CEPH_ARGS</span></tt> environment
variable so that you don&#8217;t need to enter them each time.</p>
</div>
</div>
<div class="section" id="snapshot-basics">
<h2>Snapshot Basics<a class="headerlink" href="#snapshot-basics" title="Permalink to this headline">¶</a></h2>
<p>The following procedures demonstrate how to create, list, and remove
snapshots using the <tt class="docutils literal"><span class="pre">rbd</span></tt> command on the command line.</p>
<div class="section" id="create-snapshot">
<h3>Create Snapshot<a class="headerlink" href="#create-snapshot" title="Permalink to this headline">¶</a></h3>
<p>To create a snapshot with <tt class="docutils literal"><span class="pre">rbd</span></tt>, specify the <tt class="docutils literal"><span class="pre">snap</span> <span class="pre">create</span></tt> option,  the pool
name and the image name.</p>
<div class="highlight-python"><pre>rbd snap create {pool-name}/{image-name}@{snap-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd snap create rbd/foo@snapname</pre>
</div>
</div>
<div class="section" id="list-snapshots">
<h3>List Snapshots<a class="headerlink" href="#list-snapshots" title="Permalink to this headline">¶</a></h3>
<p>To list snapshots of an image, specify the pool name and the image name.</p>
<div class="highlight-python"><pre>rbd snap ls {pool-name}/{image-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd snap ls rbd/foo</pre>
</div>
</div>
<div class="section" id="rollback-snapshot">
<h3>Rollback Snapshot<a class="headerlink" href="#rollback-snapshot" title="Permalink to this headline">¶</a></h3>
<p>To rollback to a snapshot with <tt class="docutils literal"><span class="pre">rbd</span></tt>, specify the <tt class="docutils literal"><span class="pre">snap</span> <span class="pre">rollback</span></tt> option, the
pool name, the image name and the snap name.</p>
<div class="highlight-python"><pre>rbd snap rollback {pool-name}/{image-name}@{snap-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd snap rollback rbd/foo@snapname</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Rolling back an image to a snapshot means overwriting
the current version of the image with data from a snapshot. The
time it takes to execute a rollback increases with the size of the
image. It is <strong>faster to clone</strong> from a snapshot <strong>than to rollback</strong>
an image to a snapshot, and it is the preferred method of returning
to a pre-existing state.</p>
</div>
</div>
<div class="section" id="delete-a-snapshot">
<h3>Delete a Snapshot<a class="headerlink" href="#delete-a-snapshot" title="Permalink to this headline">¶</a></h3>
<p>To delete a snapshot with <tt class="docutils literal"><span class="pre">rbd</span></tt>, specify the <tt class="docutils literal"><span class="pre">snap</span> <span class="pre">rm</span></tt> option, the pool
name, the image name and the snap name.</p>
<div class="highlight-python"><pre>rbd snap rm {pool-name}/{image-name}@{snap-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd snap rm rbd/foo@snapname</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ceph OSDs delete data asynchronously, so deleting a snapshot
doesn&#8217;t free up the disk space immediately.</p>
</div>
</div>
<div class="section" id="purge-snapshots">
<h3>Purge Snapshots<a class="headerlink" href="#purge-snapshots" title="Permalink to this headline">¶</a></h3>
<p>To delete all snapshots for an image with <tt class="docutils literal"><span class="pre">rbd</span></tt>, specify the <tt class="docutils literal"><span class="pre">snap</span> <span class="pre">purge</span></tt>
option and the image name.</p>
<div class="highlight-python"><pre>rbd snap purge {pool-name}/{image-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd snap purge rbd/foo</pre>
</div>
</div>
</div>
<div class="section" id="layering">
<span id="index-1"></span><h2>Layering<a class="headerlink" href="#layering" title="Permalink to this headline">¶</a></h2>
<p>Ceph supports the ability to create many copy-on-write (COW) clones of a block
device shapshot. Snapshot layering enables Ceph block device clients to create
images very quickly. For example, you might create a block device image with a
Linux VM written to it; then, snapshot the image, protect the snapshot, and
create as many copy-on-write clones as you like. A snapshot is read-only,
so cloning a snapshot simplifies semantics&#8211;making it possible to create
clones rapidly.</p>
<p class="ditaa">
<img src="../../_images/ditaa-b4c8b30123e5581e44b87f1836b96a869c4898b6.png"/>
</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The terms &#8220;parent&#8221; and &#8220;child&#8221; mean a Ceph block device snapshot (parent),
and the corresponding image cloned from the snapshot (child). These terms are
important for the command line usage below.</p>
</div>
<p>Each cloned image (child) stores a reference to its parent image, which enables
the cloned image to open the parent snapshot and read it.</p>
<p>A COW clone of a snapshot behaves exactly like any other Ceph block device
image. You can read to, write from, clone, and resize cloned images. There are
no special restrictions with cloned images. However, the copy-on-write clone of
a snapshot refers to the snapshot, so you <strong>MUST</strong> protect the snapshot before
you clone it. The following diagram depicts the process.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ceph only supports cloning for format 2 images (i.e., created with
<tt class="docutils literal"><span class="pre">rbd</span> <span class="pre">create</span> <span class="pre">--image-format</span> <span class="pre">2</span></tt>).  The kernel client supports cloned images
since kernel 3.10.</p>
</div>
<div class="section" id="getting-started-with-layering">
<h3>Getting Started with Layering<a class="headerlink" href="#getting-started-with-layering" title="Permalink to this headline">¶</a></h3>
<p>Ceph block device layering is a simple process. You must have an image. You must
create a snapshot of the image. You must protect the snapshot. Once you have
performed these steps, you can begin cloning the snapshot.</p>
<p class="ditaa">
<img src="../../_images/ditaa-bbd86247e30fd4ca83550176ab1bf5a39ab46c6d.png"/>
</p>
<p>The cloned image has a reference to the parent snapshot, and includes the pool
ID,  image ID and snapshot ID. The inclusion of the pool ID means that you may
clone snapshots  from one pool to images in another pool.</p>
<ol class="arabic simple">
<li><strong>Image Template:</strong> A common use case for block device layering is to create a
a master image and a snapshot that serves as a template for clones. For example,
a user may create an image for a Linux distribution (e.g., Ubuntu 12.04), and
create a snapshot for it. Periodically, the user may update the image and create
a new snapshot (e.g., <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">update</span></tt>, <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">upgrade</span></tt>,
<tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">dist-upgrade</span></tt> followed by <tt class="docutils literal"><span class="pre">rbd</span> <span class="pre">snap</span> <span class="pre">create</span></tt>). As the image
matures, the user can clone any one of the snapshots.</li>
<li><strong>Extended Template:</strong> A more advanced use case includes extending a template
image that provides more information than a base image. For example, a user may
clone an image (e.g., a VM template) and install other software (e.g., a database,
a content management system, an analytics system, etc.) and then snapshot the
extended image, which itself may be updated just like the base image.</li>
<li><strong>Template Pool:</strong> One way to use block device layering is to create a
pool that contains master images that act as templates, and snapshots of those
templates. You may then extend read-only privileges to users so that they
may clone the snapshots without the ability to write or execute within the pool.</li>
<li><strong>Image Migration/Recovery:</strong> One way to use block device layering is to migrate
or recover data from one pool into another pool.</li>
</ol>
</div>
<div class="section" id="protecting-a-snapshot">
<h3>Protecting a Snapshot<a class="headerlink" href="#protecting-a-snapshot" title="Permalink to this headline">¶</a></h3>
<p>Clones access the parent snapshots. All clones would break if a user inadvertently
deleted the parent snapshot. To prevent data loss, you <strong>MUST</strong> protect the
snapshot before you can clone it.</p>
<div class="highlight-python"><pre>rbd snap protect {pool-name}/{image-name}@{snapshot-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd snap protect rbd/my-image@my-snapshot</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You cannot delete a protected snapshot.</p>
</div>
</div>
<div class="section" id="cloning-a-snapshot">
<h3>Cloning a Snapshot<a class="headerlink" href="#cloning-a-snapshot" title="Permalink to this headline">¶</a></h3>
<p>To clone a snapshot, specify you need to specify the parent pool, image and
snapshot; and, the child pool and image name. You must protect the snapshot
before  you can clone it.</p>
<div class="highlight-python"><pre>rbd clone {pool-name}/{parent-image}@{snap-name} {pool-name}/{child-image-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd clone rbd/my-image@my-snapshot rbd/new-image</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You may clone a snapshot from one pool to an image in another pool. For example,
you may maintain read-only images and snapshots as templates in one pool, and writeable
clones in another pool.</p>
</div>
</div>
<div class="section" id="unprotecting-a-snapshot">
<h3>Unprotecting a Snapshot<a class="headerlink" href="#unprotecting-a-snapshot" title="Permalink to this headline">¶</a></h3>
<p>Before you can delete a snapshot, you must unprotect it first. Additionally,
you may <em>NOT</em> delete snapshots that have references from clones. You must
flatten each clone of a snapshot, before you can delete the snapshot.</p>
<div class="highlight-python"><pre>rbd snap unprotect {pool-name}/{image-name}@{snapshot-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd snap unprotect rbd/my-image@my-snapshot</pre>
</div>
</div>
<div class="section" id="listing-children-of-a-snapshot">
<h3>Listing Children of a Snapshot<a class="headerlink" href="#listing-children-of-a-snapshot" title="Permalink to this headline">¶</a></h3>
<p>To list the children of a snapshot, execute the following:</p>
<div class="highlight-python"><pre>rbd children {pool-name}/{image-name}@{snapshot-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd children rbd/my-image@my-snapshot</pre>
</div>
</div>
<div class="section" id="flattening-a-cloned-image">
<h3>Flattening a Cloned Image<a class="headerlink" href="#flattening-a-cloned-image" title="Permalink to this headline">¶</a></h3>
<p>Cloned images retain a reference to the parent snapshot. When you remove the
reference from the child clone to the parent snapshot, you effectively &#8220;flatten&#8221;
the image by copying the information from the snapshot to the clone. The time
it takes to flatten a clone increases with the size of the snapshot. To delete
a snapshot, you must flatten the child images first.</p>
<div class="highlight-python"><pre>rbd flatten {pool-name}/{image-name}</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>rbd flatten rbd/my-image</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since a flattened image contains all the information from the snapshot,
a flattened image will take up more storage space than a layered clone.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/">Installation (Quick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installation (Manual)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph Filesystem</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../rbd/">Ceph Block Device</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../rados-rbd-cmds/">Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-ko/">Kernel Modules</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Snapshots</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cephx-notes">Cephx Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#snapshot-basics">Snapshot Basics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-snapshot">Create Snapshot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#list-snapshots">List Snapshots</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rollback-snapshot">Rollback Snapshot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#delete-a-snapshot">Delete a Snapshot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#purge-snapshots">Purge Snapshots</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#layering">Layering</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#getting-started-with-layering">Getting Started with Layering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#protecting-a-snapshot">Protecting a Snapshot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cloning-a-snapshot">Cloning a Snapshot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unprotecting-a-snapshot">Unprotecting a Snapshot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#listing-children-of-a-snapshot">Listing Children of a Snapshot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flattening-a-cloned-image">Flattening a Cloned Image</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-mirroring/">Mirroring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qemu-rbd/">QEMU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libvirt/">libvirt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-config-ref/">Cache Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-openstack/">OpenStack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-cloudstack/">CloudStack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/rbd/">Manpage rbd</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/rbd-fuse/">Manpage rbd-fuse</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/rbd-nbd/">Manpage rbd-nbd</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/ceph-rbdnamer/">Manpage ceph-rbdnamer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-replay/">RBD Replay</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/rbd-replay-prep/">Manpage rbd-replay-prep</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/rbd-replay/">Manpage rbd-replay</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/rbd-replay-many/">Manpage rbd-replay-many</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/rbdmap/">Manpage rbdmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../librbdpy/">librbd</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../rbd-mirroring/" title="RBD Mirroring"
             >next</a> |</li>
        <li class="right" >
          <a href="../rbd-ko/" title="Kernel Module Operations"
             >previous</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li>
          <li><a href="../rbd/" >Ceph Block Device</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Red Hat, Inc, and contributors. Licensed under Creative Commons BY-SA.
    </div>
  </body>
</html>