
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ceph-mgr orchestrator 模块 &#8212; Ceph Documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Ceph 仪表盘" href="../dashboard/" />
    <link rel="prev" title="ceph-mgr 模块开发指南" href="../modules/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../dashboard/" title="Ceph 仪表盘"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../modules/" title="ceph-mgr 模块开发指南"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Ceph 管理器守护进程</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            

<div id="dev-warning" class="admonition note" style="display:none;">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>

<div id="eol-warning" class="admonition warning" style="display:none;">
  <p class="first admonition-title">Warning</p>
  <p class="last">This document is for an unsupported version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="display:none; padding: 15px; font-weight: bold;">
    <a id="edit-on-github" href="https://github.com/ceph/ceph/edit/master/doc/mgr/orchestrator_modules.rst" rel="nofollow">Edit on GitHub</a> | <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <div class="section" id="ceph-mgr-orchestrator">
<span id="orchestrator-modules"></span><h1>ceph-mgr orchestrator 模块<a class="headerlink" href="#ceph-mgr-orchestrator" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>这是开发者文档，描述的是 Ceph 内部机制，仅适用于编写
ceph-mgr orchestrator 模块的人们。</p>
</div>
<p>In this context, <em>orchestrator</em> refers to some external service that
provides the ability to discover devices and create Ceph services.  This
includes external projects such as ceph-ansible, DeepSea, and Rook.</p>
<p>An <em>orchestrator module</em> is a ceph-mgr module (<a class="reference internal" href="../modules/#mgr-module-dev"><span class="std std-ref">ceph-mgr 模块开发指南</span></a>)
which implements common management operations using a particular
orchestrator.</p>
<p>Orchestrator modules subclass the <code class="docutils literal notranslate"><span class="pre">Orchestrator</span></code> class: this class is
an interface, it only provides method definitions to be implemented
by subclasses.  The purpose of defining this common interface
for different orchestrators is to enable common UI code, such as
the dashboard, to work with various different backends.</p>
<div class="graphviz"><object data="../../_images/graphviz-01b439e673e075fe481154e92bd10b86897ecd6f.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph G {
    subgraph cluster_1 {
        volumes [label=&quot;mgr/volumes&quot;]
        rook [label=&quot;mgr/rook&quot;]
        dashboard [label=&quot;mgr/dashboard&quot;]
        orchestrator_cli [label=&quot;mgr/orchestrator&quot;]
        orchestrator [label=&quot;Orchestrator Interface&quot;]
        cephadm [label=&quot;mgr/cephadm&quot;]

        label = &quot;ceph-mgr&quot;;
    }

    volumes -&gt; orchestrator
    dashboard -&gt; orchestrator
    orchestrator_cli -&gt; orchestrator
    orchestrator -&gt; rook -&gt; rook_io
    orchestrator -&gt; cephadm


    rook_io [label=&quot;Rook&quot;]

    rankdir=&quot;TB&quot;;
}</p></object></div>
<p>Behind all the abstraction, the purpose of orchestrator modules is simple:
enable Ceph to do things like discover available hardware, create and
destroy OSDs, and run MDS and RGW services.</p>
<p>A tutorial is not included here: for full and concrete examples, see
the existing implemented orchestrator modules in the Ceph source tree.</p>
<div class="section" id="id1">
<h2>术语<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>Stateful service</dt><dd><p>a daemon that uses local storage, such as OSD or mon.</p>
</dd>
<dt>Stateless service</dt><dd><p>a daemon that doesn’t use any local storage, such
as an MDS, RGW, nfs-ganesha, iSCSI gateway.</p>
</dd>
<dt>Label</dt><dd><p>arbitrary string tags that may be applied by administrators
to nodes.  Typically administrators use labels to indicate
which nodes should run which kinds of service.  Labels are
advisory (from human input) and do not guarantee that nodes
have particular physical capabilities.</p>
</dd>
<dt>Drive group</dt><dd><p>collection of block devices with common/shared OSD
formatting (typically one or more SSDs acting as
journals/dbs for a group of HDDs).</p>
</dd>
<dt>Placement</dt><dd><p>choice of which node is used to run a service.</p>
</dd>
</dl>
</div>
<div class="section" id="id2">
<h2>关键概念<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>The underlying orchestrator remains the source of truth for information
about whether a service is running, what is running where, which
nodes are available, etc.  Orchestrator modules should avoid taking
any internal copies of this information, and read it directly from
the orchestrator backend as much as possible.</p>
<p>Bootstrapping nodes and adding them to the underlying orchestration
system is outside the scope of Ceph’s orchestrator interface.  Ceph
can only work on nodes when the orchestrator is already aware of them.</p>
<p>Calls to orchestrator modules are all asynchronous, and return <em>completion</em>
objects (see below) rather than returning values immediately.</p>
<p>Where possible, placement of stateless services should be left up to the
orchestrator.</p>
</div>
<div class="section" id="completions-and-batching">
<h2>Completions and batching<a class="headerlink" href="#completions-and-batching" title="Permalink to this headline">¶</a></h2>
<p>All methods that read or modify the state of the system can potentially
be long running.  To handle that, all such methods return a <em>Completion</em>
object.  Orchestrator modules
must implement the <em>process</em> method: this takes a list of completions, and
is responsible for checking if they’re finished, and advancing the underlying
operations as needed.</p>
<p>Each orchestrator module implements its own underlying mechanisms
for completions.  This might involve running the underlying operations
in threads, or batching the operations up before later executing
in one go in the background.  If implementing such a batching pattern, the
module would do no work on any operation until it appeared in a list
of completions passed into <em>process</em>.</p>
<p>Some operations need to show a progress. Those operations need to add
a <em>ProgressReference</em> to the completion. At some point, the progress reference
becomes <em>effective</em>, meaning that the operation has really happened
(e.g. a service has actually been started).</p>
</div>
<div class="section" id="id3">
<h2>错误处理<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>The main goal of error handling within orchestrator modules is to provide debug information to
assist users when dealing with deployment errors.</p>
<p>In detail, orchestrators need to explicitly deal with different kinds of errors:</p>
<ol class="arabic">
<li><p>No orchestrator configured</p>
<p>See <code class="xref py py-class docutils literal notranslate"><span class="pre">NoOrchestrator</span></code>.</p>
</li>
<li><p>An orchestrator doesn’t implement a specific method.</p>
<p>For example, an Orchestrator doesn’t support <code class="docutils literal notranslate"><span class="pre">add_host</span></code>.</p>
<p>In this case, a <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code> is raised.</p>
</li>
<li><p>Missing features within implemented methods.</p>
<p>E.g. optional parameters to a command that are not supported by the
backend (e.g. the hosts field in <code class="xref py py-func docutils literal notranslate"><span class="pre">Orchestrator.update_mons()</span></code> command with the rook backend).</p>
<p>See <code class="xref py py-class docutils literal notranslate"><span class="pre">OrchestratorValidationError</span></code>.</p>
</li>
<li><p>Input validation errors</p>
<p>The <code class="docutils literal notranslate"><span class="pre">orchestrator_cli</span></code> module and other calling modules are supposed to
provide meaningful error messages.</p>
<p>See <code class="xref py py-class docutils literal notranslate"><span class="pre">OrchestratorValidationError</span></code>.</p>
</li>
<li><p>Errors when actually executing commands</p>
<p>The resulting Completion should contain an error string that assists in understanding the
problem. In addition, <code class="xref py py-func docutils literal notranslate"><span class="pre">_Completion.is_errored()</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code></p>
</li>
<li><p>Invalid configuration in the orchestrator modules</p>
<p>This can be tackled similar to 5.</p>
</li>
</ol>
<p>All other errors are unexpected orchestrator issues and thus should raise an exception that are then
logged into the mgr log file. If there is a completion object at that point,
<code class="xref py py-func docutils literal notranslate"><span class="pre">_Completion.result()</span></code> may contain an error message.</p>
</div>
<div class="section" id="id4">
<h2>排除的功能<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Ceph’s orchestrator interface is not a general purpose framework for
managing linux servers – it is deliberately constrained to manage
the Ceph cluster’s services only.</p></li>
<li><p>Multipathed storage is not handled (multipathing is unnecessary for
Ceph clusters).  Each drive is assumed to be visible only on
a single node.</p></li>
</ul>
</div>
<div class="section" id="id5">
<h2>主机管理<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id6">
<h2>设备<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="ceph.deployment.inventory.Devices">
<em class="property">class </em><code class="sig-prename descclassname">ceph.deployment.inventory.</code><code class="sig-name descname">Devices</code><span class="sig-paren">(</span><em class="sig-param">devices</em><span class="sig-paren">)</span><a class="headerlink" href="#ceph.deployment.inventory.Devices" title="Permalink to this definition">¶</a></dt>
<dd><p>A container for Device instances with reporting</p>
</dd></dl>

<dl class="class">
<dt id="ceph.deployment.inventory.Device">
<em class="property">class </em><code class="sig-prename descclassname">ceph.deployment.inventory.</code><code class="sig-name descname">Device</code><span class="sig-paren">(</span><em class="sig-param">path</em>, <em class="sig-param">sys_api=None</em>, <em class="sig-param">available=None</em>, <em class="sig-param">rejected_reasons=None</em>, <em class="sig-param">lvs=None</em>, <em class="sig-param">device_id=None</em><span class="sig-paren">)</span><a class="headerlink" href="#ceph.deployment.inventory.Device" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="placement">
<h2>Placement<a class="headerlink" href="#placement" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="../orchestrator/#orchestrator-cli-placement-spec"><span class="std std-ref">Placement Specification</span></a> defines the placement of
daemons of a specifc service.</p>
<p>In general, stateless services do not require any specific placement
rules as they can run anywhere that sufficient system resources
are available. However, some orchestrators may not include the
functionality to choose a location in this way. Optionally, you can
specify a location when creating a stateless service.</p>
</div>
<div class="section" id="id7">
<h2>服务<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id8">
<h2>守护进程<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="osd">
<h2>OSD 管理<a class="headerlink" href="#osd" title="Permalink to this headline">¶</a></h2>
<div class="section" id="orchestrator-osd-replace">
<span id="id9"></span><h3>OSD 替换<a class="headerlink" href="#orchestrator-osd-replace" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="../../rados/operations/add-or-rm-osds/#rados-replacing-an-osd"><span class="std std-ref">替换一个 OSD</span></a> for the underlying process.</p>
<p>Replacing OSDs is fundamentally a two-staged process, as users need to
physically replace drives. The orchestrator therefor exposes this two-staged process.</p>
<p>Phase one is a call to <code class="xref py py-meth docutils literal notranslate"><span class="pre">Orchestrator.remove_osds()</span></code> with <code class="docutils literal notranslate"><span class="pre">destroy=True</span></code> in order to mark
the OSD as destroyed.</p>
<p>Phase two is a call to  <code class="xref py py-meth docutils literal notranslate"><span class="pre">Orchestrator.create_osds()</span></code> with a Drive Group with</p>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">DriveGroupSpec.osd_id_claims</span></code> set to the destroyed OSD ids.</p>
</div>
</div>
<div class="section" id="id10">
<h2>监视器<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id11">
<h2>无状态服务<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id12">
<h2>升级<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id13">
<h2>工具<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id14">
<h2>客户端模块<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/">安装（ ceph-deploy ）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装（手动）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/kube-helm/">安装（ Kubernetes + Helm ）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph 管理器守护进程</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../administrator/">安装和配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/">模块编程</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">编写 orchestrator 插件</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">术语</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">关键概念</a></li>
<li class="toctree-l3"><a class="reference internal" href="#completions-and-batching">Completions and batching</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">错误处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">排除的功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">主机管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">设备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#placement">Placement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">守护进程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#osd">OSD 管理</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#orchestrator-osd-replace">OSD 替换</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">监视器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">无状态服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">升级</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">客户端模块</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../dashboard/">仪表盘模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts/">Alerts 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../diskprediction/">DiskPrediction 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../localpool/">localpool 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../restful/">REST 风格模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zabbix/">Zabbix 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prometheus/">Prometheus 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../influx/">Influx 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hello/">Hello 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../telegraf/">Telegraf 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../telemetry/">Telemetry 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iostat/">Iostat 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crash/">Crash 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../insights/">Insights 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../orchestrator/">Orchestrator 模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rook/">Rook 模块</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../dashboard/" title="Ceph 仪表盘"
             >next</a> |</li>
        <li class="right" >
          <a href="../modules/" title="ceph-mgr 模块开发指南"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph 管理器守护进程</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>