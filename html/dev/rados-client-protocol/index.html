
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>RADOS 客户端协议 &mdash; Ceph Documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Ceph Documentation" href="../../" />
    

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="rados">
<span id="rados-client-protocol"></span><h1>RADOS 客户端协议<a class="headerlink" href="#rados" title="Permalink to this headline">¶</a></h1>
<p>This is very incomplete, but one must start somewhere.</p>
<div class="section" id="basics">
<h2>Basics<a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h2>
<p>Requests are MOSDOp messages.  Replies are MOSDOpReply messages.</p>
<p>An object request is targetted at an hobject_t, which includes a pool,
hash value, object name, placement key (usually empty), and snapid.</p>
<p>The hash value is a 32-bit hash value, normally generated by hashing
the object name.  The hobject_t can be arbitrarily constructed,
though, with any hash value and name.  Note that in the MOSDOp these
components are spread across several fields and not logically
assembled in an actual hobject_t member (mainly historical reasons).</p>
<p>A request can also target a PG.  In this case, the <em>ps</em> value matches
a specific PG, the object name is empty, and (hopefully) the ops in
the request are PG ops.</p>
<p>Either way, the request ultimately targets a PG, either by using the
explicit pgid or by folding the hash value onto the current number of
pgs in the pool.  The client sends the request to the primary for the
assocated PG.</p>
<p>Each request is assigned a unique tid.</p>
</div>
<div class="section" id="resends">
<h2>Resends<a class="headerlink" href="#resends" title="Permalink to this headline">¶</a></h2>
<p>If there is a connection drop, the client will resend any outstanding
requets.</p>
<p>Any time there is a PG mapping change such that the primary changes,
the client is responsible for resending the request.  Note that
although there may be an interval change from the OSD&#8217;s perspective
(triggering PG peering), if the primary doesn&#8217;t change then the client
need not resend.</p>
<p>There are a few exceptions to this rule:</p>
<blockquote>
<div><ul class="simple">
<li>There is a last_force_op_resend field in the pg_pool_t in the
OSDMap.  If this changes, then the clients are forced to resend any
outstanding requests. (This happens when tiering is adjusted, for
example.)</li>
<li>Some requests are such that they are resent on <em>any</em> PG interval
change, as defined by pg_interval_t&#8217;s is_new_interval() (the same
criteria used by peering in the OSD).</li>
<li>If the PAUSE OSDMap flag is set and unset.</li>
</ul>
</div></blockquote>
<p>Each time a request is sent to the OSD the <em>attempt</em> field is incremented. The
first time it is 0, the next 1, etc.</p>
</div>
<div class="section" id="backoff">
<h2>Backoff<a class="headerlink" href="#backoff" title="Permalink to this headline">¶</a></h2>
<p>Ordinarily the OSD will simply queue any requests it can&#8217;t immeidately
process in memory until such time as it can.  This can become
problematic because the OSD limits the total amount of RAM consumed by
incoming messages: if either of the thresholds for the number of
messages or the number of bytes is reached, new messages will not be
read off the network socket, causing backpressure through the network.</p>
<p>In some cases, though, the OSD knows or expects that a PG or object
will be unavailable for some time and does not want to consume memory
by queuing requests.  In these cases it can send a MOSDBackoff message
to the client.</p>
<p>A backoff request has four properties:</p>
<ol class="arabic simple">
<li>the op code (block, unblock, or ack-block)</li>
<li><em>id</em>, a unique id assigned within this session</li>
<li>hobject_t begin</li>
<li>hobject_t end</li>
</ol>
<p>There are two types of backoff: a <em>PG</em> backoff will plug all requests
targetting an entire PG at the client, as described by a range of the
hash/hobject_t space [begin,end), while an <em>object</em> backoff will plug
all requests targetting a single object (begin == end).</p>
<p>When the client receives a <em>block</em> backoff message, it is now
responsible for <em>not</em> sending any requests for hobject_ts described by
the backoff.  The backoff remains in effect until the backoff is
cleared (via an &#8216;unblock&#8217; message) or the OSD session is closed.  A
<em>ack_block</em> message is sent back to the OSD immediately to acknowledge
receipt of the backoff.</p>
<p>When an unblock is
received, it will reference a specific id that the client previous had
blocked.  However, the range described by the unblock may be smaller
than the original range, as the PG may have split on the OSD.  The unblock
should <em>only</em> unblock the range specified in the unblock message.  Any requests
that fall within the unblock request range are reexamined and, if no other
installed backoff applies, resent.</p>
<p>On the OSD, Backoffs are also tracked across ranges of the hash space, and
exist in three states:</p>
<ol class="arabic simple">
<li>new</li>
<li>acked</li>
<li>deleting</li>
</ol>
<p>A newly installed backoff is set to <em>new</em> and a message is sent to the
client.  When the <em>ack-block</em> message is received it is changed to the
<em>acked</em> state.  The OSD may process other messages from the client that
are covered by the backoff in the <em>new</em> state, but once the backoff is
<em>acked</em> it should never see a blocked request unless there is a bug.</p>
<p>If the OSD wants to a remove a backoff in the <em>acked</em> state it can
simply remove it and notify the client.  If the backoff is in the
<em>new</em> state it must move it to the <em>deleting</em> state and continue to
use it to discard client requests until the <em>ack-block</em> message is
received, at which point it can finally be removed.  This is necessary to
preserve the order of operations processed by the OSD.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/">安装（快速）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装（手动）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../">开发文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README/">中文版翻译说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation-convention/">中文版词语翻译惯例</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../">Ceph Documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Red Hat, Inc, and contributors. Licensed under Creative Commons BY-SA.
    </div>
  </body>
</html>