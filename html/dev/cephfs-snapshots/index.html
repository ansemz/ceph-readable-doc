
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>CephFS 快照 &#8212; Ceph Documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Cephx 认证协议详细阐述" href="../cephx_protocol/" />
    <link rel="prev" title="CephFS Reclaim Interface" href="../cephfs-reclaim/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../cephx_protocol/" title="Cephx 认证协议详细阐述"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../cephfs-reclaim/" title="CephFS Reclaim Interface"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../internals/" accesskey="U">Ceph 内幕</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            

<div id="dev-warning" class="admonition note" style="display:none;">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>

<div id="eol-warning" class="admonition warning" style="display:none;">
  <p class="first admonition-title">Warning</p>
  <p class="last">This document is for an unsupported version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="display:none; padding: 15px; font-weight: bold;">
    <a id="edit-on-github" href="https://github.com/ceph/ceph/edit/master/doc/dev/cephfs-snapshots.rst" rel="nofollow">Edit on GitHub</a> | <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <div class="section" id="cephfs">
<h1>CephFS 快照<a class="headerlink" href="#cephfs" title="Permalink to this headline">¶</a></h1>
<p>CephFS 支持快照，通常是在 <code class="docutils literal notranslate"><span class="pre">.snap</span></code> 目录下调用 mkdir 。注意，这是个隐藏的、特殊目录，罗列目录时不可见。</p>
<div class="section" id="id1">
<h2>概览<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Generally, snapshots do what they sound like: they create an immutable view
of the filesystem at the point in time they’re taken. There are some headline
features that make CephFS snapshots different from what you might expect:</p>
<ul class="simple">
<li><p>Arbitrary subtrees. Snapshots are created within any directory you choose,
and cover all data in the filesystem under that directory.</p></li>
<li><p>Asynchronous. If you create a snapshot, buffered data is flushed out lazily,
including from other clients. As a result, “creating” the snapshot is
very fast.</p></li>
</ul>
</div>
<div class="section" id="id2">
<h2>重要的数据结构<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>SnapRealm: A <cite>SnapRealm</cite> is created whenever you create a snapshot at a new
point in the hierarchy (or, when a snapshotted inode is move outside of its
parent snapshot). SnapRealms contain an <cite>sr_t srnode</cite>, and <cite>inodes_with_caps</cite>
that are part of the snapshot. Clients also have a SnapRealm concept that
maintains less data but is used to associate a <cite>SnapContext</cite> with each open
file for writing.</p></li>
<li><p>sr_t: An <cite>sr_t</cite> is the on-disk snapshot metadata. It is part of the containing
directory and contains sequence counters, timestamps, the list of associated
snapshot IDs, and <cite>past_parent_snaps</cite>.</p></li>
<li><p>SnapServer: SnapServer manages snapshot ID allocation, snapshot deletion and
tracks list of effective snapshots in the file system. A file system only has
one instance of snapserver.</p></li>
<li><p>SnapClient: SnapClient is used to communicate with snapserver, each MDS rank
has its own snapclient instance. SnapClient also caches effective snapshots
locally.</p></li>
</ul>
</div>
<div class="section" id="id3">
<h2>创建快照<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>CephFS 的快照功能在新文件系统上是默认启用的，要在现有文件系统上启用，用以下命令。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph fs set &lt;fs_name&gt; allow_new_snaps true
</pre></div>
</div>
<p>When snapshots are enabled, all directories in CephFS will have a special
<code class="docutils literal notranslate"><span class="pre">.snap</span></code> directory. (You may configure a different name with the <code class="docutils literal notranslate"><span class="pre">client</span>
<span class="pre">snapdir</span></code> setting if you wish.)</p>
<p>To create a CephFS snapshot, create a subdirectory under
<code class="docutils literal notranslate"><span class="pre">.snap</span></code> with a name of your choice. For example, to create a snapshot on
directory “/1/2/3/”, invoke <code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">/1/2/3/.snap/my-snapshot-name</span></code> .</p>
<p>This is transmitted to the MDS Server as a
CEPH_MDS_OP_MKSNAP-tagged <cite>MClientRequest</cite>, and initially handled in
Server::handle_client_mksnap(). It allocates a <cite>snapid</cite> from the <cite>SnapServer</cite>,
projects a new inode with the new SnapRealm, and commits it to the MDLog as
usual. When committed, it invokes
<cite>MDCache::do_realm_invalidate_and_update_notify()</cite>, which notifies all clients
with caps on files under “/1/2/3/”, about the new SnapRealm. When clients get
the notifications, they update client-side SnapRealm hierarchy, link files
under “/1/2/3/” to the new SnapRealm and generate a <cite>SnapContext</cite> for the
new SnapRealm.</p>
<p>Note that this <em>is not</em> a synchronous part of the snapshot creation!</p>
</div>
<div class="section" id="id4">
<h2>更新快照<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>If you delete a snapshot, a similar process is followed. If you remove an inode
out of its parent SnapRealm, the rename code creates a new SnapRealm for the
renamed inode (if SnapRealm does not already exist), saves IDs of snapshots that
are effective on the original parent SnapRealm into <cite>past_parent_snaps</cite> of the
new SnapRealm, then follows a process similar to creating snapshot.</p>
</div>
<div class="section" id="snapcontext">
<h2>生成 SnapContext<a class="headerlink" href="#snapcontext" title="Permalink to this headline">¶</a></h2>
<p>A RADOS <cite>SnapContext</cite> consists of a snapshot sequence ID (<cite>snapid</cite>) and all
the snapshot IDs that an object is already part of. To generate that list, we
combine <cite>snapids</cite> associated with the SnapRealm and all valid <cite>snapids</cite> in
<cite>past_parent_snaps</cite>. Stale <cite>snapids</cite> are filtered out by SnapClient’s cached
effective snapshots.</p>
</div>
<div class="section" id="id5">
<h2>存入快照数据<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>File data is stored in RADOS “self-managed” snapshots. Clients are careful to
use the correct <cite>SnapContext</cite> when writing file data to the OSDs.</p>
</div>
<div class="section" id="id6">
<h2>存入快照元数据<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>Snapshotted dentries (and their inodes) are stored in-line as part of the
directory they were in at the time of the snapshot. <em>All dentries</em> include a
<cite>first</cite> and <cite>last</cite> snapid for which they are valid. (Non-snapshotted dentries
will have their <cite>last</cite> set to CEPH_NOSNAP).</p>
</div>
<div class="section" id="id7">
<h2>快照回写<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>There is a great deal of code to handle writeback efficiently. When a Client
receives an <cite>MClientSnap</cite> message, it updates the local <cite>SnapRealm</cite>
representation and its links to specific <cite>Inodes</cite>, and generates a <cite>CapSnap</cite>
for the <cite>Inode</cite>. The <cite>CapSnap</cite> is flushed out as part of capability writeback,
and if there is dirty data the <cite>CapSnap</cite> is used to block fresh data writes
until the snapshot is completely flushed to the OSDs.</p>
<p>In the MDS, we generate snapshot-representing dentries as part of the regular
process for flushing them. Dentries with outstanding <cite>CapSnap</cite> data is kept
pinned and in the journal.</p>
</div>
<div class="section" id="id8">
<h2>删除快照<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>Snapshots are deleted by invoking “rmdir” on the “.snaps” directory they are
rooted in. (Attempts to delete a directory which roots snapshots <em>will fail</em>;
you must delete the snapshots first.) Once deleted, they are entered into the
<cite>OSDMap</cite> list of deleted snapshots and the file data is removed by the OSDs.
Metadata is cleaned up as the directory objects are read in and written back
out again.</p>
</div>
<div class="section" id="id9">
<h2>硬链接<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>Inode with multiple hard links is moved to a dummy global SnapRealm. The
dummy SnapRealm covers all snapshots in the file system. The inode’s data
will be preserved for any new snapshot. These preserved data will cover
snapshots on any linkage of the inode.</p>
</div>
<div class="section" id="id10">
<h2>多文件系统情况<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>Snapshots and multiiple filesystems don’t interact well. Specifically, each
MDS cluster allocates <cite>snapids</cite> independently; if you have multiple filesystems
sharing a single pool (via namespaces), their snapshots <em>will</em> collide and
deleting one will result in missing file data for others. (This may even be
invisible, not throwing errors to the user.) If each FS gets its own
pool things probably work, but this isn’t tested and may not be true.</p>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/">开发者指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../internals/">Ceph 内幕</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../blkin/">用 Blkin 追踪 Ceph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bluestore/">BlueStore Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cache-pool/">Cache pool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cephfs-reclaim/">CephFS Reclaim Interface</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">CephFS 快照</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">概览</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">重要的数据结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">创建快照</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">更新快照</a></li>
<li class="toctree-l3"><a class="reference internal" href="#snapcontext">生成 SnapContext</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">存入快照数据</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">存入快照元数据</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">快照回写</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">删除快照</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">硬链接</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">多文件系统情况</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cephx_protocol/">Cephx 认证协议详细阐述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config/">配置管理系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config-key/">config-key layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../context/">CephContext</a></li>
<li class="toctree-l2"><a class="reference internal" href="../corpus/">资料库结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpu-profiler/">Oprofile 的安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cxx/">C++17 and libstdc++ ABI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../delayed-delete/">CephFS delayed deletion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev_cluster_deployement/">开发集群的部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev_cluster_deployement/#id6">在同一机器上部署多套开发集群</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development-workflow/">开发流程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../documenting/">为 Ceph 写作文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../encoding/">序列化（编码、解码）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../erasure-coded-pool/">纠删码存储池</a></li>
<li class="toctree-l2"><a class="reference internal" href="../file-striping/">File striping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../freebsd/">FreeBSD Implementation details</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generatedocs/">Ceph 文档的构建</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iana/">IANA 号</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel-client-troubleshooting/">Kernel client troubleshooting (FS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kubernetes/">Hacking on Ceph in Kubernetes with Rook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libs/">Library architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/">集群日志的用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logs/">调试日志</a></li>
<li class="toctree-l2"><a class="reference internal" href="../macos/">在 MacOS 上构建</a></li>
<li class="toctree-l2"><a class="reference internal" href="../messenger/">Messenger notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mon-bootstrap/">Monitor bootstrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mon-on-disk-formats/">ON-DISK FORMAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mon-osdmap-prune/">FULL OSDMAP VERSION PRUNING</a></li>
<li class="toctree-l2"><a class="reference internal" href="../msgr2/">msgr2 协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network-encoding/">Network Encoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network-protocol/">网络协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../object-store/">对象存储架构概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../osd-class-path/">OSD class path issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../peering/">互联</a></li>
<li class="toctree-l2"><a class="reference internal" href="../perf/">Using perf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../perf_counters/">性能计数器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../perf_histograms/">Perf histograms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../placement-group/">PG （归置组）说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quick_guide/">开发者指南（快速）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rados-client-protocol/">RADOS 客户端协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-diff/">RBD 增量备份</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-export/">RBD Export &amp; Import</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-layering/">RBD Layering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release-process/">Ceph Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../seastore/">SeaStore</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sepia/">Sepia 社区测试实验室</a></li>
<li class="toctree-l2"><a class="reference internal" href="../session_authentication/">Session Authentication for the Cephx Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/">测试笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versions/">Public OSD Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wireshark/">Wireshark Dissector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../osd_internals/">OSD 开发者文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mds_internals/">MDS 开发者文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../radosgw/">RADOS 网关开发者文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ceph-volume/">ceph-volume 开发者文档</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../cephx_protocol/" title="Cephx 认证协议详细阐述"
             >next</a> |</li>
        <li class="right" >
          <a href="../cephfs-reclaim/" title="CephFS Reclaim Interface"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../internals/" >Ceph 内幕</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>