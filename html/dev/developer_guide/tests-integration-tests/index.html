

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>测试 - 集成测试 &mdash; Ceph Documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="next" title="运行单元测试" href="../running-tests-locally/" />
    <link rel="prev" title="测试 - 单元测试" href="../tests-unit-tests/" /> 
</head>

<body class="wy-body-for-nav">

   
  <header class="top-bar">
    

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../">向 Ceph 贡献：开发者指南</a> &raquo;</li>
        
      <li>测试 - 集成测试</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/dev/developer_guide/tests-integration-tests.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
  </header>
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #eee" >
          

          
            <a href="../../../">
          

          
            
            <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../start/intro/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephfs/">Ceph 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture/">体系结构</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">开发者指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../intro/">简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/">必备知识</a></li>
<li class="toctree-l2"><a class="reference internal" href="../merging/">何时、合并了什么</a></li>
<li class="toctree-l2"><a class="reference internal" href="../issue-tracker/">问题追踪器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basic-workflow/">基本工作流</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tests-unit-tests/">测试：单元测试</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">测试：集成测试</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#teuthology-consumes-packages">Teuthology consumes packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-nightlies">The Nightlies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-priority">Testing Priority</a></li>
<li class="toctree-l3"><a class="reference internal" href="#suites-inventory">Suites Inventory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#teuthology-describe-tests">teuthology-describe-tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">集成测试是如何运作的</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">如何定义集成测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reading-a-standalone-test">Reading a standalone test</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-descriptions">Test descriptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-tests-are-built-from-directories">How tests are built from directories</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#convolution-operator">Convolution operator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#concatenation-operator">Concatenation operator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#filtering-tests-by-their-description">Filtering tests by their description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reducing-the-number-of-tests">Reducing the number of tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../running-tests-locally/">在本地运行测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../running-tests-using-teuth/">用 Teuthology 运行集成测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../running-tests-in-cloud/">在云端运行测试</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../translation_cn/">中文版翻译资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../">Ceph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div id="dev-warning" class="admonition note">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="padding: 5px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <div class="section" id="id1">
<h1>测试 - 集成测试<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>Ceph has two types of tests: <a class="reference external" href="https://wiki.sepia.ceph.com/doku.php">make check</a> tests and integration tests.
When a test requires multiple machines, root access or lasts for a
longer time (for example, to simulate a realistic Ceph deployment), it
is deemed to be an integration test. Integration tests are organized into
“suites”, which are defined in the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa">ceph/qa sub-directory</a> and run with
the <code class="docutils literal notranslate"><span class="pre">teuthology-suite</span></code> command.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">teuthology-suite</span></code> command is part of the <a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a>.
In the sections that follow we attempt to provide a detailed introduction
to that framework from the perspective of a beginning Ceph developer.</p>
<div class="section" id="teuthology-consumes-packages">
<h2>Teuthology consumes packages<a class="headerlink" href="#teuthology-consumes-packages" title="Permalink to this headline">¶</a></h2>
<p>It may take some time to understand the significance of this fact, but it
is <cite>very</cite> significant. It means that automated tests can be conducted on
multiple platforms using the same packages (RPM, DEB) that can be
installed on any machine running those platforms.</p>
<p>Teuthology has a <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/distros/supported">list of platforms that it supports</a> (as
of December 2017 the list consisted of “CentOS 7.2” and “Ubuntu 16.04”).  It
expects to be provided pre-built Ceph packages for these platforms.
Teuthology deploys these platforms on machines (bare-metal or
cloud-provisioned), installs the packages on them, and deploys Ceph
clusters on them - all as called for by the test.</p>
</div>
<div class="section" id="the-nightlies">
<h2>The Nightlies<a class="headerlink" href="#the-nightlies" title="Permalink to this headline">¶</a></h2>
<p>A number of integration tests are run on a regular basis in the <a class="reference external" href="https://wiki.sepia.ceph.com/doku.php">Sepia
lab</a> against the official Ceph repositories (on the <code class="docutils literal notranslate"><span class="pre">master</span></code> development
branch and the stable branches). Traditionally, these tests are called “the
nightlies” because the Ceph core developers used to live and work in
the same time zone and from their perspective the tests were run overnight.</p>
<p>The results of the nightlies are published at <a class="reference external" href="http://pulpito.ceph.com/">http://pulpito.ceph.com/</a>. The
developer nick shows in the
test results URL and in the first column of the Pulpito dashboard.  The
results are also reported on the <a class="reference external" href="https://ceph.com/irc/">ceph-qa mailing list</a> for analysis.</p>
</div>
<div class="section" id="testing-priority">
<h2>Testing Priority<a class="headerlink" href="#testing-priority" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">teuthology-suite</span></code> command includes an almost mandatory option <code class="docutils literal notranslate"><span class="pre">-p</span> <span class="pre">&lt;N&gt;</span></code>
which specifies the priority of the jobs submitted to the queue. The lower
the value of <code class="docutils literal notranslate"><span class="pre">N</span></code>, the higher the priority. The option is almost mandatory
because the default is <code class="docutils literal notranslate"><span class="pre">1000</span></code> which matches the priority of the nightlies.
Nightlies are often half-finished and cancelled due to the volume of testing
done so your jobs may never finish. Therefore, it is common to select a
priority less than 1000.</p>
<p>Any priority may be selected when submitting jobs. But, in order to be
sensitive to the workings of other developers that also need to do testing,
the following recommendations should be followed:</p>
<ul class="simple">
<li><p><strong>Priority &lt; 10:</strong> Use this if the sky is falling and some group of tests
must be run ASAP.</p></li>
<li><p><strong>10 &lt;= Priority &lt; 50:</strong> Use this if your tests are urgent and blocking
other important development.</p></li>
<li><p><strong>50 &lt;= Priority &lt; 75:</strong> Use this if you are testing a particular
feature/fix and running fewer than about 25 jobs. This range can also be
used for urgent release testing.</p></li>
<li><p><strong>75 &lt;= Priority &lt; 100:</strong> Tech Leads will regularly schedule integration
tests with this priority to verify pull requests against master.</p></li>
<li><p><strong>100 &lt;= Priority &lt; 150:</strong> This priority is to be used for QE validation of
point releases.</p></li>
<li><p><strong>150 &lt;= Priority &lt; 200:</strong> Use this priority for 100 jobs or fewer of a
particular feature/fix that you’d like results on in a day or so.</p></li>
<li><p><strong>200 &lt;= Priority &lt; 1000:</strong> Use this priority for large test runs that can
be done over the course of a week.</p></li>
</ul>
<p>In case you don’t know how many jobs would be triggered by
<code class="docutils literal notranslate"><span class="pre">teuthology-suite</span></code> command, use <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> to get a count first and then
issue <code class="docutils literal notranslate"><span class="pre">teuthology-suite</span></code> command again, this time without <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> and
with <code class="docutils literal notranslate"><span class="pre">-p</span></code> and an appropriate number as an argument to it.</p>
</div>
<div class="section" id="suites-inventory">
<h2>Suites Inventory<a class="headerlink" href="#suites-inventory" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">suites</span></code> directory of the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa">ceph/qa sub-directory</a> contains
all the integration tests, for all the Ceph components.</p>
<dl class="simple">
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/ceph-deploy">ceph-deploy</a></dt><dd><p>install a Ceph cluster with <code class="docutils literal notranslate"><span class="pre">ceph-deploy</span></code> (<a class="reference internal" href="../../../man/8/ceph-deploy/#ceph-deploy"><span class="std std-ref">ceph-deploy man page</span></a>)</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/dummy">dummy</a></dt><dd><p>get a machine, do nothing and return success (commonly used to
verify the <a class="reference external" href="testing-integration-tests">integration testing</a> infrastructure works as expected)</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/fs">fs</a></dt><dd><p>test CephFS mounted using FUSE</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/kcephfs">kcephfs</a></dt><dd><p>test CephFS mounted using kernel</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/krbd">krbd</a></dt><dd><p>test the RBD kernel module</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/multimds">multimds</a></dt><dd><p>test CephFS with multiple MDSs</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/powercycle">powercycle</a></dt><dd><p>verify the Ceph cluster behaves when machines are powered off
and on again</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rados">rados</a></dt><dd><p>run Ceph clusters including OSDs and MONs, under various conditions of
stress</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rbd">rbd</a></dt><dd><p>run RBD tests using actual Ceph clusters, with and without qemu</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rgw">rgw</a></dt><dd><p>run RGW tests using actual Ceph clusters</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/smoke">smoke</a></dt><dd><p>run tests that exercise the Ceph API with an actual Ceph cluster</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/teuthology">teuthology</a></dt><dd><p>verify that teuthology can run integration tests, with and without OpenStack</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/upgrade">upgrade</a></dt><dd><p>for various versions of Ceph, verify that upgrades can happen
without disrupting an ongoing workload</p>
</dd>
</dl>
</div>
<div class="section" id="teuthology-describe-tests">
<h2>teuthology-describe-tests<a class="headerlink" href="#teuthology-describe-tests" title="Permalink to this headline">¶</a></h2>
<p>In February 2016, a new feature called <code class="docutils literal notranslate"><span class="pre">teuthology-describe-tests</span></code> was
added to the <a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a> to facilitate documentation and better
understanding of integration tests (<a class="reference external" href="http://article.gmane.org/gmane.comp.file-systems.ceph.devel/29287">feature announcement</a>).</p>
<p>The upshot is that tests can be documented by embedding <code class="docutils literal notranslate"><span class="pre">meta:</span></code>
annotations in the yaml files used to define the tests. The results can be
seen in the <a class="reference external" href="http://tracker.ceph.com/projects/ceph-qa-suite/wiki/">ceph-qa-suite wiki</a>.</p>
<p>Since this is a new feature, many yaml files have yet to be annotated.
Developers are encouraged to improve the documentation, in terms of both
coverage and quality.</p>
</div>
<div class="section" id="id2">
<h2>集成测试是如何运作的<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Given that - as a new Ceph developer - you will typically not have access
to the <a class="reference external" href="https://wiki.sepia.ceph.com/doku.php">Sepia lab</a>, you may rightly ask how you can run the integration
tests in your own environment.</p>
<p>One option is to set up a teuthology cluster on bare metal. Though this is
a non-trivial task, it <cite>is</cite> possible. Here are <a class="reference external" href="http://docs.ceph.com/teuthology/docs/LAB_SETUP.html">some notes</a> to get you started
if you decide to go this route.</p>
<p>If you have access to an OpenStack tenant, you have another option: the
<a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a> has an OpenStack backend, which is documented <a class="reference external" href="https://github.com/dachary/teuthology/tree/openstack#openstack-backend">here</a>.
This OpenStack backend can build packages from a given git commit or
branch, provision VMs, install the packages and run integration tests
on those VMs. This process is controlled using a tool called
<code class="docutils literal notranslate"><span class="pre">ceph-workbench</span> <span class="pre">ceph-qa-suite</span></code>. This tool also automates publishing of
test results at <a class="reference external" href="http://teuthology-logs.public.ceph.com">http://teuthology-logs.public.ceph.com</a>.</p>
<p>Running integration tests on your code contributions and publishing the
results allows reviewers to verify that changes to the code base do not
cause regressions, or to analyze test failures when they do occur.</p>
<p>Every teuthology cluster, whether bare-metal or cloud-provisioned, has a
so-called “teuthology machine” from which tests suites are triggered using the
<code class="docutils literal notranslate"><span class="pre">teuthology-suite</span></code> command.</p>
<p>A detailed and up-to-date description of each <a class="reference external" href="http://docs.ceph.com/teuthology/docs/teuthology.suite.html">teuthology-suite</a> option is
available by running the following command on the teuthology machine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite --help
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>如何定义集成测试<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Integration tests are defined by yaml files found in the <code class="docutils literal notranslate"><span class="pre">suites</span></code>
subdirectory of the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa">ceph/qa sub-directory</a> and implemented by python
code found in the <code class="docutils literal notranslate"><span class="pre">tasks</span></code> subdirectory. Some tests (“standalone tests”)
are defined in a single yaml file, while other tests are defined by a
directory tree containing yaml files that are combined, at runtime, into a
larger yaml file.</p>
</div>
<div class="section" id="reading-a-standalone-test">
<h2>Reading a standalone test<a class="headerlink" href="#reading-a-standalone-test" title="Permalink to this headline">¶</a></h2>
<p>Let us first examine a standalone test, or “singleton”.</p>
<p>Here is a commented example using the integration test
<a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/suites/rados/singleton/all/admin-socket.yaml">rados/singleton/all/admin-socket.yaml</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">roles</span><span class="p">:</span>
<span class="o">-</span> <span class="o">-</span> <span class="n">mon</span><span class="o">.</span><span class="n">a</span>
  <span class="o">-</span> <span class="n">osd</span><span class="mf">.0</span>
  <span class="o">-</span> <span class="n">osd</span><span class="mf">.1</span>
<span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">install</span><span class="p">:</span>
<span class="o">-</span> <span class="n">ceph</span><span class="p">:</span>
<span class="o">-</span> <span class="n">admin_socket</span><span class="p">:</span>
    <span class="n">osd</span><span class="mf">.0</span><span class="p">:</span>
      <span class="n">version</span><span class="p">:</span>
      <span class="n">git_version</span><span class="p">:</span>
      <span class="n">help</span><span class="p">:</span>
      <span class="n">config</span> <span class="n">show</span><span class="p">:</span>
      <span class="n">config</span> <span class="nb">set</span> <span class="n">filestore_dump_file</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">foo</span><span class="p">:</span>
      <span class="n">perf</span> <span class="n">dump</span><span class="p">:</span>
      <span class="n">perf</span> <span class="n">schema</span><span class="p">:</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">roles</span></code> array determines the composition of the cluster (how
many MONs, OSDs, etc.) on which this test is designed to run, as well
as how these roles will be distributed over the machines in the
testing cluster. In this case, there is only one element in the
top-level array: therefore, only one machine is allocated to the
test. The nested array declares that this machine shall run a MON with
id <code class="docutils literal notranslate"><span class="pre">a</span></code> (that is the <code class="docutils literal notranslate"><span class="pre">mon.a</span></code> in the list of roles) and two OSDs
(<code class="docutils literal notranslate"><span class="pre">osd.0</span></code> and <code class="docutils literal notranslate"><span class="pre">osd.1</span></code>).</p>
<p>The body of the test is in the <code class="docutils literal notranslate"><span class="pre">tasks</span></code> array: each element is
evaluated in order, causing the corresponding python file found in the
<code class="docutils literal notranslate"><span class="pre">tasks</span></code> subdirectory of the <a class="reference external" href="https://github.com/ceph/teuthology">teuthology repository</a> or
<a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa">ceph/qa sub-directory</a> to be run. “Running” in this case means calling
the <code class="docutils literal notranslate"><span class="pre">task()</span></code> function defined in that file.</p>
<p>In this case, the <a class="reference external" href="https://github.com/ceph/teuthology/blob/master/teuthology/task/install/__init__.py">install</a>
task comes first. It installs the Ceph packages on each machine (as
defined by the <code class="docutils literal notranslate"><span class="pre">roles</span></code> array). A full description of the <code class="docutils literal notranslate"><span class="pre">install</span></code>
task is <a class="reference external" href="https://github.com/ceph/teuthology/blob/master/teuthology/task/install/__init__.py">found in the python file</a>
(search for “def task”).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ceph</span></code> task, which is documented <a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/tasks/ceph.py">here</a> (again,
search for “def task”), starts OSDs and MONs (and possibly MDSs as well)
as required by the <code class="docutils literal notranslate"><span class="pre">roles</span></code> array. In this example, it will start one MON
(<code class="docutils literal notranslate"><span class="pre">mon.a</span></code>) and two OSDs (<code class="docutils literal notranslate"><span class="pre">osd.0</span></code> and <code class="docutils literal notranslate"><span class="pre">osd.1</span></code>), all on the same
machine. Control moves to the next task when the Ceph cluster reaches
<code class="docutils literal notranslate"><span class="pre">HEALTH_OK</span></code> state.</p>
<p>The next task is <code class="docutils literal notranslate"><span class="pre">admin_socket</span></code> (<a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/tasks/admin_socket.py">source code</a>).
The parameter of the <code class="docutils literal notranslate"><span class="pre">admin_socket</span></code> task (and any other task) is a
structure which is interpreted as documented in the task. In this example
the parameter is a set of commands to be sent to the admin socket of
<code class="docutils literal notranslate"><span class="pre">osd.0</span></code>. The task verifies that each of them returns on success (i.e.
exit code zero).</p>
<p>This test can be run with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite --machine-type smithi --suite rados/singleton/all/admin-socket.yaml fs/ext4.yaml
</pre></div>
</div>
</div>
<div class="section" id="test-descriptions">
<h2>Test descriptions<a class="headerlink" href="#test-descriptions" title="Permalink to this headline">¶</a></h2>
<p>Each test has a “test description”, which is similar to a directory path,
but not the same. In the case of a standalone test, like the one in
<a class="reference internal" href="#reading-a-standalone-test">Reading a standalone test</a>, the test description is identical to the
relative path (starting from the <code class="docutils literal notranslate"><span class="pre">suites/</span></code> directory of the
<a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa">ceph/qa sub-directory</a>) of the yaml file defining the test.</p>
<p>Much more commonly, tests are defined not by a single yaml file, but by a
<cite>directory tree of yaml files</cite>. At runtime, the tree is walked and all yaml
files (facets) are combined into larger yaml “programs” that define the
tests. A full listing of the yaml defining the test is included at the
beginning of every test log.</p>
<p>In these cases, the description of each test consists of the
subdirectory under <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites">suites/</a> containing the
yaml facets, followed by an expression in curly braces (<code class="docutils literal notranslate"><span class="pre">{}</span></code>) consisting of
a list of yaml facets in order of concatenation. For instance the
test description:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">deploy</span><span class="o">/</span><span class="n">basic</span><span class="o">/</span><span class="p">{</span><span class="n">distros</span><span class="o">/</span><span class="n">centos_7</span><span class="mf">.0</span><span class="o">.</span><span class="n">yaml</span> <span class="n">tasks</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="n">deploy</span><span class="o">.</span><span class="n">yaml</span><span class="p">}</span>
</pre></div>
</div>
<p>signifies the concatenation of two files:</p>
<ul class="simple">
<li><p>ceph-deploy/basic/distros/centos_7.0.yaml</p></li>
<li><p>ceph-deploy/basic/tasks/ceph-deploy.yaml</p></li>
</ul>
</div>
<div class="section" id="how-tests-are-built-from-directories">
<h2>How tests are built from directories<a class="headerlink" href="#how-tests-are-built-from-directories" title="Permalink to this headline">¶</a></h2>
<p>As noted in the previous section, most tests are not defined in a single
yaml file, but rather as a <cite>combination</cite> of files collected from a
directory tree within the <code class="docutils literal notranslate"><span class="pre">suites/</span></code> subdirectory of the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa">ceph/qa sub-directory</a>.</p>
<p>The set of all tests defined by a given subdirectory of <code class="docutils literal notranslate"><span class="pre">suites/</span></code> is
called an “integration test suite”, or a “teuthology suite”.</p>
<p>Combination of yaml facets is controlled by special files (<code class="docutils literal notranslate"><span class="pre">%</span></code> and
<code class="docutils literal notranslate"><span class="pre">+</span></code>) that are placed within the directory tree and can be thought of as
operators.  The <code class="docutils literal notranslate"><span class="pre">%</span></code> file is the “convolution” operator and <code class="docutils literal notranslate"><span class="pre">+</span></code>
signifies concatenation.</p>
<div class="section" id="convolution-operator">
<h3>Convolution operator<a class="headerlink" href="#convolution-operator" title="Permalink to this headline">¶</a></h3>
<p>The convolution operator, implemented as an empty file called <code class="docutils literal notranslate"><span class="pre">%</span></code>, tells
teuthology to construct a test matrix from yaml facets found in
subdirectories below the directory containing the operator.</p>
<p>For example, the <a class="reference external" href="https://github.com/ceph/ceph/tree/jewel/qa/suites/ceph-deploy/">ceph-deploy suite</a> is
defined by the <code class="docutils literal notranslate"><span class="pre">suites/ceph-deploy/</span></code> tree, which consists of the files and
subdirectories in the following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">directory</span><span class="p">:</span> <span class="n">ceph</span><span class="o">-</span><span class="n">deploy</span><span class="o">/</span><span class="n">basic</span>
    <span class="n">file</span><span class="p">:</span> <span class="o">%</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">distros</span>
       <span class="n">file</span><span class="p">:</span> <span class="n">centos_7</span><span class="mf">.0</span><span class="o">.</span><span class="n">yaml</span>
       <span class="n">file</span><span class="p">:</span> <span class="n">ubuntu_16</span><span class="mf">.04</span><span class="o">.</span><span class="n">yaml</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">tasks</span>
       <span class="n">file</span><span class="p">:</span> <span class="n">ceph</span><span class="o">-</span><span class="n">deploy</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>This is interpreted as a 2x1 matrix consisting of two tests:</p>
<ol class="arabic simple">
<li><p>ceph-deploy/basic/{distros/centos_7.0.yaml tasks/ceph-deploy.yaml}</p></li>
<li><p>ceph-deploy/basic/{distros/ubuntu_16.04.yaml tasks/ceph-deploy.yaml}</p></li>
</ol>
<p>i.e. the concatenation of centos_7.0.yaml and ceph-deploy.yaml and
the concatenation of ubuntu_16.04.yaml and ceph-deploy.yaml, respectively.
In human terms, this means that the task found in <code class="docutils literal notranslate"><span class="pre">ceph-deploy.yaml</span></code> is
intended to run on both CentOS 7.0 and Ubuntu 16.04.</p>
<p>Without the file percent, the <code class="docutils literal notranslate"><span class="pre">ceph-deploy</span></code> tree would be interpreted as
three standalone tests:</p>
<ul class="simple">
<li><p>ceph-deploy/basic/distros/centos_7.0.yaml</p></li>
<li><p>ceph-deploy/basic/distros/ubuntu_16.04.yaml</p></li>
<li><p>ceph-deploy/basic/tasks/ceph-deploy.yaml</p></li>
</ul>
<p>(which would of course be wrong in this case).</p>
<p>Referring to the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa">ceph/qa sub-directory</a>, you will notice that the
<code class="docutils literal notranslate"><span class="pre">centos_7.0.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">ubuntu_16.04.yaml</span></code> files in the
<code class="docutils literal notranslate"><span class="pre">suites/ceph-deploy/basic/distros/</span></code> directory are implemented as symlinks.
By using symlinks instead of copying, a single file can appear in multiple
suites. This eases the maintenance of the test framework as a whole.</p>
<p>All the tests generated from the <code class="docutils literal notranslate"><span class="pre">suites/ceph-deploy/</span></code> directory tree
(also known as the “ceph-deploy suite”) can be run with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite --machine-type smithi --suite ceph-deploy
</pre></div>
</div>
<p>An individual test from the <a class="reference external" href="https://github.com/ceph/ceph/tree/jewel/qa/suites/ceph-deploy/">ceph-deploy suite</a> can be run by adding the
<code class="docutils literal notranslate"><span class="pre">--filter</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite \
    --machine-type smithi \
    --suite ceph-deploy/basic \
    --filter &#39;ceph-deploy/basic/{distros/ubuntu_16.04.yaml tasks/ceph-deploy.yaml}&#39;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To run a standalone test like the one in <a class="reference internal" href="#reading-a-standalone-test">Reading a standalone
test</a>, <code class="docutils literal notranslate"><span class="pre">--suite</span></code> alone is sufficient. If you want to run a single
test from a suite that is defined as a directory tree, <code class="docutils literal notranslate"><span class="pre">--suite</span></code> must
be combined with <code class="docutils literal notranslate"><span class="pre">--filter</span></code>. This is because the <code class="docutils literal notranslate"><span class="pre">--suite</span></code> option
understands POSIX relative paths only.</p>
</div>
</div>
<div class="section" id="concatenation-operator">
<h3>Concatenation operator<a class="headerlink" href="#concatenation-operator" title="Permalink to this headline">¶</a></h3>
<p>For even greater flexibility in sharing yaml files between suites, the
special file plus (<code class="docutils literal notranslate"><span class="pre">+</span></code>) can be used to concatenate files within a
directory. For instance, consider the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rbd/thrash">suites/rbd/thrash</a>
tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">directory</span><span class="p">:</span> <span class="n">rbd</span><span class="o">/</span><span class="n">thrash</span>
  <span class="n">file</span><span class="p">:</span> <span class="o">%</span>
  <span class="n">directory</span><span class="p">:</span> <span class="n">clusters</span>
    <span class="n">file</span><span class="p">:</span> <span class="o">+</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">fixed</span><span class="o">-</span><span class="mf">2.</span><span class="n">yaml</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">openstack</span><span class="o">.</span><span class="n">yaml</span>
  <span class="n">directory</span><span class="p">:</span> <span class="n">workloads</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">rbd_api_tests_copy_on_read</span><span class="o">.</span><span class="n">yaml</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">rbd_api_tests</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>This creates two tests:</p>
<ul class="simple">
<li><p>rbd/thrash/{clusters/fixed-2.yaml clusters/openstack.yaml workloads/rbd_api_tests_copy_on_read.yaml}</p></li>
<li><p>rbd/thrash/{clusters/fixed-2.yaml clusters/openstack.yaml workloads/rbd_api_tests.yaml}</p></li>
</ul>
<p>Because the <code class="docutils literal notranslate"><span class="pre">clusters/</span></code> subdirectory contains the special file plus
(<code class="docutils literal notranslate"><span class="pre">+</span></code>), all the other files in that subdirectory (<code class="docutils literal notranslate"><span class="pre">fixed-2.yaml</span></code> and
<code class="docutils literal notranslate"><span class="pre">openstack.yaml</span></code> in this case) are concatenated together
and treated as a single file. Without the special file plus, they would
have been convolved with the files from the workloads directory to create
a 2x2 matrix:</p>
<ul class="simple">
<li><p>rbd/thrash/{clusters/openstack.yaml workloads/rbd_api_tests_copy_on_read.yaml}</p></li>
<li><p>rbd/thrash/{clusters/openstack.yaml workloads/rbd_api_tests.yaml}</p></li>
<li><p>rbd/thrash/{clusters/fixed-2.yaml workloads/rbd_api_tests_copy_on_read.yaml}</p></li>
<li><p>rbd/thrash/{clusters/fixed-2.yaml workloads/rbd_api_tests.yaml}</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">clusters/fixed-2.yaml</span></code> file is shared among many suites to
define the following <code class="docutils literal notranslate"><span class="pre">roles</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">roles</span><span class="p">:</span>
<span class="o">-</span> <span class="p">[</span><span class="n">mon</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">mon</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">osd</span><span class="mf">.0</span><span class="p">,</span> <span class="n">osd</span><span class="mf">.1</span><span class="p">,</span> <span class="n">osd</span><span class="mf">.2</span><span class="p">,</span> <span class="n">client</span><span class="mf">.0</span><span class="p">]</span>
<span class="o">-</span> <span class="p">[</span><span class="n">mon</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">osd</span><span class="mf">.3</span><span class="p">,</span> <span class="n">osd</span><span class="mf">.4</span><span class="p">,</span> <span class="n">osd</span><span class="mf">.5</span><span class="p">,</span> <span class="n">client</span><span class="mf">.1</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">rbd/thrash</span></code> suite as defined above, consisting of two tests,
can be run with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite --machine-type smithi --suite rbd/thrash
</pre></div>
</div>
<p>A single test from the rbd/thrash suite can be run by adding the
<code class="docutils literal notranslate"><span class="pre">--filter</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite \
    --machine-type smithi \
    --suite rbd/thrash \
    --filter &#39;rbd/thrash/{clusters/fixed-2.yaml clusters/openstack.yaml workloads/rbd_api_tests_copy_on_read.yaml}&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="filtering-tests-by-their-description">
<h2>Filtering tests by their description<a class="headerlink" href="#filtering-tests-by-their-description" title="Permalink to this headline">¶</a></h2>
<p>When a few jobs fail and need to be run again, the <code class="docutils literal notranslate"><span class="pre">--filter</span></code> option
can be used to select tests with a matching description. For instance, if the
<code class="docutils literal notranslate"><span class="pre">rados</span></code> suite fails the <a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/suites/rados/singleton/all/peer.yaml">all/peer.yaml</a> test, the following will only
run the tests that contain this file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">teuthology</span><span class="o">-</span><span class="n">suite</span> <span class="o">--</span><span class="n">machine</span><span class="o">-</span><span class="nb">type</span> <span class="n">smithi</span> <span class="o">--</span><span class="n">suite</span> <span class="n">rados</span> <span class="o">--</span><span class="nb">filter</span> <span class="nb">all</span><span class="o">/</span><span class="n">peer</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--filter-out</span></code> option does the opposite (it matches tests that do <cite>not</cite>
contain a given string), and can be combined with the <code class="docutils literal notranslate"><span class="pre">--filter</span></code> option.</p>
<p>Both <code class="docutils literal notranslate"><span class="pre">--filter</span></code> and <code class="docutils literal notranslate"><span class="pre">--filter-out</span></code> take a comma-separated list of strings
(which means the comma character is implicitly forbidden in filenames found in
the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa">ceph/qa sub-directory</a>). For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">teuthology</span><span class="o">-</span><span class="n">suite</span> <span class="o">--</span><span class="n">machine</span><span class="o">-</span><span class="nb">type</span> <span class="n">smithi</span> <span class="o">--</span><span class="n">suite</span> <span class="n">rados</span> <span class="o">--</span><span class="nb">filter</span> <span class="nb">all</span><span class="o">/</span><span class="n">peer</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="nb">all</span><span class="o">/</span><span class="n">rest</span><span class="o">-</span><span class="n">api</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>will run tests that contain either
<a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/suites/rados/singleton/all/peer.yaml">all/peer.yaml</a>
or
<a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/suites/rados/singleton/all/rest-api.yaml">all/rest-api.yaml</a></p>
<p>Each string is looked up anywhere in the test description and has to
be an exact match: they are not regular expressions.</p>
</div>
<div class="section" id="reducing-the-number-of-tests">
<h2>Reducing the number of tests<a class="headerlink" href="#reducing-the-number-of-tests" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">rados</span></code> suite generates tens or even hundreds of thousands of tests out
of a few hundred files. This happens because teuthology constructs test
matrices from subdirectories wherever it encounters a file named <code class="docutils literal notranslate"><span class="pre">%</span></code>. For
instance, all tests in the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rados/basic">rados/basic suite</a> run with
different messenger types: <code class="docutils literal notranslate"><span class="pre">simple</span></code>, <code class="docutils literal notranslate"><span class="pre">async</span></code> and <code class="docutils literal notranslate"><span class="pre">random</span></code>, because they
are combined (via the special file <code class="docutils literal notranslate"><span class="pre">%</span></code>) with the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rados/basic/msgr">msgr directory</a></p>
<p>All integration tests are required to be run before a Ceph release is
published. When merely verifying whether a contribution can be merged without
risking a trivial regression, it is enough to run a subset. The <code class="docutils literal notranslate"><span class="pre">--subset</span></code>
option can be used to reduce the number of tests that are triggered. For
instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">teuthology</span><span class="o">-</span><span class="n">suite</span> <span class="o">--</span><span class="n">machine</span><span class="o">-</span><span class="nb">type</span> <span class="n">smithi</span> <span class="o">--</span><span class="n">suite</span> <span class="n">rados</span> <span class="o">--</span><span class="n">subset</span> <span class="mi">0</span><span class="o">/</span><span class="mi">4000</span>
</pre></div>
</div>
<p>will run as few tests as possible. The tradeoff in this case is that
not all combinations of test variations will together,
but no matter how small a ratio is provided in the <code class="docutils literal notranslate"><span class="pre">--subset</span></code>,
teuthology will still ensure that all files in the suite are in at
least one test. Understanding the actual logic that drives this
requires reading the teuthology source code.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--limit</span></code> option only runs the first <code class="docutils literal notranslate"><span class="pre">N</span></code> tests in the suite:
this is rarely useful, however, because there is no way to control which
test will be first.</p>
</div>
</div>



           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../running-tests-locally/" class="btn btn-neutral float-right" title="运行单元测试" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../tests-unit-tests/" class="btn btn-neutral float-left" title="测试 - 单元测试" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>