
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>向 Ceph 贡献：开发者指南 &#8212; Ceph Documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Ceph 内幕" href="../internals/" />
    <link rel="prev" title="体系结构" href="../../architecture/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../internals/" title="Ceph 内幕"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../../architecture/" title="体系结构"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            

<div id="dev-warning" class="admonition note" style="display:none;">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>

<div id="eol-warning" class="admonition warning" style="display:none;">
  <p class="first admonition-title">Warning</p>
  <p class="last">This document is for an unsupported version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="display:none; padding: 15px; font-weight: bold;">
    <a id="edit-on-github" href="https://github.com/ceph/ceph/edit/master/doc/dev/developer_guide/index.rst" rel="nofollow">Edit on GitHub</a> | <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <div class="section" id="ceph">
<h1><a class="toc-backref" href="#id53">向 Ceph 贡献：开发者指南</a><a class="headerlink" href="#ceph" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">作者</dt>
<dd class="field-odd"><p>Loic Dachary</p>
</dd>
<dt class="field-even">作者</dt>
<dd class="field-even"><p>Nathan Cutler</p>
</dd>
<dt class="field-odd">许可证</dt>
<dd class="field-odd"><p>Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0)</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>你可能也会对 <a class="reference internal" href="../internals/"><span class="doc">Ceph 内幕</span></a> 文档感兴趣。</p>
</div>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ceph" id="id53">向 Ceph 贡献：开发者指南</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id54">简介</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id55">必备知识</a></p>
<ul>
<li><p><a class="reference internal" href="#leads" id="id56">项目领导</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id57">历史</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id58">软件许可</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id59">源代码仓库</a></p></li>
<li><p><a class="reference internal" href="#redmine" id="id60">Redmine 问题跟踪器</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id61">邮件列表</a></p></li>
<li><p><a class="reference internal" href="#irc" id="id62">IRC</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id63">补丁的提交</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id64">从源码构建</a></p></li>
<li><p><a class="reference internal" href="#ccache" id="id65">用 ccache 加速本地构建</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id66">开发模式的集群</a></p></li>
<li><p><a class="reference internal" href="#backporting" id="id67">补丁移植（ Backporting ）</a></p></li>
<li><p><a class="reference internal" href="#guidance-for-use-of-cluster-log" id="id68">Guidance for use of cluster log</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#what-is-merged-where-and-when" id="id69">What is merged where and when ?</a></p>
<ul>
<li><p><a class="reference internal" href="#x-0-z" id="id70">开发版（即 x.0.z ）</a></p></li>
<li><p><a class="reference internal" href="#x-1-z" id="id71">稳定版候选（即 x.1.z ）阶段一</a></p></li>
<li><p><a class="reference internal" href="#id19" id="id72">稳定版候选（即 x.1.z ）阶段二</a></p></li>
<li><p><a class="reference internal" href="#x-2-z" id="id73">稳定版（即 x.2.z ）</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id28" id="id74">问题跟踪</a></p>
<ul>
<li><p><a class="reference internal" href="#id29" id="id75">问题跟踪器惯例</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id30" id="id76">基本工作流</a></p>
<ul>
<li><p><a class="reference internal" href="#id31" id="id77">更新追踪器</a></p></li>
<li><p><a class="reference internal" href="#id32" id="id78">上游源码</a></p></li>
<li><p><a class="reference internal" href="#id33" id="id79">本地环境</a></p></li>
<li><p><a class="reference internal" href="#id34" id="id80">缺陷修订分支</a></p></li>
<li><p><a class="reference internal" href="#id35" id="id81">在本地修正缺陷</a></p></li>
<li><p><a class="reference internal" href="#id36" id="id82">GitHub 拉取请求</a></p></li>
<li><p><a class="reference internal" href="#pr" id="id83">全自动的 PR 校验</a></p></li>
<li><p><a class="reference internal" href="#ceph-qa-suite" id="id84">集成测试（也就是 ceph-qa-suite ）</a></p></li>
<li><p><a class="reference internal" href="#id38" id="id85">源码审核</a></p></li>
<li><p><a class="reference internal" href="#id39" id="id86">修订你的 PR</a></p></li>
<li><p><a class="reference internal" href="#id40" id="id87">合并</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id41" id="id88">测试</a></p>
<ul>
<li><p><a class="reference internal" href="#make-check" id="id89">单元测试 - make check</a></p></li>
<li><p><a class="reference internal" href="#id45" id="id90">测试 - 集成测试</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id49" id="id91">在云端测试</a></p>
<ul>
<li><p><a class="reference internal" href="#assumptions-and-caveat" id="id92">Assumptions and caveat</a></p></li>
<li><p><a class="reference internal" href="#prepare-tenant" id="id93">Prepare tenant</a></p></li>
<li><p><a class="reference internal" href="#ceph-workbench" id="id94">安装 ceph-workbench</a></p></li>
<li><p><a class="reference internal" href="#linking-ceph-workbench-with-your-openstack-tenant" id="id95">Linking ceph-workbench with your OpenStack tenant</a></p></li>
<li><p><a class="reference internal" href="#run-the-dummy-suite" id="id96">Run the dummy suite</a></p></li>
<li><p><a class="reference internal" href="#run-a-standalone-test" id="id97">Run a standalone test</a></p></li>
<li><p><a class="reference internal" href="#interrupt-a-running-suite" id="id98">Interrupt a running suite</a></p></li>
<li><p><a class="reference internal" href="#upload-logs-to-archive-server" id="id99">Upload logs to archive server</a></p></li>
<li><p><a class="reference internal" href="#provision-vms-ad-hoc" id="id100">Provision VMs ad hoc</a></p></li>
<li><p><a class="reference internal" href="#deploy-a-cluster-for-manual-testing" id="id101">部署用于手动测试的集群</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#s3" id="id102">测试——如何在本地测试 S3</a></p>
<ul>
<li><p><a class="reference internal" href="#step-1-build-ceph" id="id103">第一步：构建 Ceph</a></p></li>
<li><p><a class="reference internal" href="#vstart" id="id104">第二步： vstart</a></p></li>
<li><p><a class="reference internal" href="#s3-tests" id="id105">第三步：运行 s3-tests</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id54">简介</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>This guide has two aims. First, it should lower the barrier to entry for
software developers who wish to get involved in the Ceph project. Second,
it should serve as a reference for Ceph developers.</p>
<p>We assume that readers are already familiar with Ceph (the distributed
object store and file system designed to provide excellent performance,
reliability and scalability). If not, please refer to the <a class="reference external" href="https://ceph.com">project website</a>
and especially the <a class="reference external" href="https://ceph.com/publications/">publications list</a>.</p>
<p>Since this document is to be consumed by developers, who are assumed to
have Internet access, topics covered elsewhere, either within the Ceph
documentation or elsewhere on the web, are treated by linking. If you
notice that a link is broken or if you know of a better link, please
<a class="reference external" href="http://tracker.ceph.com/projects/ceph/issues/new">report it as a bug</a>.</p>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id55">必备知识</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>本章包含必要信息，每个 Ceph 开发者都应该知道。</p>
<div class="section" id="leads">
<span id="id3"></span><h3><a class="toc-backref" href="#id56">项目领导</a><a class="headerlink" href="#leads" title="Permalink to this headline">¶</a></h3>
<p>Ceph 项目是由 Sage Weil 领导的。另外，各主要项目组件有自己的领导，下面的表格罗列了所有领导、以及他们在 <a class="reference external" href="https://github.com/">GitHub</a> 上的昵称。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 24%" />
<col style="width: 42%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Scope</p></th>
<th class="head"><p>Lead</p></th>
<th class="head"><p>GitHub nick</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Ceph</p></td>
<td><p>Sage Weil</p></td>
<td><p>liewegas</p></td>
</tr>
<tr class="row-odd"><td><p>RADOS</p></td>
<td><p>Neha Ojha</p></td>
<td><p>neha-ojha</p></td>
</tr>
<tr class="row-even"><td><p>RGW</p></td>
<td><p>Yehuda Sadeh</p></td>
<td><p>yehudasa</p></td>
</tr>
<tr class="row-odd"><td><p>RGW</p></td>
<td><p>Matt Benjamin</p></td>
<td><p>mattbenjamin</p></td>
</tr>
<tr class="row-even"><td><p>RBD</p></td>
<td><p>Jason Dillaman</p></td>
<td><p>dillaman</p></td>
</tr>
<tr class="row-odd"><td><p>CephFS</p></td>
<td><p>Patrick Donnelly</p></td>
<td><p>batrick</p></td>
</tr>
<tr class="row-even"><td><p>Dashboard</p></td>
<td><p>Lenz Grimmer</p></td>
<td><p>LenzGr</p></td>
</tr>
<tr class="row-odd"><td><p>MON</p></td>
<td><p>Joao Luis</p></td>
<td><p>jecluis</p></td>
</tr>
<tr class="row-even"><td><p>Build/Ops</p></td>
<td><p>Ken Dreyer</p></td>
<td><p>ktdreyer</p></td>
</tr>
</tbody>
</table>
<p>上述表格里的 Ceph 专有缩写在 <a class="reference internal" href="../../architecture/"><span class="doc">体系结构</span></a> 里面有解释。</p>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id57">历史</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>请翻阅 <a class="reference external" href="https://en.wikipedia.org/wiki/Ceph_%28software%29#History">Wikipedia 的 History 这章</a>。</p>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id58">软件许可</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Ceph 是自由软件。</p>
<p>除非另有声明， Ceeph 的源代码会以 LGPL2.1 许可证发布。其条款位于<a class="reference external" href="https://github.com/ceph/ceph/blob/master/COPYING">源码树顶极目录下的 COPYING 文件内</a>。</p>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id59">源代码仓库</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>The source code of Ceph lives on <a class="reference external" href="https://github.com/">GitHub</a> in a number of repositories below
the <a class="reference external" href="https://github.com/ceph">Ceph “organization”</a>.</p>
<p>To make a meaningful contribution to the project as a developer, a working
knowledge of <a class="reference external" href="https://git-scm.com/documentation">git</a> is essential.</p>
<p>Although the <a class="reference external" href="https://github.com/ceph">Ceph “organization”</a> includes several software repositories,
this document covers only one: <a class="reference external" href="https://github.com/ceph/ceph">https://github.com/ceph/ceph</a>.</p>
</div>
<div class="section" id="redmine">
<h3><a class="toc-backref" href="#id60">Redmine 问题跟踪器</a><a class="headerlink" href="#redmine" title="Permalink to this headline">¶</a></h3>
<p>Although <a class="reference external" href="https://github.com/">GitHub</a> is used for code, Ceph-related issues (Bugs, Features,
Backports, Documentation, etc.) are tracked at <a class="reference external" href="http://tracker.ceph.com">http://tracker.ceph.com</a>,
which is powered by <a class="reference external" href="http://www.redmine.org">Redmine</a>.</p>
<p>The tracker has a Ceph project with a number of subprojects loosely
corresponding to the various architectural components (see
<a class="reference internal" href="../../architecture/"><span class="doc">体系结构</span></a>).</p>
<p>Mere <a class="reference external" href="http://tracker.ceph.com/account/register">registration</a> in the tracker automatically grants permissions
sufficient to open new issues and comment on existing ones.</p>
<p>要报告软件缺陷或者提议新功能，请<a class="reference external" href="http://tracker.ceph.com/projects/ceph">跳转到 Ceph 项目</a>并点击 <a class="reference external" href="http://tracker.ceph.com/projects/ceph/issues/new">New issue</a> 。</p>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id61">邮件列表</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>Ceph 的开发邮件讨论是通过邮件列表 <code class="docutils literal notranslate"><span class="pre">ceph-devel&#64;vger.kernel.org</span></code> 进行的。这个邮件列表对所有人开放，把下面这行发送到 <code class="docutils literal notranslate"><span class="pre">majordomo&#64;vger.kernel.org</span></code> 即可订阅：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subscribe</span> <span class="n">ceph</span><span class="o">-</span><span class="n">devel</span>
</pre></div>
</div>
<p>要作为邮件正文发出。</p>
<p>还有<a class="reference external" href="https://ceph.com/irc/">其他与 Ceph 相关的邮件列表</a>。</p>
</div>
<div class="section" id="irc">
<h3><a class="toc-backref" href="#id62">IRC</a><a class="headerlink" href="#irc" title="Permalink to this headline">¶</a></h3>
<p>In addition to mailing lists, the Ceph community also communicates in real
time using <a class="reference external" href="http://www.irchelp.org/">Internet Relay Chat</a>.</p>
<p>这里 <code class="docutils literal notranslate"><span class="pre">https://ceph.com/irc/</span></code> 介绍了如何配置 IRC 客户端、还有一堆频道。</p>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id63">补丁的提交</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>The canonical instructions for submitting patches are contained in the
file <a class="reference external" href="https://github.com/ceph/ceph/blob/master/CONTRIBUTING.rst">CONTRIBUTING.rst</a> in the top-level directory of the source-code
tree. There may be some overlap between this guide and that file.</p>
<p>All newcomers are encouraged to read that file carefully.</p>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id64">从源码构建</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>请参考 <a class="reference internal" href="../../install/build-ceph/"><span class="doc">构建 Ceph</span></a> 。</p>
</div>
<div class="section" id="ccache">
<span id="using-ccache-to-speed-up-local-builds"></span><h3><a class="toc-backref" href="#id65">用 ccache 加速本地构建</a><a class="headerlink" href="#ccache" title="Permalink to this headline">¶</a></h3>
<p>Rebuilds of the ceph source tree can benefit significantly from use of <a class="reference external" href="https://ccache.samba.org/">ccache</a>.
Many a times while switching branches and such, one might see build failures for
certain older branches mostly due to older build artifacts. These rebuilds can
significantly benefit the use of ccache. For a full clean source tree, one could
do</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make clean

# note the following will nuke everything in the source tree that
# isn&#39;t tracked by git, so make sure to backup any log files /conf options

$ git clean -fdx; git submodule foreach git clean -fdx
</pre></div>
</div>
<p>ccache is available as a package in most distros. To build ceph with ccache one
can:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cmake -DWITH_CCACHE=ON ..
</pre></div>
</div>
<p>ccache can also be used for speeding up all builds in the system. for more
details refer to the <a class="reference external" href="https://ccache.samba.org/manual.html#_run_modes">run modes</a> of the ccache manual. The default settings of
<code class="docutils literal notranslate"><span class="pre">ccache</span></code> can be displayed with <code class="docutils literal notranslate"><span class="pre">ccache</span> <span class="pre">-s</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is recommended to override the <code class="docutils literal notranslate"><span class="pre">max_size</span></code>, which is the size of
cache, defaulting to 10G, to a larger size like 25G or so. Refer to the
<a class="reference external" href="https://ccache.samba.org/manual.html#_configuration">configuration</a> section of ccache manual.</p>
</div>
<p>To further increase the cache hit rate and reduce compile times in a development
environment, it is possible to set version information and build timestamps to
fixed values, which avoids frequent rebuilds of binaries that contain this
information.</p>
<p>This can be achieved by adding the following settings to the <code class="docutils literal notranslate"><span class="pre">ccache</span></code>
configuration file <code class="docutils literal notranslate"><span class="pre">ccache.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sloppiness</span> <span class="o">=</span> <span class="n">time_macros</span>
<span class="n">run_second_cpp</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>Now, set the environment variable <code class="docutils literal notranslate"><span class="pre">SOURCE_DATE_EPOCH</span></code> to a fixed value (a UNIX
timestamp) and set <code class="docutils literal notranslate"><span class="pre">ENABLE_GIT_VERSION</span></code> to <code class="docutils literal notranslate"><span class="pre">OFF</span></code> when running <code class="docutils literal notranslate"><span class="pre">cmake</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ export SOURCE_DATE_EPOCH=946684800
$ cmake -DWITH_CCACHE=ON -DENABLE_GIT_VERSION=OFF ..
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Binaries produced with these build options are not suitable for
production or debugging purposes, as they do not contain the correct build
time and git version information.</p>
</div>
</div>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id66">开发模式的集群</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>参考 <a class="reference internal" href="../quick_guide/"><span class="doc">开发者指南（快速）</span></a> 。</p>
</div>
<div class="section" id="backporting">
<h3><a class="toc-backref" href="#id67">补丁移植（ Backporting ）</a><a class="headerlink" href="#backporting" title="Permalink to this headline">¶</a></h3>
<p>All bugfixes should be merged to the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch before being backported.
To flag a bugfix for backporting, make sure it has a <a class="reference external" href="http://tracker.ceph.com/">tracker issue</a>
associated with it and set the <code class="docutils literal notranslate"><span class="pre">Backport</span></code> field to a comma-separated list of
previous releases (e.g. “hammer,jewel”) that you think need the backport.
The rest (including the actual backporting) will be taken care of by the
<a class="reference external" href="http://tracker.ceph.com/projects/ceph-releases/wiki">Stable Releases and Backports</a> team.</p>
</div>
<div class="section" id="guidance-for-use-of-cluster-log">
<h3><a class="toc-backref" href="#id68">Guidance for use of cluster log</a><a class="headerlink" href="#guidance-for-use-of-cluster-log" title="Permalink to this headline">¶</a></h3>
<p>If your patches emit messages to the Ceph cluster log, please consult</p>
</div>
</div>
<div class="section" id="what-is-merged-where-and-when">
<h2><a class="toc-backref" href="#id69">What is merged where and when ?</a><a class="headerlink" href="#what-is-merged-where-and-when" title="Permalink to this headline">¶</a></h2>
<p>Commits are merged into branches according to criteria that change
during the lifecycle of a Ceph release. This chapter is the inventory
of what can be merged in which branch at a given point in time.</p>
<div class="section" id="x-0-z">
<h3><a class="toc-backref" href="#id70">开发版（即 x.0.z ）</a><a class="headerlink" href="#x-0-z" title="Permalink to this headline">¶</a></h3>
<div class="section" id="what">
<h4>What ?<a class="headerlink" href="#what" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>features</p></li>
<li><p>bug fixes</p></li>
</ul>
</div>
<div class="section" id="where">
<h4>Where ?<a class="headerlink" href="#where" title="Permalink to this headline">¶</a></h4>
<p>Features are merged to the master branch. Bug fixes should be merged
to the corresponding named branch (e.g. “jewel” for 10.0.z, “kraken”
for 11.0.z, etc.). However, this is not mandatory - bug fixes can be
merged to the master branch as well, since the master branch is
periodically merged to the named branch during the development
releases phase. In either case, if the bugfix is important it can also
be flagged for backport to one or more previous stable releases.</p>
</div>
<div class="section" id="when">
<h4>When ?<a class="headerlink" href="#when" title="Permalink to this headline">¶</a></h4>
<p>After the stable release candidates of the previous release enters
phase 2 (see below).  For example: the “jewel” named branch was
created when the infernalis release candidates entered phase 2. From
this point on, master was no longer associated with infernalis. As
soon as the named branch of the next stable release is created, master
starts getting periodically merged into it.</p>
</div>
<div class="section" id="branch-merges">
<h4>Branch merges<a class="headerlink" href="#branch-merges" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>The branch of the stable release is merged periodically into master.</p></li>
<li><p>The master branch is merged periodically into the branch of the
stable release.</p></li>
<li><p>The master is merged into the branch of the stable release
immediately after each development x.0.z release.</p></li>
</ul>
</div>
</div>
<div class="section" id="x-1-z">
<h3><a class="toc-backref" href="#id71">稳定版候选（即 x.1.z ）阶段一</a><a class="headerlink" href="#x-1-z" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id15">
<h4>What ?<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>bug fixes only</p></li>
</ul>
</div>
<div class="section" id="id16">
<h4>Where ?<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>The branch of the stable release (e.g. “jewel” for 10.0.z, “kraken”
for 11.0.z, etc.) or master.  Bug fixes should be merged to the named
branch corresponding to the stable release candidate (e.g. “jewel” for
10.1.z) or to master. During this phase, all commits to master will be
merged to the named branch, and vice versa. In other words, it makes
no difference whether a commit is merged to the named branch or to
master - it will make it into the next release candidate either way.</p>
</div>
<div class="section" id="id17">
<h4>When ?<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>After the first stable release candidate is published, i.e. after the
x.1.0 tag is set in the release branch.</p>
</div>
<div class="section" id="id18">
<h4>Branch merges<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>The branch of the stable release is merged periodically into master.</p></li>
<li><p>The master branch is merged periodically into the branch of the
stable release.</p></li>
<li><p>The master is merged into the branch of the stable release
immediately after each x.1.z release candidate.</p></li>
</ul>
</div>
</div>
<div class="section" id="id19">
<h3><a class="toc-backref" href="#id72">稳定版候选（即 x.1.z ）阶段二</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id20">
<h4>What ?<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>bug fixes only</p></li>
</ul>
</div>
<div class="section" id="id21">
<h4>Where ?<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<p>The branch of the stable release (e.g. “jewel” for 10.0.z, “kraken”
for 11.0.z, etc.). During this phase, all commits to the named branch
will be merged into master. Cherry-picking to the named branch during
release candidate phase 2 is done manually since the official
backporting process only begins when the release is pronounced
“stable”.</p>
</div>
<div class="section" id="id22">
<h4>When ?<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>After Sage Weil decides it is time for phase 2 to happen.</p>
</div>
<div class="section" id="id23">
<h4>Branch merges<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>The branch of the stable release is merged periodically into master.</p></li>
</ul>
</div>
</div>
<div class="section" id="x-2-z">
<h3><a class="toc-backref" href="#id73">稳定版（即 x.2.z ）</a><a class="headerlink" href="#x-2-z" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id24">
<h4>What ?<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>bug fixes</p></li>
<li><p>features are sometime accepted</p></li>
<li><p>commits should be cherry-picked from master when possible</p></li>
<li><p>commits that are not cherry-picked from master must be about a bug unique to the stable release</p></li>
<li><p>see also <a class="reference external" href="http://tracker.ceph.com/projects/ceph-releases/wiki/HOWTO#HOWTO">the backport HOWTO</a></p></li>
</ul>
</div>
<div class="section" id="id25">
<h4>Where ?<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<p>The branch of the stable release (hammer for 0.94.x, infernalis for 9.2.x, etc.)</p>
</div>
<div class="section" id="id26">
<h4>When ?<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<p>After the stable release is published, i.e. after the “vx.2.0” tag is
set in the release branch.</p>
</div>
<div class="section" id="id27">
<h4>分支合并<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<p>不会再并入。</p>
</div>
</div>
</div>
<div class="section" id="id28">
<h2><a class="toc-backref" href="#id74">问题跟踪</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference internal" href="#redmine">Redmine 问题跟踪器</a> for a brief introduction to the Ceph Issue Tracker.</p>
<p>Ceph developers use the issue tracker to</p>
<p>1. keep track of issues - bugs, fix requests, feature requests, backport
requests, etc.</p>
<p>2. communicate with other developers and keep them informed as work
on the issues progresses.</p>
<div class="section" id="id29">
<h3><a class="toc-backref" href="#id75">问题跟踪器惯例</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<p>When you start working on an existing issue, it’s nice to let the other
developers know this - to avoid duplication of labor. Typically, this is
done by changing the <code class="code docutils literal notranslate"><span class="pre">Assignee</span></code> field (to yourself) and changing the
<code class="code docutils literal notranslate"><span class="pre">Status</span></code> to <em>In progress</em>. Newcomers to the Ceph community typically do not
have sufficient privileges to update these fields, however: they can
simply update the issue with a brief note.</p>
<table class="docutils align-default" id="id52">
<caption><span class="caption-text">Meanings of some commonly used statuses</span><a class="headerlink" href="#id52" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 27%" />
<col style="width: 73%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Status</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>New</p></td>
<td><p>Initial status</p></td>
</tr>
<tr class="row-odd"><td><p>In Progress</p></td>
<td><p>Somebody is working on it</p></td>
</tr>
<tr class="row-even"><td><p>Need Review</p></td>
<td><p>Pull request is open with a fix</p></td>
</tr>
<tr class="row-odd"><td><p>Pending Backport</p></td>
<td><p>Fix has been merged, backport(s) pending</p></td>
</tr>
<tr class="row-even"><td><p>Resolved</p></td>
<td><p>Fix and backports (if any) have been merged</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="id30">
<h2><a class="toc-backref" href="#id76">基本工作流</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h2>
<p>The following chart illustrates basic development workflow:</p>
<p class="ditaa">
<img src="../../_images/ditaa-7dab481dc1693cb6064b44ec1518e96c3dbb89ab.png"/>
</p>
<p>Below we present an explanation of this chart. The explanation is written
with the assumption that you, the reader, are a beginning developer who
has an idea for a bugfix, but do not know exactly how to proceed.</p>
<div class="section" id="id31">
<h3><a class="toc-backref" href="#id77">更新追踪器</a><a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h3>
<p>Before you start, you should know the <a class="reference internal" href="#id28">问题跟踪</a> number of the bug
you intend to fix. If there is no tracker issue, now is the time to create
one.</p>
<p>The tracker is there to explain the issue (bug) to your fellow Ceph
developers and keep them informed as you make progress toward resolution.
To this end, then, provide a descriptive title as well as sufficient
information and details in the description.</p>
<p>If you have sufficient tracker permissions, assign the bug to yourself by
changing the <code class="docutils literal notranslate"><span class="pre">Assignee</span></code> field.  If your tracker permissions have not yet
been elevated, simply add a comment to the issue with a short message like
“I am working on this issue”.</p>
</div>
<div class="section" id="id32">
<h3><a class="toc-backref" href="#id78">上游源码</a><a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h3>
<p>This section, and the ones that follow, correspond to the nodes in the
above chart.</p>
<p>The upstream code lives in <a class="reference external" href="https://github.com/ceph/ceph.git">https://github.com/ceph/ceph.git</a>, which is
sometimes referred to as the “upstream repo”, or simply “upstream”. As the
chart illustrates, we will make a local copy of this code, modify it, test
our modifications, and submit the modifications back to the upstream repo
for review.</p>
<p>A local copy of the upstream code is made by</p>
<ol class="arabic simple">
<li><p>forking the upstream repo on GitHub, and</p></li>
<li><p>cloning your fork to make a local working copy</p></li>
</ol>
<p>See the <a class="reference external" href="https://help.github.com/articles/fork-a-repo/#platform-linux">the GitHub documentation</a> for
detailed instructions on forking. In short, if your GitHub username is
“mygithubaccount”, your fork of the upstream repo will show up at
<a class="reference external" href="https://github.com/mygithubaccount/ceph">https://github.com/mygithubaccount/ceph</a>. Once you have created your fork,
you clone it by doing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/mygithubaccount/ceph
</pre></div>
</div>
<p>While it is possible to clone the upstream repo directly, in this case you
must fork it first. Forking is what enables us to open a <a class="reference internal" href="#id36">GitHub 拉取请求</a>.</p>
<p>For more information on using GitHub, refer to <a class="reference external" href="https://help.github.com/">GitHub Help</a>.</p>
</div>
<div class="section" id="id33">
<h3><a class="toc-backref" href="#id79">本地环境</a><a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h3>
<p>In the local environment created in the previous step, you now have a
copy of the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch in <code class="docutils literal notranslate"><span class="pre">remotes/origin/master</span></code>. Since the fork
(<a class="reference external" href="https://github.com/mygithubaccount/ceph.git">https://github.com/mygithubaccount/ceph.git</a>) is frozen in time and the
upstream repo (<a class="reference external" href="https://github.com/ceph/ceph.git">https://github.com/ceph/ceph.git</a>, typically abbreviated to
<code class="docutils literal notranslate"><span class="pre">ceph/ceph.git</span></code>) is updated frequently by other developers, you will need
to sync your fork periodically. To do this, first add the upstream repo as
a “remote” and fetch it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git remote add ceph https://github.com/ceph/ceph.git
$ git fetch ceph
</pre></div>
</div>
<p>Fetching downloads all objects (commits, branches) that were added since
the last sync. After running these commands, all the branches from
<code class="docutils literal notranslate"><span class="pre">ceph/ceph.git</span></code> are downloaded to the local git repo as
<code class="docutils literal notranslate"><span class="pre">remotes/ceph/$BRANCH_NAME</span></code> and can be referenced as
<code class="docutils literal notranslate"><span class="pre">ceph/$BRANCH_NAME</span></code> in certain git commands.</p>
<p>For example, your local <code class="docutils literal notranslate"><span class="pre">master</span></code> branch can be reset to the upstream Ceph
<code class="docutils literal notranslate"><span class="pre">master</span></code> branch by doing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git fetch ceph
$ git checkout master
$ git reset --hard ceph/master
</pre></div>
</div>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch of your fork can then be synced to upstream
master by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git push -u origin master
</pre></div>
</div>
</div>
<div class="section" id="id34">
<h3><a class="toc-backref" href="#id80">缺陷修订分支</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h3>
<p>Next, create a branch for the bugfix:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git checkout master
$ git checkout -b fix_1
$ git push -u origin fix_1
</pre></div>
</div>
<p>This creates a <code class="docutils literal notranslate"><span class="pre">fix_1</span></code> branch locally and in our GitHub fork. At this
point, the <code class="docutils literal notranslate"><span class="pre">fix_1</span></code> branch is identical to the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch, but not
for long! You are now ready to modify the code.</p>
</div>
<div class="section" id="id35">
<h3><a class="toc-backref" href="#id81">在本地修正缺陷</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h3>
<p>At this point, change the status of the tracker issue to “In progress” to
communicate to the other Ceph developers that you have begun working on a
fix. If you don’t have permission to change that field, your comment that
you are working on the issue is sufficient.</p>
<p>Possibly, your fix is very simple and requires only minimal testing.
More likely, it will be an iterative process involving trial and error, not
to mention skill. An explanation of how to fix bugs is beyond the
scope of this document. Instead, we focus on the mechanics of the process
in the context of the Ceph project.</p>
<p>A detailed discussion of the tools available for validating your bugfixes,
see the <a class="reference internal" href="#id41">测试</a> chapter.</p>
<p>For now, let us just assume that you have finished work on the bugfix and
that you have tested it and believe it works. Commit the changes to your local
branch using the <code class="docutils literal notranslate"><span class="pre">--signoff</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git commit -as
</pre></div>
</div>
<p>and push the changes to your fork:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git push origin fix_1
</pre></div>
</div>
</div>
<div class="section" id="id36">
<h3><a class="toc-backref" href="#id82">GitHub 拉取请求</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h3>
<p>The next step is to open a GitHub pull request. The purpose of this step is
to make your bugfix available to the community of Ceph developers.  They
will review it and may do additional testing on it.</p>
<p>In short, this is the point where you “go public” with your modifications.
Psychologically, you should be prepared to receive suggestions and
constructive criticism. Don’t worry! In our experience, the Ceph project is
a friendly place!</p>
<p>If you are uncertain how to use pull requests, you may read
<a class="reference external" href="https://help.github.com/articles/using-pull-requests/">this GitHub pull request tutorial</a>.</p>
<p>For some ideas on what constitutes a “good” pull request, see
the <a class="reference external" href="https://wiki.openstack.org/wiki/GitCommitMessages">Git 提交的实践真知</a> article at the <a class="reference external" href="https://wiki.openstack.org/wiki/Main_Page">OpenStack 项目百科</a>.</p>
<p>Once your pull request (PR) is opened, update the <a class="reference internal" href="#id28">问题跟踪</a> by
adding a comment to the bug pointing the other developers to your PR. The
update can be as simple as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>*PR*: https://github.com/ceph/ceph/pull/$NUMBER_OF_YOUR_PULL_REQUEST
</pre></div>
</div>
</div>
<div class="section" id="pr">
<span id="automated-pr-validation"></span><h3><a class="toc-backref" href="#id83">全自动的 PR 校验</a><a class="headerlink" href="#pr" title="Permalink to this headline">¶</a></h3>
<p>When your PR hits GitHub, the Ceph project’s <a class="reference external" href="https://en.wikipedia.org/wiki/Continuous_integration">Continuous Integration (CI)</a>
infrastructure will test it automatically. At the time of this writing
(March 2016), the automated CI testing included a test to check that the
commits in the PR are properly signed (see <a class="reference internal" href="#id11">补丁的提交</a>) and a
<a class="reference internal" href="#make-check">make check</a> test.</p>
<p>The latter, <a class="reference internal" href="#make-check">make check</a>, builds the PR and runs it through a battery of
tests. These tests run on machines operated by the Ceph Continuous
Integration (CI) team. When the tests complete, the result will be shown
on GitHub in the pull request itself.</p>
<p>You can (and should) also test your modifications before you open a PR.
Refer to the <a class="reference internal" href="#id41">测试</a> chapter for details.</p>
<div class="section" id="pr-make-check">
<h4>PR make check 测试注意事项<a class="headerlink" href="#pr-make-check" title="Permalink to this headline">¶</a></h4>
<p>GitHub 上的 <a class="reference internal" href="#make-check">make check</a> 测试是由 Jenkins 例程驱动的。</p>
<p>Jenkins merges the PR branch into the latest version of the base branch before
starting the build, so you don’t have to rebase the PR to pick up any fixes.</p>
<p>You can trigger the PR tests at any time by adding a comment to the PR - the
comment should contain the string “test this please”. Since a human subscribed
to the PR might interpret that as a request for him or her to test the PR, it’s
good to write the request as “Jenkins, test this please”.</p>
<p>The <a class="reference internal" href="#make-check">make check</a> log is the place to go if there is a failure and you’re not
sure what caused it. To reach it, first click on “details” (next to the <a class="reference internal" href="#make-check">make
check</a> test in the PR) to get into the Jenkins web GUI, and then click on
“Console Output” (on the left).</p>
<p>Jenkins is set up to grep the log for strings known to have been associated
with <a class="reference internal" href="#make-check">make check</a> failures in the past. However, there is no guarantee that
the strings are associated with any given <a class="reference internal" href="#make-check">make check</a> failure. You have to
dig into the log to be sure.</p>
</div>
</div>
<div class="section" id="ceph-qa-suite">
<span id="integration-tests-aka-ceph-qa-suite"></span><h3><a class="toc-backref" href="#id84">集成测试（也就是 ceph-qa-suite ）</a><a class="headerlink" href="#ceph-qa-suite" title="Permalink to this headline">¶</a></h3>
<p>Since Ceph is a complex beast, it may also be necessary to test your fix to
see how it behaves on real clusters running either on real or virtual
hardware. Tests designed for this purpose live in the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/">ceph/qa
sub-directory</a> and are run via the <a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a>.</p>
<p>If you have access to an OpenStack tenant, you are encouraged to run the
integration tests yourself using <a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a>,
and to post the test results to the PR.</p>
<p>The Ceph community has access to the <a class="reference external" href="http://ceph.github.io/sepia/">Sepia lab</a> where integration tests can be run on
real hardware. Other developers may add tags like “needs-qa” to your PR.
This allows PRs that need testing to be merged into a single branch and
tested all at the same time. Since teuthology suites can take hours
(even days in some cases) to run, this can save a lot of time.</p>
<p>Integration testing is discussed in more detail in the <a class="reference internal" href="#id41">测试</a> chapter.</p>
</div>
<div class="section" id="id38">
<h3><a class="toc-backref" href="#id85">源码审核</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h3>
<p>Once your bugfix has been thoroughly tested, or even during this process,
it will be subjected to code review by other developers. This typically
takes the form of correspondence in the PR itself, but can be supplemented
by discussions on <a class="reference internal" href="#irc">IRC</a> and the <a class="reference internal" href="#id9">邮件列表</a>.</p>
</div>
<div class="section" id="id39">
<h3><a class="toc-backref" href="#id86">修订你的 PR</a><a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h3>
<p>While your PR is going through <a class="reference internal" href="#id41">测试</a> and <a class="reference internal" href="#id38">源码审核</a>, you can
modify it at any time by editing files in your local branch.</p>
<p>After the changes are committed locally (to the <code class="docutils literal notranslate"><span class="pre">fix_1</span></code> branch in our
example), they need to be pushed to GitHub so they appear in the PR.</p>
<p>Modifying the PR is done by adding commits to the <code class="docutils literal notranslate"><span class="pre">fix_1</span></code> branch upon
which it is based, often followed by rebasing to modify the branch’s git
history. See <a class="reference external" href="https://www.atlassian.com/git/tutorials/rewriting-history">this tutorial</a> for a good
introduction to rebasing. When you are done with your modifications, you
will need to force push your branch with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git push --force origin fix_1
</pre></div>
</div>
</div>
<div class="section" id="id40">
<h3><a class="toc-backref" href="#id87">合并</a><a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h3>
<p>The bugfixing process culminates when one of the project leads decides to
merge your PR.</p>
<p>When this happens, it is a signal for you (or the lead who merged the PR)
to change the <a class="reference internal" href="#id28">问题跟踪</a> status to “Resolved”. Some issues may be
flagged for backporting, in which case the status should be changed to
“Pending Backport” (see the <a class="reference internal" href="#backporting">补丁移植（ Backporting ）</a> chapter for details).</p>
</div>
</div>
<div class="section" id="id41">
<h2><a class="toc-backref" href="#id88">测试</a><a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h2>
<p>Ceph has two types of tests: <a class="reference internal" href="#make-check">make check</a> tests and integration tests.
The former are run via <cite>GNU Make &lt;https://www.gnu.org/software/make/&gt;</cite>,
and the latter are run via the <a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a>. The following two
chapters examine the <a class="reference internal" href="#make-check">make check</a> and integration tests in detail.</p>
<div class="section" id="make-check">
<span id="id42"></span><h3><a class="toc-backref" href="#id89">单元测试 - make check</a><a class="headerlink" href="#make-check" title="Permalink to this headline">¶</a></h3>
<p>After compiling Ceph, the code can be run through a battery of tests covering
various aspects of Ceph. For historical reasons, this battery of tests is often
referred to as <a class="reference internal" href="#make-check">make check</a> even though the actual command used to run the
tests is now <code class="docutils literal notranslate"><span class="pre">ctest</span></code>. For inclusion in this battery of tests, a test must:</p>
<ul class="simple">
<li><p>bind ports that do not conflict with other tests</p></li>
<li><p>not require root access</p></li>
<li><p>not require more than one machine to run</p></li>
<li><p>complete within a few minutes</p></li>
</ul>
<p>For simplicity, we will refer to this class of tests as “make check tests” or
“unit tests”, to distinguish them from the more complex “integration tests”
that are run via the <a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a>.</p>
<p>While it is possible to run <code class="docutils literal notranslate"><span class="pre">ctest</span></code> directly, it can be tricky to correctly
set up your environment. Fortunately, a script is provided to make it easier
run the unit tests on your code. It can be run from the top-level directory of
the Ceph source tree by doing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./run-make-check.sh
</pre></div>
</div>
<p>You will need a minimum of 8GB of RAM and 32GB of free disk space for this
command to complete successfully on x86_64 (other architectures may have
different constraints). Depending on your hardware, it can take from 20
minutes to three hours to complete, but it’s worth the wait.</p>
<div class="section" id="id43">
<h4>如何声明单元测试<a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h4>
<p>Unit tests are declared in the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> files (multiple files under
<code class="docutils literal notranslate"><span class="pre">./src</span></code>) using the <code class="docutils literal notranslate"><span class="pre">add_ceph_test</span></code> or <code class="docutils literal notranslate"><span class="pre">add_ceph_unittest</span></code> CMake functions,
which are themselves defined in <code class="docutils literal notranslate"><span class="pre">./cmake/modules/AddCephTest.cmake</span></code>. Some
unit tests are scripts, while others are binaries that are compiled during the
build process.  The <code class="docutils literal notranslate"><span class="pre">add_ceph_test</span></code> function is used to declare unit test
scripts, while <code class="docutils literal notranslate"><span class="pre">add_ceph_unittest</span></code> is used for unit test binaries.</p>
</div>
<div class="section" id="cli">
<h4>CLI 工具的单元测试<a class="headerlink" href="#cli" title="Permalink to this headline">¶</a></h4>
<p>Some of the CLI tools are tested using special files ending with the extension
<code class="docutils literal notranslate"><span class="pre">.t</span></code> and stored under <code class="docutils literal notranslate"><span class="pre">./src/test/cli</span></code>. These tests are run using a tool
called <a class="reference external" href="https://bitheap.org/cram/">cram</a> via a shell script <code class="docutils literal notranslate"><span class="pre">./src/test/run-cli-tests</span></code>.  <a class="reference external" href="https://bitheap.org/cram/">cram</a> tests
that are not suitable for <a class="reference internal" href="#make-check">make check</a> may also be run by teuthology using
the <a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/tasks/cram.py">cram task</a>.</p>
</div>
<div class="section" id="id44">
<h4>注意事项<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li><p>Unlike the various Ceph daemons and <code class="docutils literal notranslate"><span class="pre">ceph-fuse</span></code>, the unit tests
are linked against the default memory allocator (glibc) unless explicitly
linked against something else. This enables tools like valgrind to be used
in the tests.</p></li>
</ol>
</div>
</div>
<div class="section" id="id45">
<h3><a class="toc-backref" href="#id90">测试 - 集成测试</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h3>
<p>When a test requires multiple machines, root access or lasts for a
longer time (for example, to simulate a realistic Ceph deployment), it
is deemed to be an integration test. Integration tests are organized into
“suites”, which are defined in the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/">ceph/qa sub-directory</a> and run with
the <code class="docutils literal notranslate"><span class="pre">teuthology-suite</span></code> command.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">teuthology-suite</span></code> command is part of the <a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a>.
In the sections that follow we attempt to provide a detailed introduction
to that framework from the perspective of a beginning Ceph developer.</p>
<div class="section" id="teuthology-consumes-packages">
<h4>Teuthology consumes packages<a class="headerlink" href="#teuthology-consumes-packages" title="Permalink to this headline">¶</a></h4>
<p>It may take some time to understand the significance of this fact, but it
is <cite>very</cite> significant. It means that automated tests can be conducted on
multiple platforms using the same packages (RPM, DEB) that can be
installed on any machine running those platforms.</p>
<p>Teuthology has a <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/distros/supported">list of platforms that it supports</a> (as
of December 2017 the list consisted of “CentOS 7.2” and “Ubuntu 14.04”).  It
expects to be provided pre-built Ceph packages for these platforms.
Teuthology deploys these platforms on machines (bare-metal or
cloud-provisioned), installs the packages on them, and deploys Ceph
clusters on them - all as called for by the test.</p>
</div>
<div class="section" id="the-nightlies">
<h4>The nightlies<a class="headerlink" href="#the-nightlies" title="Permalink to this headline">¶</a></h4>
<p>A number of integration tests are run on a regular basis in the <a class="reference external" href="http://ceph.github.io/sepia/">Sepia
lab</a> against the official Ceph repositories (on the <code class="docutils literal notranslate"><span class="pre">master</span></code> development
branch and the stable branches). Traditionally, these tests are called “the
nightlies” because the Ceph core developers used to live and work in
the same time zone and from their perspective the tests were run overnight.</p>
<p>The results of the nightlies are published at <a class="reference external" href="http://pulpito.ceph.com/">http://pulpito.ceph.com/</a> and
<a class="reference external" href="http://pulpito.ovh.sepia.ceph.com:8081/">http://pulpito.ovh.sepia.ceph.com:8081/</a>. The developer nick shows in the
test results URL and in the first column of the Pulpito dashboard.  The
results are also reported on the <a class="reference external" href="https://ceph.com/irc/">ceph-qa mailing list</a> for analysis.</p>
</div>
<div class="section" id="suites-inventory">
<h4>Suites inventory<a class="headerlink" href="#suites-inventory" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">suites</span></code> directory of the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/">ceph/qa sub-directory</a> contains
all the integration tests, for all the Ceph components.</p>
<dl class="simple">
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/ceph-deploy">ceph-deploy</a></dt><dd><p>install a Ceph cluster with <code class="docutils literal notranslate"><span class="pre">ceph-deploy</span></code> (<a class="reference external" href="../../man/8/ceph-deploy">ceph-deploy man page</a>)</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/ceph-disk">ceph-disk</a></dt><dd><p>verify init scripts (upstart etc.) and udev integration with
<code class="docutils literal notranslate"><span class="pre">ceph-disk</span></code> (<a class="reference external" href="../../man/8/ceph-disk">ceph-disk man page</a>), with and without <a class="reference external" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/DMCrypt">dmcrypt</a> support.</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/dummy">dummy</a></dt><dd><p>get a machine, do nothing and return success (commonly used to
verify the integration testing infrastructure works as expected)</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/fs">fs</a></dt><dd><p>test CephFS</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/kcephfs">kcephfs</a></dt><dd><p>test the CephFS kernel module</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/krbd">krbd</a></dt><dd><p>test the RBD kernel module</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/powercycle">powercycle</a></dt><dd><p>verify the Ceph cluster behaves when machines are powered off
and on again</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rados">rados</a></dt><dd><p>run Ceph clusters including OSDs and MONs, under various conditions of
stress</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rbd">rbd</a></dt><dd><p>run RBD tests using actual Ceph clusters, with and without qemu</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rgw">rgw</a></dt><dd><p>run RGW tests using actual Ceph clusters</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/smoke">smoke</a></dt><dd><p>run tests that exercise the Ceph API with an actual Ceph cluster</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/teuthology">teuthology</a></dt><dd><p>verify that teuthology can run integration tests, with and without OpenStack</p>
</dd>
<dt><a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/upgrade">upgrade</a></dt><dd><p>for various versions of Ceph, verify that upgrades can happen
without disrupting an ongoing workload</p>
</dd>
</dl>
</div>
<div class="section" id="teuthology-describe-tests">
<h4>teuthology-describe-tests<a class="headerlink" href="#teuthology-describe-tests" title="Permalink to this headline">¶</a></h4>
<p>In February 2016, a new feature called <code class="docutils literal notranslate"><span class="pre">teuthology-describe-tests</span></code> was
added to the <a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a> to facilitate documentation and better
understanding of integration tests (<a class="reference external" href="http://article.gmane.org/gmane.comp.file-systems.ceph.devel/29287">feature announcement</a>).</p>
<p>The upshot is that tests can be documented by embedding <code class="docutils literal notranslate"><span class="pre">meta:</span></code>
annotations in the yaml files used to define the tests. The results can be
seen in the <a class="reference external" href="http://tracker.ceph.com/projects/ceph-qa-suite/wiki/">ceph-qa-suite wiki</a>.</p>
<p>Since this is a new feature, many yaml files have yet to be annotated.
Developers are encouraged to improve the documentation, in terms of both
coverage and quality.</p>
</div>
<div class="section" id="id46">
<h4>集成测试是如何运作的<a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h4>
<p>Given that - as a new Ceph developer - you will typically not have access
to the <a class="reference external" href="http://ceph.github.io/sepia/">Sepia lab</a>, you may rightly ask how you can run the integration
tests in your own environment.</p>
<p>One option is to set up a teuthology cluster on bare metal. Though this is
a non-trivial task, it <cite>is</cite> possible. Here are <a class="reference external" href="http://docs.ceph.com/teuthology/docs/LAB_SETUP.html">some notes</a> to get you started
if you decide to go this route.</p>
<p>If you have access to an OpenStack tenant, you have another option: the
<a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a> has an OpenStack backend, which is documented <a class="reference external" href="https://github.com/dachary/teuthology/tree/openstack#openstack-backend">here</a>.
This OpenStack backend can build packages from a given git commit or
branch, provision VMs, install the packages and run integration tests
on those VMs. This process is controlled using a tool called
<a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a>. This tool also automates publishing of
test results at <a class="reference external" href="http://teuthology-logs.public.ceph.com">http://teuthology-logs.public.ceph.com</a>.</p>
<p>Running integration tests on your code contributions and publishing the
results allows reviewers to verify that changes to the code base do not
cause regressions, or to analyze test failures when they do occur.</p>
<p>Every teuthology cluster, whether bare-metal or cloud-provisioned, has a
so-called “teuthology machine” from which tests suites are triggered using the
<code class="docutils literal notranslate"><span class="pre">teuthology-suite</span></code> command.</p>
<p>A detailed and up-to-date description of each <a class="reference external" href="http://docs.ceph.com/teuthology/docs/teuthology.suite.html">teuthology-suite</a> option is
available by running the following command on the teuthology machine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite --help
</pre></div>
</div>
</div>
<div class="section" id="how-integration-tests-are-defined">
<span id="id47"></span><h4>如何定义集成测试<a class="headerlink" href="#how-integration-tests-are-defined" title="Permalink to this headline">¶</a></h4>
<p>Integration tests are defined by yaml files found in the <code class="docutils literal notranslate"><span class="pre">suites</span></code>
subdirectory of the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/">ceph/qa sub-directory</a> and implemented by python
code found in the <code class="docutils literal notranslate"><span class="pre">tasks</span></code> subdirectory. Some tests (“standalone tests”)
are defined in a single yaml file, while other tests are defined by a
directory tree containing yaml files that are combined, at runtime, into a
larger yaml file.</p>
</div>
<div class="section" id="reading-a-standalone-test">
<h4>Reading a standalone test<a class="headerlink" href="#reading-a-standalone-test" title="Permalink to this headline">¶</a></h4>
<p>Let us first examine a standalone test, or “singleton”.</p>
<p>Here is a commented example using the integration test
<a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/suites/rados/singleton/all/admin-socket.yaml">rados/singleton/all/admin-socket.yaml</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">roles</span><span class="p">:</span>
<span class="o">-</span> <span class="o">-</span> <span class="n">mon</span><span class="o">.</span><span class="n">a</span>
  <span class="o">-</span> <span class="n">osd</span><span class="o">.</span><span class="mi">0</span>
  <span class="o">-</span> <span class="n">osd</span><span class="o">.</span><span class="mi">1</span>
<span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">install</span><span class="p">:</span>
<span class="o">-</span> <span class="n">ceph</span><span class="p">:</span>
<span class="o">-</span> <span class="n">admin_socket</span><span class="p">:</span>
    <span class="n">osd</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span>
      <span class="n">version</span><span class="p">:</span>
      <span class="n">git_version</span><span class="p">:</span>
      <span class="n">help</span><span class="p">:</span>
      <span class="n">config</span> <span class="n">show</span><span class="p">:</span>
      <span class="n">config</span> <span class="nb">set</span> <span class="n">filestore_dump_file</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">foo</span><span class="p">:</span>
      <span class="n">perf</span> <span class="n">dump</span><span class="p">:</span>
      <span class="n">perf</span> <span class="n">schema</span><span class="p">:</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">roles</span></code> array determines the composition of the cluster (how
many MONs, OSDs, etc.) on which this test is designed to run, as well
as how these roles will be distributed over the machines in the
testing cluster. In this case, there is only one element in the
top-level array: therefore, only one machine is allocated to the
test. The nested array declares that this machine shall run a MON with
id <code class="docutils literal notranslate"><span class="pre">a</span></code> (that is the <code class="docutils literal notranslate"><span class="pre">mon.a</span></code> in the list of roles) and two OSDs
(<code class="docutils literal notranslate"><span class="pre">osd.0</span></code> and <code class="docutils literal notranslate"><span class="pre">osd.1</span></code>).</p>
<p>The body of the test is in the <code class="docutils literal notranslate"><span class="pre">tasks</span></code> array: each element is
evaluated in order, causing the corresponding python file found in the
<code class="docutils literal notranslate"><span class="pre">tasks</span></code> subdirectory of the <a class="reference external" href="https://github.com/ceph/teuthology">teuthology repository</a> or
<a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/">ceph/qa sub-directory</a> to be run. “Running” in this case means calling
the <code class="docutils literal notranslate"><span class="pre">task()</span></code> function defined in that file.</p>
<p>In this case, the <a class="reference external" href="https://github.com/ceph/teuthology/blob/master/teuthology/task/install/__init__.py">install</a>
task comes first. It installs the Ceph packages on each machine (as
defined by the <code class="docutils literal notranslate"><span class="pre">roles</span></code> array). A full description of the <code class="docutils literal notranslate"><span class="pre">install</span></code>
task is <a class="reference external" href="https://github.com/ceph/teuthology/blob/master/teuthology/task/install/__init__.py">found in the python file</a>
(search for “def task”).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ceph</span></code> task, which is documented <a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/tasks/ceph.py">here</a> (again,
search for “def task”), starts OSDs and MONs (and possibly MDSs as well)
as required by the <code class="docutils literal notranslate"><span class="pre">roles</span></code> array. In this example, it will start one MON
(<code class="docutils literal notranslate"><span class="pre">mon.a</span></code>) and two OSDs (<code class="docutils literal notranslate"><span class="pre">osd.0</span></code> and <code class="docutils literal notranslate"><span class="pre">osd.1</span></code>), all on the same
machine. Control moves to the next task when the Ceph cluster reaches
<code class="docutils literal notranslate"><span class="pre">HEALTH_OK</span></code> state.</p>
<p>The next task is <code class="docutils literal notranslate"><span class="pre">admin_socket</span></code> (<a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/tasks/admin_socket.py">source code</a>).
The parameter of the <code class="docutils literal notranslate"><span class="pre">admin_socket</span></code> task (and any other task) is a
structure which is interpreted as documented in the task. In this example
the parameter is a set of commands to be sent to the admin socket of
<code class="docutils literal notranslate"><span class="pre">osd.0</span></code>. The task verifies that each of them returns on success (i.e.
exit code zero).</p>
<p>This test can be run with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite --suite rados/singleton/all/admin-socket.yaml fs/ext4.yaml
</pre></div>
</div>
</div>
<div class="section" id="test-descriptions">
<h4>Test descriptions<a class="headerlink" href="#test-descriptions" title="Permalink to this headline">¶</a></h4>
<p>Each test has a “test description”, which is similar to a directory path,
but not the same. In the case of a standalone test, like the one in
<a class="reference internal" href="#reading-a-standalone-test">Reading a standalone test</a>, the test description is identical to the
relative path (starting from the <code class="docutils literal notranslate"><span class="pre">suites/</span></code> directory of the
<a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/">ceph/qa sub-directory</a>) of the yaml file defining the test.</p>
<p>Much more commonly, tests are defined not by a single yaml file, but by a
<cite>directory tree of yaml files</cite>. At runtime, the tree is walked and all yaml
files (facets) are combined into larger yaml “programs” that define the
tests. A full listing of the yaml defining the test is included at the
beginning of every test log.</p>
<p>In these cases, the description of each test consists of the
subdirectory under <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites">suites/</a> containing the
yaml facets, followed by an expression in curly braces (<code class="docutils literal notranslate"><span class="pre">{}</span></code>) consisting of
a list of yaml facets in order of concatenation. For instance the
test description:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">deploy</span><span class="o">/</span><span class="n">basic</span><span class="o">/</span><span class="p">{</span><span class="n">distros</span><span class="o">/</span><span class="n">centos_7</span><span class="o">.</span><span class="mf">0.</span><span class="n">yaml</span> <span class="n">tasks</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="n">deploy</span><span class="o">.</span><span class="n">yaml</span><span class="p">}</span>
</pre></div>
</div>
<p>signifies the concatenation of two files:</p>
<ul class="simple">
<li><p>ceph-deploy/basic/distros/centos_7.0.yaml</p></li>
<li><p>ceph-deploy/basic/tasks/ceph-deploy.yaml</p></li>
</ul>
</div>
<div class="section" id="how-are-tests-built-from-directories">
<h4>How are tests built from directories?<a class="headerlink" href="#how-are-tests-built-from-directories" title="Permalink to this headline">¶</a></h4>
<p>As noted in the previous section, most tests are not defined in a single
yaml file, but rather as a <cite>combination</cite> of files collected from a
directory tree within the <code class="docutils literal notranslate"><span class="pre">suites/</span></code> subdirectory of the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/">ceph/qa sub-directory</a>.</p>
<p>The set of all tests defined by a given subdirectory of <code class="docutils literal notranslate"><span class="pre">suites/</span></code> is
called an “integration test suite”, or a “teuthology suite”.</p>
<p>Combination of yaml facets is controlled by special files (<code class="docutils literal notranslate"><span class="pre">%</span></code> and
<code class="docutils literal notranslate"><span class="pre">+</span></code>) that are placed within the directory tree and can be thought of as
operators.  The <code class="docutils literal notranslate"><span class="pre">%</span></code> file is the “convolution” operator and <code class="docutils literal notranslate"><span class="pre">+</span></code>
signifies concatenation.</p>
</div>
<div class="section" id="convolution-operator">
<h4>Convolution operator<a class="headerlink" href="#convolution-operator" title="Permalink to this headline">¶</a></h4>
<p>The convolution operator, implemented as an empty file called <code class="docutils literal notranslate"><span class="pre">%</span></code>, tells
teuthology to construct a test matrix from yaml facets found in
subdirectories below the directory containing the operator.</p>
<p>For example, the <a class="reference external" href="https://github.com/ceph/ceph/tree/jewel/qa/suites/ceph-deploy/">ceph-deploy suite</a> is
defined by the <code class="docutils literal notranslate"><span class="pre">suites/ceph-deploy/</span></code> tree, which consists of the files and
subdirectories in the following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">directory</span><span class="p">:</span> <span class="n">ceph</span><span class="o">-</span><span class="n">disk</span><span class="o">/</span><span class="n">basic</span>
    <span class="n">file</span><span class="p">:</span> <span class="o">%</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">distros</span>
       <span class="n">file</span><span class="p">:</span> <span class="n">centos_7</span><span class="o">.</span><span class="mf">0.</span><span class="n">yaml</span>
       <span class="n">file</span><span class="p">:</span> <span class="n">ubuntu_14</span><span class="o">.</span><span class="mf">04.</span><span class="n">yaml</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">tasks</span>
       <span class="n">file</span><span class="p">:</span> <span class="n">ceph</span><span class="o">-</span><span class="n">disk</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>This is interpreted as a 2x1 matrix consisting of two tests:</p>
<ol class="arabic simple">
<li><p>ceph-disk/basic/{distros/centos_7.0.yaml tasks/ceph-disk.yaml}</p></li>
<li><p>ceph-disk/basic/{distros/ubuntu_14.04.yaml tasks/ceph-disk.yaml}</p></li>
</ol>
<p>i.e. the concatenation of centos_7.0.yaml and ceph-deploy.yaml and
the concatenation of ubuntu_16.04.yaml and ceph-deploy.yaml, respectively.
In human terms, this means that the task found in <code class="docutils literal notranslate"><span class="pre">ceph-deploy.yaml</span></code> is
intended to run on both CentOS 7.0 and Ubuntu 16.04.</p>
<p>Without the file percent, the <code class="docutils literal notranslate"><span class="pre">ceph-deploy</span></code> tree would be interpreted as
three standalone tests:</p>
<ul class="simple">
<li><p>ceph-deploy/basic/distros/centos_7.0.yaml</p></li>
<li><p>ceph-deploy/basic/distros/ubuntu_16.04.yaml</p></li>
<li><p>ceph-deploy/basic/tasks/ceph-deploy.yaml</p></li>
</ul>
<p>(which would of course be wrong in this case).</p>
<p>Referring to the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/">ceph/qa sub-directory</a>, you will notice that the
<code class="docutils literal notranslate"><span class="pre">centos_7.0.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">ubuntu_16.04.yaml</span></code> files in the
<code class="docutils literal notranslate"><span class="pre">suites/ceph-deploy/basic/distros/</span></code> directory are implemented as symlinks.
By using symlinks instead of copying, a single file can appear in multiple
suites. This eases the maintenance of the test framework as a whole.</p>
<p>All the tests generated from the <code class="docutils literal notranslate"><span class="pre">suites/ceph-deploy/</span></code> directory tree
(also known as the “ceph-deploy suite”) can be run with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite --suite ceph-deploy
</pre></div>
</div>
<p>An individual test from the <a class="reference external" href="https://github.com/ceph/ceph/tree/jewel/qa/suites/ceph-deploy/">ceph-deploy suite</a> can be run by adding the
<code class="docutils literal notranslate"><span class="pre">--filter</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite \
    --suite ceph-deploy/basic \
    --filter &#39;ceph-deploy/basic/{distros/ubuntu_16.04.yaml tasks/ceph-deploy.yaml}&#39;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To run a standalone test like the one in <a class="reference internal" href="#reading-a-standalone-test">Reading a standalone
test</a>, <code class="docutils literal notranslate"><span class="pre">--suite</span></code> alone is sufficient. If you want to run a single
test from a suite that is defined as a directory tree, <code class="docutils literal notranslate"><span class="pre">--suite</span></code> must
be combined with <code class="docutils literal notranslate"><span class="pre">--filter</span></code>. This is because the <code class="docutils literal notranslate"><span class="pre">--suite</span></code> option
understands POSIX relative paths only.</p>
</div>
</div>
<div class="section" id="concatenation-operator">
<h4>Concatenation operator<a class="headerlink" href="#concatenation-operator" title="Permalink to this headline">¶</a></h4>
<p>For even greater flexibility in sharing yaml files between suites, the
special file plus (<code class="docutils literal notranslate"><span class="pre">+</span></code>) can be used to concatenate files within a
directory. For instance, consider the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rbd/thrash">suites/rbd/thrash</a>
tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">directory</span><span class="p">:</span> <span class="n">rbd</span><span class="o">/</span><span class="n">thrash</span>
  <span class="n">file</span><span class="p">:</span> <span class="o">%</span>
  <span class="n">directory</span><span class="p">:</span> <span class="n">clusters</span>
    <span class="n">file</span><span class="p">:</span> <span class="o">+</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">fixed</span><span class="o">-</span><span class="mf">2.</span><span class="n">yaml</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">openstack</span><span class="o">.</span><span class="n">yaml</span>
  <span class="n">directory</span><span class="p">:</span> <span class="n">workloads</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">rbd_api_tests_copy_on_read</span><span class="o">.</span><span class="n">yaml</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">rbd_api_tests</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>This creates two tests:</p>
<ul class="simple">
<li><p>rbd/thrash/{clusters/fixed-2.yaml clusters/openstack.yaml workloads/rbd_api_tests_copy_on_read.yaml}</p></li>
<li><p>rbd/thrash/{clusters/fixed-2.yaml clusters/openstack.yaml workloads/rbd_api_tests.yaml}</p></li>
</ul>
<p>Because the <code class="docutils literal notranslate"><span class="pre">clusters/</span></code> subdirectory contains the special file plus
(<code class="docutils literal notranslate"><span class="pre">+</span></code>), all the other files in that subdirectory (<code class="docutils literal notranslate"><span class="pre">fixed-2.yaml</span></code> and
<code class="docutils literal notranslate"><span class="pre">openstack.yaml</span></code> in this case) are concatenated together
and treated as a single file. Without the special file plus, they would
have been convolved with the files from the workloads directory to create
a 2x2 matrix:</p>
<ul class="simple">
<li><p>rbd/thrash/{clusters/openstack.yaml workloads/rbd_api_tests_copy_on_read.yaml}</p></li>
<li><p>rbd/thrash/{clusters/openstack.yaml workloads/rbd_api_tests.yaml}</p></li>
<li><p>rbd/thrash/{clusters/fixed-2.yaml workloads/rbd_api_tests_copy_on_read.yaml}</p></li>
<li><p>rbd/thrash/{clusters/fixed-2.yaml workloads/rbd_api_tests.yaml}</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">clusters/fixed-2.yaml</span></code> file is shared among many suites to
define the following <code class="docutils literal notranslate"><span class="pre">roles</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">roles</span><span class="p">:</span>
<span class="o">-</span> <span class="p">[</span><span class="n">mon</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">mon</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">osd</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">osd</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="n">osd</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
<span class="o">-</span> <span class="p">[</span><span class="n">mon</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">osd</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">osd</span><span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="n">osd</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">rbd/thrash</span></code> suite as defined above, consisting of two tests,
can be run with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite --suite rbd/thrash
</pre></div>
</div>
<p>A single test from the rbd/thrash suite can be run by adding the
<code class="docutils literal notranslate"><span class="pre">--filter</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ teuthology-suite \
    --suite rbd/thrash \
    --filter &#39;rbd/thrash/{clusters/fixed-2.yaml clusters/openstack.yaml workloads/rbd_api_tests_copy_on_read.yaml}&#39;
</pre></div>
</div>
</div>
<div class="section" id="filtering-tests-by-their-description">
<h4>Filtering tests by their description<a class="headerlink" href="#filtering-tests-by-their-description" title="Permalink to this headline">¶</a></h4>
<p>When a few jobs fail and need to be run again, the <code class="docutils literal notranslate"><span class="pre">--filter</span></code> option
can be used to select tests with a matching description. For instance, if the
<code class="docutils literal notranslate"><span class="pre">rados</span></code> suite fails the <a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/suites/rados/singleton/all/peer.yaml">all/peer.yaml</a> test, the following will only run the tests that contain this file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">teuthology</span><span class="o">-</span><span class="n">suite</span> <span class="o">--</span><span class="n">suite</span> <span class="n">rados</span> <span class="o">--</span><span class="nb">filter</span> <span class="nb">all</span><span class="o">/</span><span class="n">peer</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--filter-out</span></code> option does the opposite (it matches tests that do
<cite>not</cite> contain a given string), and can be combined with the <code class="docutils literal notranslate"><span class="pre">--filter</span></code>
option.</p>
<p>Both <code class="docutils literal notranslate"><span class="pre">--filter</span></code> and <code class="docutils literal notranslate"><span class="pre">--filter-out</span></code> take a comma-separated list of strings (which
means the comma character is implicitly forbidden in filenames found in the
<a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/">ceph/qa sub-directory</a>). For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">teuthology</span><span class="o">-</span><span class="n">suite</span> <span class="o">--</span><span class="n">suite</span> <span class="n">rados</span> <span class="o">--</span><span class="nb">filter</span> <span class="nb">all</span><span class="o">/</span><span class="n">peer</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="nb">all</span><span class="o">/</span><span class="n">rest</span><span class="o">-</span><span class="n">api</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>will run tests that contain either
<a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/suites/rados/singleton/all/peer.yaml">all/peer.yaml</a>
or
<a class="reference external" href="https://github.com/ceph/ceph/blob/master/qa/suites/rados/singleton/all/rest-api.yaml">all/rest-api.yaml</a></p>
<p>Each string is looked up anywhere in the test description and has to
be an exact match: they are not regular expressions.</p>
</div>
<div class="section" id="reducing-the-number-of-tests">
<h4>Reducing the number of tests<a class="headerlink" href="#reducing-the-number-of-tests" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">rados</span></code> suite generates thousands of tests out of a few hundred
files. This happens because teuthology constructs test matrices from
subdirectories wherever it encounters a file named <code class="docutils literal notranslate"><span class="pre">%</span></code>. For instance,
all tests in the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rados/basic">rados/basic suite</a>
run with different messenger types: <code class="docutils literal notranslate"><span class="pre">simple</span></code>, <code class="docutils literal notranslate"><span class="pre">async</span></code> and
<code class="docutils literal notranslate"><span class="pre">random</span></code>, because they are combined (via the special file <code class="docutils literal notranslate"><span class="pre">%</span></code>) with
the <a class="reference external" href="https://github.com/ceph/ceph/tree/master/qa/suites/rados/basic/msgr">msgr directory</a></p>
<p>All integration tests are required to be run before a Ceph release is published.
When merely verifying whether a contribution can be merged without
risking a trivial regression, it is enough to run a subset. The <code class="docutils literal notranslate"><span class="pre">--subset</span></code> option can be used to
reduce the number of tests that are triggered. For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">teuthology</span><span class="o">-</span><span class="n">suite</span> <span class="o">--</span><span class="n">suite</span> <span class="n">rados</span> <span class="o">--</span><span class="n">subset</span> <span class="mi">0</span><span class="o">/</span><span class="mi">4000</span>
</pre></div>
</div>
<p>will run as few tests as possible. The tradeoff in this case is that
not all combinations of test variations will together,
but no matter how small a ratio is provided in the <code class="docutils literal notranslate"><span class="pre">--subset</span></code>,
teuthology will still ensure that all files in the suite are in at
least one test. Understanding the actual logic that drives this
requires reading the teuthology source code.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--limit</span></code> option only runs the first <code class="docutils literal notranslate"><span class="pre">N</span></code> tests in the suite:
this is rarely useful, however, because there is no way to control which
test will be first.</p>
</div>
</div>
</div>
<div class="section" id="id49">
<h2><a class="toc-backref" href="#id91">在云端测试</a><a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h2>
<p>In this chapter, we will explain in detail how use an OpenStack
tenant as an environment for Ceph integration testing.</p>
<div class="section" id="assumptions-and-caveat">
<h3><a class="toc-backref" href="#id92">Assumptions and caveat</a><a class="headerlink" href="#assumptions-and-caveat" title="Permalink to this headline">¶</a></h3>
<p>We assume that:</p>
<ol class="arabic simple">
<li><p>you are the only person using the tenant</p></li>
<li><p>you have the credentials</p></li>
<li><p>the tenant supports the <code class="docutils literal notranslate"><span class="pre">nova</span></code> and <code class="docutils literal notranslate"><span class="pre">cinder</span></code> APIs</p></li>
</ol>
<p>Caveat: be aware that, as of this writing (July 2016), testing in
OpenStack clouds is a new feature. Things may not work as advertised.
If you run into trouble, ask for help on <a class="reference internal" href="#irc">IRC</a> or the <a class="reference internal" href="#id9">邮件列表</a>, or
open a bug report at the <a class="reference external" href="http://ceph-workbench.dachary.org/root/ceph-workbench/issues">ceph-workbench bug tracker</a>.</p>
</div>
<div class="section" id="prepare-tenant">
<h3><a class="toc-backref" href="#id93">Prepare tenant</a><a class="headerlink" href="#prepare-tenant" title="Permalink to this headline">¶</a></h3>
<p>If you have not tried to use <code class="docutils literal notranslate"><span class="pre">ceph-workbench</span></code> with this tenant before,
proceed to the next step.</p>
<p>To start with a clean slate, login to your tenant via the Horizon dashboard and:</p>
<ul class="simple">
<li><p>terminate the <code class="docutils literal notranslate"><span class="pre">teuthology</span></code> and <code class="docutils literal notranslate"><span class="pre">packages-repository</span></code> instances, if any</p></li>
<li><p>delete the <code class="docutils literal notranslate"><span class="pre">teuthology</span></code> and <code class="docutils literal notranslate"><span class="pre">teuthology-worker</span></code> security groups, if any</p></li>
<li><p>delete the <code class="docutils literal notranslate"><span class="pre">teuthology</span></code> and <code class="docutils literal notranslate"><span class="pre">teuthology-myself</span></code> key pairs, if any</p></li>
</ul>
<p>Also do the above if you ever get key-related errors (“invalid key”, etc.) when
trying to schedule suites.</p>
</div>
<div class="section" id="ceph-workbench">
<h3><a class="toc-backref" href="#id94">安装 ceph-workbench</a><a class="headerlink" href="#ceph-workbench" title="Permalink to this headline">¶</a></h3>
<p>Since testing in the cloud is done using the <a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench
ceph-qa-suite</a> tool, you will need to install that first. It is designed
to be installed via Docker, so if you don’t have Docker running on your
development machine, take care of that first. You can follow <a class="reference external" href="https://docs.docker.com/engine/installation/">the official
tutorial</a> to install if
you have not installed yet.</p>
<p>Once Docker is up and running, install <code class="docutils literal notranslate"><span class="pre">ceph-workbench</span></code> by following the
<a class="reference external" href="http://ceph-workbench.readthedocs.io/en/latest/#installation">Installation instructions in the ceph-workbench documentation</a>.</p>
</div>
<div class="section" id="linking-ceph-workbench-with-your-openstack-tenant">
<h3><a class="toc-backref" href="#id95">Linking ceph-workbench with your OpenStack tenant</a><a class="headerlink" href="#linking-ceph-workbench-with-your-openstack-tenant" title="Permalink to this headline">¶</a></h3>
<p>Before you can trigger your first teuthology suite, you will need to link
<code class="docutils literal notranslate"><span class="pre">ceph-workbench</span></code> with your OpenStack account.</p>
<p>First, download a <code class="docutils literal notranslate"><span class="pre">openrc.sh</span></code> file by clicking on the “Download OpenStack
RC File” button, which can be found in the “API Access” tab of the “Access
&amp; Security” dialog of the OpenStack Horizon dashboard.</p>
<p>Second, create a <code class="docutils literal notranslate"><span class="pre">~/.ceph-workbench</span></code> directory, set its permissions to
700, and move the <code class="docutils literal notranslate"><span class="pre">openrc.sh</span></code> file into it. Make sure that the filename
is exactly <code class="docutils literal notranslate"><span class="pre">~/.ceph-workbench/openrc.sh</span></code>.</p>
<p>Third, edit the file so it does not ask for your OpenStack password
interactively. Comment out the relevant lines and replace them with
something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">OS_PASSWORD</span><span class="o">=</span><span class="s2">&quot;aiVeth0aejee3eep8rogho3eep7Pha6ek&quot;</span>
</pre></div>
</div>
<p>When <a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a> connects to your OpenStack tenant for
the first time, it will generate two keypairs: <code class="docutils literal notranslate"><span class="pre">teuthology-myself</span></code> and
<code class="docutils literal notranslate"><span class="pre">teuthology</span></code>.</p>
</div>
<div class="section" id="run-the-dummy-suite">
<h3><a class="toc-backref" href="#id96">Run the dummy suite</a><a class="headerlink" href="#run-the-dummy-suite" title="Permalink to this headline">¶</a></h3>
<p>You are now ready to take your OpenStack teuthology setup for a test
drive:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph-workbench ceph-qa-suite --suite dummy
</pre></div>
</div>
<p>Be forewarned that the first run of <a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a> on a
pristine tenant will take a long time to complete because it downloads a VM
image and during this time the command may not produce any output.</p>
<p>The images are cached in OpenStack, so they are only downloaded once.
Subsequent runs of the same command will complete faster.</p>
<p>Although <code class="docutils literal notranslate"><span class="pre">dummy</span></code> suite does not run any tests, in all other respects it
behaves just like a teuthology suite and produces some of the same
artifacts.</p>
<p>The last bit of output should look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pulpito</span> <span class="n">web</span> <span class="n">interface</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">149.202</span><span class="o">.</span><span class="mf">168.201</span><span class="p">:</span><span class="mi">8081</span><span class="o">/</span>
<span class="n">ssh</span> <span class="n">access</span>           <span class="p">:</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">smithfarm</span><span class="o">/.</span><span class="n">ceph</span><span class="o">-</span><span class="n">workbench</span><span class="o">/</span><span class="n">teuthology</span><span class="o">-</span><span class="n">myself</span><span class="o">.</span><span class="n">pem</span> <span class="n">ubuntu</span><span class="nd">@149</span><span class="o">.</span><span class="mf">202.168</span><span class="o">.</span><span class="mi">201</span> <span class="c1"># logs in /usr/share/nginx/html</span>
</pre></div>
</div>
<p>What this means is that <a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a> triggered the test
suite run. It does not mean that the suite run has completed. To monitor
progress of the run, check the Pulpito web interface URL periodically, or
if you are impatient, ssh to the teuthology machine using the ssh command
shown and do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tail -f /var/log/teuthology.*
</pre></div>
</div>
<p>The <cite>/usr/share/nginx/html</cite> directory contains the complete logs of the
test suite. If we had provided the <code class="docutils literal notranslate"><span class="pre">--upload</span></code> option to the
<a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a> command, these logs would have been
uploaded to <a class="reference external" href="http://teuthology-logs.public.ceph.com">http://teuthology-logs.public.ceph.com</a>.</p>
</div>
<div class="section" id="run-a-standalone-test">
<h3><a class="toc-backref" href="#id97">Run a standalone test</a><a class="headerlink" href="#run-a-standalone-test" title="Permalink to this headline">¶</a></h3>
<p>The standalone test explained in <a class="reference internal" href="#reading-a-standalone-test">Reading a standalone test</a> can be run
with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph-workbench ceph-qa-suite --suite rados/singleton/all/admin-socket.yaml
</pre></div>
</div>
<p>This will run the suite shown on the current <code class="docutils literal notranslate"><span class="pre">master</span></code> branch of
<code class="docutils literal notranslate"><span class="pre">ceph/ceph.git</span></code>. You can specify a different branch with the <code class="docutils literal notranslate"><span class="pre">--ceph</span></code>
option, and even a different git repo with the <code class="docutils literal notranslate"><span class="pre">--ceph-git-url</span></code> option. (Run
<code class="docutils literal notranslate"><span class="pre">ceph-workbench</span> <span class="pre">ceph-qa-suite</span> <span class="pre">--help</span></code> for an up-to-date list of available
options.)</p>
<p>The first run of a suite will also take a long time, because ceph packages
have to be built, first. Again, the packages so built are cached and
<a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a> will not build identical packages a second
time.</p>
</div>
<div class="section" id="interrupt-a-running-suite">
<h3><a class="toc-backref" href="#id98">Interrupt a running suite</a><a class="headerlink" href="#interrupt-a-running-suite" title="Permalink to this headline">¶</a></h3>
<p>Teuthology suites take time to run. From time to time one may wish to
interrupt a running suite. One obvious way to do this is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">workbench</span> <span class="n">ceph</span><span class="o">-</span><span class="n">qa</span><span class="o">-</span><span class="n">suite</span> <span class="o">--</span><span class="n">teardown</span>
</pre></div>
</div>
<p>This destroys all VMs created by <a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a> and
returns the OpenStack tenant to a “clean slate”.</p>
<p>Sometimes you may wish to interrupt the running suite, but keep the logs,
the teuthology VM, the packages-repository VM, etc. To do this, you can
<code class="docutils literal notranslate"><span class="pre">ssh</span></code> to the teuthology VM (using the <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">access</span></code> command reported
when you triggered the suite – see <a class="reference internal" href="#run-the-dummy-suite">Run the dummy suite</a>) and, once
there:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">teuthology</span> <span class="n">restart</span>
</pre></div>
</div>
<p>This will keep the teuthology machine, the logs and the packages-repository
instance but nuke everything else.</p>
</div>
<div class="section" id="upload-logs-to-archive-server">
<h3><a class="toc-backref" href="#id99">Upload logs to archive server</a><a class="headerlink" href="#upload-logs-to-archive-server" title="Permalink to this headline">¶</a></h3>
<p>Since the teuthology instance in OpenStack is only semi-permanent, with limited
space for storing logs, <code class="docutils literal notranslate"><span class="pre">teuthology-openstack</span></code> provides an <code class="docutils literal notranslate"><span class="pre">--upload</span></code>
option which, if included in the <code class="docutils literal notranslate"><span class="pre">ceph-workbench</span> <span class="pre">ceph-qa-suite</span></code> command,
will cause logs from all failed jobs to be uploaded to the log archive server
maintained by the Ceph project. The logs will appear at the URL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://teuthology-logs.public.ceph.com/$RUN
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">$RUN</span></code> is the name of the run. It will be a string like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ubuntu</span><span class="o">-</span><span class="mi">2016</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23_16</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">12</span><span class="o">-</span><span class="n">rados</span><span class="o">-</span><span class="n">hammer</span><span class="o">-</span><span class="n">backports</span><span class="o">---</span><span class="n">basic</span><span class="o">-</span><span class="n">openstack</span>
</pre></div>
</div>
<p>Even if you don’t providing the <code class="docutils literal notranslate"><span class="pre">--upload</span></code> option, however, all the logs can
still be found on the teuthology machine in the directory
<code class="docutils literal notranslate"><span class="pre">/usr/share/nginx/html</span></code>.</p>
</div>
<div class="section" id="provision-vms-ad-hoc">
<h3><a class="toc-backref" href="#id100">Provision VMs ad hoc</a><a class="headerlink" href="#provision-vms-ad-hoc" title="Permalink to this headline">¶</a></h3>
<p>From the teuthology VM, it is possible to provision machines on an “ad hoc”
basis, to use however you like. The magic incantation is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>teuthology-lock --lock-many $NUMBER_OF_MACHINES \
    --os-type $OPERATING_SYSTEM \
    --os-version $OS_VERSION \
    --machine-type openstack \
    --owner $EMAIL_ADDRESS
</pre></div>
</div>
<p>The command must be issued from the <code class="docutils literal notranslate"><span class="pre">~/teuthology</span></code> directory. The possible
values for <code class="docutils literal notranslate"><span class="pre">OPERATING_SYSTEM</span></code> AND <code class="docutils literal notranslate"><span class="pre">OS_VERSION</span></code> can be found by examining
the contents of the directory <code class="docutils literal notranslate"><span class="pre">teuthology/openstack/</span></code>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">teuthology</span><span class="o">-</span><span class="n">lock</span> <span class="o">--</span><span class="n">lock</span><span class="o">-</span><span class="n">many</span> <span class="mi">1</span> <span class="o">--</span><span class="n">os</span><span class="o">-</span><span class="nb">type</span> <span class="n">ubuntu</span> <span class="o">--</span><span class="n">os</span><span class="o">-</span><span class="n">version</span> <span class="mf">16.04</span> \
    <span class="o">--</span><span class="n">machine</span><span class="o">-</span><span class="nb">type</span> <span class="n">openstack</span> <span class="o">--</span><span class="n">owner</span> <span class="n">foo</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>When you are finished with the machine, find it in the list of machines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">server</span> <span class="nb">list</span>
</pre></div>
</div>
<p>to determine the name or ID, and then terminate it with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>openstack server delete $NAME_OR_ID
</pre></div>
</div>
</div>
<div class="section" id="deploy-a-cluster-for-manual-testing">
<span id="id50"></span><h3><a class="toc-backref" href="#id101">部署用于手动测试的集群</a><a class="headerlink" href="#deploy-a-cluster-for-manual-testing" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://github.com/ceph/teuthology">teuthology framework</a> and <a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a> are
versatile tools that automatically provision Ceph clusters in the cloud and
run various tests on them in an automated fashion. This enables a single
engineer, in a matter of hours, to perform thousands of tests that would
keep dozens of human testers occupied for days or weeks if conducted
manually.</p>
<p>However, there are times when the automated tests do not cover a particular
scenario and manual testing is desired. It turns out that it is simple to
adapt a test to stop and wait after the Ceph installation phase, and the
engineer can then ssh into the running cluster. Simply add the following
snippet in the desired place within the test YAML and schedule a run with the
test:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">exec</span><span class="p">:</span>
    <span class="n">client</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">sleep</span> <span class="mi">1000000000</span> <span class="c1"># forever</span>
</pre></div>
</div>
<p>(Make sure you have a <code class="docutils literal notranslate"><span class="pre">client.0</span></code> defined in your <code class="docutils literal notranslate"><span class="pre">roles</span></code> stanza or adapt
accordingly.)</p>
<p>The same effect can be achieved using the <code class="docutils literal notranslate"><span class="pre">interactive</span></code> task:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">interactive</span>
</pre></div>
</div>
<p>By following the test log, you can determine when the test cluster has entered
the “sleep forever” condition. At that point, you can ssh to the teuthology
machine and from there to one of the target VMs (OpenStack) or teuthology
worker machines machine (Sepia) where the test cluster is running.</p>
<p>The VMs (or “instances” in OpenStack terminology) created by
<a class="reference external" href="http://ceph-workbench.readthedocs.org/">ceph-workbench ceph-qa-suite</a> are named as follows:</p>
<p><code class="docutils literal notranslate"><span class="pre">teuthology</span></code> - the teuthology machine</p>
<p><code class="docutils literal notranslate"><span class="pre">packages-repository</span></code> - VM where packages are stored</p>
<p><code class="docutils literal notranslate"><span class="pre">ceph-*</span></code> - VM where packages are built</p>
<p><code class="docutils literal notranslate"><span class="pre">target*</span></code> - machines where tests are run</p>
<p>The VMs named <code class="docutils literal notranslate"><span class="pre">target*</span></code> are used by tests. If you are monitoring the
teuthology log for a given test, the hostnames of these target machines can
be found out by searching for the string <code class="docutils literal notranslate"><span class="pre">Locked</span> <span class="pre">targets</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">20</span><span class="n">T11</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mf">06.166</span> <span class="n">INFO</span><span class="p">:</span><span class="n">teuthology</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">internal</span><span class="p">:</span><span class="n">Locked</span> <span class="n">targets</span><span class="p">:</span>
  <span class="n">target149202171058</span><span class="o">.</span><span class="n">teuthology</span><span class="p">:</span> <span class="n">null</span>
  <span class="n">target149202171059</span><span class="o">.</span><span class="n">teuthology</span><span class="p">:</span> <span class="n">null</span>
</pre></div>
</div>
<p>The IP addresses of the target machines can be found by running <code class="docutils literal notranslate"><span class="pre">openstack</span>
<span class="pre">server</span> <span class="pre">list</span></code> on the teuthology machine, but the target VM hostnames (e.g.
<code class="docutils literal notranslate"><span class="pre">target149202171058.teuthology</span></code>) are resolvable within the teuthology
cluster.</p>
</div>
</div>
<div class="section" id="s3">
<span id="testing-how-to-run-s3-tests-locally"></span><h2><a class="toc-backref" href="#id102">测试——如何在本地测试 S3</a><a class="headerlink" href="#s3" title="Permalink to this headline">¶</a></h2>
<p>RGW code can be tested by building Ceph locally from source, starting a vstart
cluster, and running the “s3-tests” suite against it.</p>
<p>The following instructions should work on jewel and above.</p>
<div class="section" id="step-1-build-ceph">
<span id="id51"></span><h3><a class="toc-backref" href="#id103">第一步：构建 Ceph</a><a class="headerlink" href="#step-1-build-ceph" title="Permalink to this headline">¶</a></h3>
<p>细节见 <a class="reference internal" href="../../install/build-ceph/"><span class="doc">构建 Ceph</span></a> 。</p>
<p>构建时间较长，你可以先单独试试第二步。</p>
</div>
<div class="section" id="vstart">
<span id="step-2-vstart"></span><h3><a class="toc-backref" href="#id104">第二步： vstart</a><a class="headerlink" href="#vstart" title="Permalink to this headline">¶</a></h3>
<p>构建结束后，还是在构建时的 git 克隆库顶极目录下，执行这些，用 cmake 构建的话：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">build</span><span class="o">/</span>
<span class="n">RGW</span><span class="o">=</span><span class="mi">1</span> <span class="o">../</span><span class="n">src</span><span class="o">/</span><span class="n">vstart</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">n</span>
</pre></div>
</div>
<p>This will produce a lot of output as the vstart cluster is started up. At the
end you should see a message like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">started</span><span class="o">.</span>  <span class="n">stop</span><span class="o">.</span><span class="n">sh</span> <span class="n">to</span> <span class="n">stop</span><span class="o">.</span>  <span class="n">see</span> <span class="n">out</span><span class="o">/*</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="s1">&#39;tail -f out/????&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">debug</span> <span class="n">output</span><span class="o">.</span>
</pre></div>
</div>
<p>This means the cluster is running.</p>
</div>
<div class="section" id="s3-tests">
<span id="step-3-run-s3-tests"></span><h3><a class="toc-backref" href="#id105">第三步：运行 s3-tests</a><a class="headerlink" href="#s3-tests" title="Permalink to this headline">¶</a></h3>
<p>用下列命令运行 s3tests 测试套件：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ../qa/workunits/rgw/run-s3tests.sh
</pre></div>
</div>
</div>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">开发者指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">必备知识</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#leads">项目领导</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">历史</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">软件许可</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">源代码仓库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#redmine">Redmine 问题跟踪器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">邮件列表</a></li>
<li class="toctree-l3"><a class="reference internal" href="#irc">IRC</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">补丁的提交</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">从源码构建</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ccache">用 ccache 加速本地构建</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">开发模式的集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backporting">补丁移植（ Backporting ）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#guidance-for-use-of-cluster-log">Guidance for use of cluster log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#what-is-merged-where-and-when">What is merged where and when ?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#x-0-z">开发版（即 x.0.z ）</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what">What ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#where">Where ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#when">When ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#branch-merges">Branch merges</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#x-1-z">稳定版候选（即 x.1.z ）阶段一</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id15">What ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">Where ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">When ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">Branch merges</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id19">稳定版候选（即 x.1.z ）阶段二</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id20">What ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">Where ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">When ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id23">Branch merges</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#x-2-z">稳定版（即 x.2.z ）</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id24">What ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">Where ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id26">When ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">分支合并</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id28">问题跟踪</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id29">问题跟踪器惯例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id30">基本工作流</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id31">更新追踪器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id32">上游源码</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id33">本地环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id34">缺陷修订分支</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id35">在本地修正缺陷</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id36">GitHub 拉取请求</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pr">全自动的 PR 校验</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pr-make-check">PR make check 测试注意事项</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ceph-qa-suite">集成测试（也就是 ceph-qa-suite ）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id38">源码审核</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id39">修订你的 PR</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id40">合并</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id41">测试</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#make-check">单元测试 - make check</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id43">如何声明单元测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cli">CLI 工具的单元测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id44">注意事项</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id45">测试 - 集成测试</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#teuthology-consumes-packages">Teuthology consumes packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-nightlies">The nightlies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#suites-inventory">Suites inventory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#teuthology-describe-tests">teuthology-describe-tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id46">集成测试是如何运作的</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-integration-tests-are-defined">如何定义集成测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reading-a-standalone-test">Reading a standalone test</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-descriptions">Test descriptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-are-tests-built-from-directories">How are tests built from directories?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#convolution-operator">Convolution operator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#concatenation-operator">Concatenation operator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#filtering-tests-by-their-description">Filtering tests by their description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reducing-the-number-of-tests">Reducing the number of tests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id49">在云端测试</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#assumptions-and-caveat">Assumptions and caveat</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prepare-tenant">Prepare tenant</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ceph-workbench">安装 ceph-workbench</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linking-ceph-workbench-with-your-openstack-tenant">Linking ceph-workbench with your OpenStack tenant</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-dummy-suite">Run the dummy suite</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-a-standalone-test">Run a standalone test</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interrupt-a-running-suite">Interrupt a running suite</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upload-logs-to-archive-server">Upload logs to archive server</a></li>
<li class="toctree-l3"><a class="reference internal" href="#provision-vms-ad-hoc">Provision VMs ad hoc</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploy-a-cluster-for-manual-testing">部署用于手动测试的集群</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#s3">测试——如何在本地测试 S3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1-build-ceph">第一步：构建 Ceph</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vstart">第二步： vstart</a></li>
<li class="toctree-l3"><a class="reference internal" href="#s3-tests">第三步：运行 s3-tests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../internals/" title="Ceph 内幕"
             >next</a> |</li>
        <li class="right" >
          <a href="../../architecture/" title="体系结构"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>